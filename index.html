<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эволюционный Тамагочи</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .screen {
            display: none;
        }
        .active {
            display: block;
        }
        .pet-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .pet {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            width: 150px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .pet-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .pet-stats {
            font-size: 14px;
            margin: 5px 0;
        }
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 5px 0;
        }
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #4CAF50;
        }
        .hunger {
            background-color: #FF9800;
        }
        .energy {
            background-color: #2196F3;
        }
        .happiness {
            background-color: #9C27B0;
        }
        .level {
            background-color: #607D8B;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }
        .action-buttons button {
            padding: 5px 8px;
            font-size: 14px;
        }
        .log {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .evolution-info {
            margin: 15px 0;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
            border-left: 4px solid #2e7d32;
        }
        h1, h2, h3 {
            color: #2e7d32;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu" class="screen active">
            <h1>Эволюционный Тамагочи</h1>
            <div class="menu">
                <button id="new-game-btn">Новая игра</button>
                <button id="continue-game-btn">Продолжить</button>
                <button id="how-to-play-btn">Как играть</button>
            </div>
        </div>

        <!-- Экран обучения -->
        <div id="how-to-play" class="screen">
            <h2>Как играть</h2>
            <p>Ваш питомец проходит несколько стадий эволюции. Ухаживайте за ним, чтобы он рос и развивался.</p>
            <p><strong>Основные параметры:</strong></p>
            <ul>
                <li><strong>Голод</strong> - кормите питомца</li>
                <li><strong>Энергия</strong> - давайте питомцу отдыхать</li>
                <li><strong>Счастье</strong> - играйте с питомцем</li>
            </ul>
            <p>Когда питомец достигает максимального уровня, он делится на два новых существа. Продолжайте ухаживать за колонией!</p>
            <button id="back-to-menu-btn">Вернуться в меню</button>
        </div>

        <!-- Игровой экран -->
        <div id="game-screen" class="screen">
            <h2 id="game-title">Ваши питомцы</h2>
            <div class="evolution-info" id="evolution-info">
                Текущая стадия эволюции: <span id="current-stage">Простая клетка</span>
                <div>Всего питомцев: <span id="total-pets">1</span></div>
                <div>Максимальный уровень: <span id="max-level">1</span></div>
            </div>
            <div class="pet-container" id="pet-container">
                <!-- Здесь будут отображаться питомцы -->
            </div>
            <div class="log" id="game-log">
                <!-- Лог событий -->
            </div>
            <button id="menu-from-game-btn">В меню</button>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Состояние игры
        const gameState = {
            pets: [],
            gameStarted: false,
            evolutionStage: 0,
            lastPetId: 0,
            logs: []
        };

        // Стадии эволюции
        const evolutionStages = [
            { name: "Простая клетка", maxLevel: 3, divisionCount: 2 },
            { name: "Многоклеточный организм", maxLevel: 5, divisionCount: 3 },
            { name: "Сложный организм", maxLevel: 7, divisionCount: 4 },
            { name: "Разумное существо", maxLevel: 10, divisionCount: 5 }
        ];

        // Элементы интерфейса
        const screens = {
            mainMenu: document.getElementById('main-menu'),
            howToPlay: document.getElementById('how-to-play'),
            gameScreen: document.getElementById('game-screen')
        };

        const buttons = {
            newGame: document.getElementById('new-game-btn'),
            continueGame: document.getElementById('continue-game-btn'),
            howToPlay: document.getElementById('how-to-play-btn'),
            backToMenu: document.getElementById('back-to-menu-btn'),
            menuFromGame: document.getElementById('menu-from-game-btn')
        };

        // Инициализация игры
        function initGame() {
            loadGame();
            setupEventListeners();
            updateContinueButton();
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            buttons.newGame.addEventListener('click', startNewGame);
            buttons.continueGame.addEventListener('click', continueGame);
            buttons.howToPlay.addEventListener('click', showHowToPlay);
            buttons.backToMenu.addEventListener('click', showMainMenu);
            buttons.menuFromGame.addEventListener('click', showMainMenu);
        }

        // Обновление кнопки продолжения игры
        function updateContinueButton() {
            buttons.continueGame.disabled = !gameState.gameStarted;
        }

        // Переключение экранов
        function showScreen(screen) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function showMainMenu() {
            showScreen(screens.mainMenu);
        }

        function showHowToPlay() {
            showScreen(screens.howToPlay);
        }

        function showGameScreen() {
            showScreen(screens.gameScreen);
            renderGame();
        }

        // Новая игра
        function startNewGame() {
            gameState.pets = [createPet("Клетка")];
            gameState.gameStarted = true;
            gameState.evolutionStage = 0;
            gameState.lastPetId = 1;
            gameState.logs = [];
            
            addLog("Игра началась! У вас появилась простая клетка.");
            saveGame();
            updateContinueButton();
            showGameScreen();
        }

        // Продолжить игру
        function continueGame() {
            if (gameState.gameStarted) {
                showGameScreen();
            }
        }

        // Создание нового питомца
        function createPet(name, level = 1) {
            return {
                id: ++gameState.lastPetId,
                name: name,
                level: level,
                hunger: 100,
                energy: 100,
                happiness: 100,
                xp: 0,
                lastActionTime: Date.now()
            };
        }

        // Обновление состояния питомцев
        function updatePets() {
            const now = Date.now();
            const timePassed = now - (gameState.lastUpdateTime || now);
            gameState.lastUpdateTime = now;

            gameState.pets.forEach(pet => {
                // Уменьшение параметров со временем
                const hoursPassed = timePassed / (1000 * 60 * 2); // 2 минуты реального времени = 1 час игрового

                pet.hunger = Math.max(0, pet.hunger - 5 * hoursPassed);
                pet.energy = Math.max(0, pet.energy - 3 * hoursPassed);
                pet.happiness = Math.max(0, pet.happiness - 2 * hoursPassed);

                // Добавление XP, если все параметры в норме
                if (pet.hunger > 50 && pet.energy > 50 && pet.happiness > 50) {
                    pet.xp += hoursPassed;
                }

                // Проверка уровня
                const xpNeeded = pet.level * 20;
                if (pet.xp >= xpNeeded && pet.level < evolutionStages[gameState.evolutionStage].maxLevel) {
                    pet.xp -= xpNeeded;
                    pet.level++;
                    addLog(`${pet.name} достиг уровня ${pet.level}!`);
                    
                    // Проверка на деление
                    if (pet.level === evolutionStages[gameState.evolutionStage].maxLevel) {
                        dividePet(pet);
                    }
                }
            });

            // Проверка на смерть питомцев
            gameState.pets = gameState.pets.filter(pet => {
                if (pet.hunger <= 0 || pet.energy <= 0 || pet.happiness <= 0) {
                    addLog(`${pet.name} погиб...`);
                    return false;
                }
                return true;
            });

            // Проверка на переход на следующую стадию эволюции
            if (gameState.pets.length >= 5 && gameState.evolutionStage < evolutionStages.length - 1) {
                gameState.evolutionStage++;
                gameState.pets.forEach(pet => {
                    pet.level = 1;
                    pet.xp = 0;
                });
                addLog(`Ваши питомцы эволюционировали в ${evolutionStages[gameState.evolutionStage].name}!`);
            }

            // Если все питомцы погибли
            if (gameState.pets.length === 0) {
                addLog("Все ваши питомцы погибли. Игра окончена.");
                gameState.gameStarted = false;
                updateContinueButton();
                showMainMenu();
            }

            saveGame();
        }

        // Деление питомца
        function dividePet(pet) {
            const divisionCount = evolutionStages[gameState.evolutionStage].divisionCount;
            const newPets = [];
            
            for (let i = 0; i < divisionCount; i++) {
                const newPet = createPet(`${pet.name}-${i+1}`, 1);
                newPets.push(newPet);
            }
            
            gameState.pets = gameState.pets.filter(p => p.id !== pet.id);
            gameState.pets.push(...newPets);
            
            addLog(`${pet.name} разделился на ${divisionCount} новых существ!`);
        }

        // Действия с питомцем
        function feedPet(petId) {
            const pet = gameState.pets.find(p => p.id === petId);
            if (pet) {
                pet.hunger = Math.min(100, pet.hunger + 30);
                pet.energy = Math.max(0, pet.energy - 5);
                addLog(`${pet.name} покормлен.`);
                saveGame();
                renderGame();
            }
        }

        function restPet(petId) {
            const pet = gameState.pets.find(p => p.id === petId);
            if (pet) {
                pet.energy = Math.min(100, pet.energy + 30);
                pet.happiness = Math.max(0, pet.happiness - 5);
                addLog(`${pet.name} отдохнул.`);
                saveGame();
                renderGame();
            }
        }

        function playWithPet(petId) {
            const pet = gameState.pets.find(p => p.id === petId);
            if (pet) {
                pet.happiness = Math.min(100, pet.happiness + 30);
                pet.hunger = Math.max(0, pet.hunger - 10);
                pet.energy = Math.max(0, pet.energy - 10);
                addLog(`Вы поиграли с ${pet.name}.`);
                saveGame();
                renderGame();
            }
        }

        // Добавление записи в лог
        function addLog(message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            gameState.logs.unshift({ time: timeString, message: message });
            if (gameState.logs.length > 20) {
                gameState.logs.pop();
            }
        }

        // Рендер игры
        function renderGame() {
            updatePets();
            
            const petContainer = document.getElementById('pet-container');
            petContainer.innerHTML = '';
            
            gameState.pets.forEach(pet => {
                const petElement = document.createElement('div');
                petElement.className = 'pet';
                
                petElement.innerHTML = `
                    <div class="pet-name">${pet.name}</div>
                    <div class="pet-stats">Уровень: ${pet.level}</div>
                    <div class="pet-stats">Голод:</div>
                    <div class="progress-container">
                        <div class="progress-bar hunger" style="width: ${pet.hunger}%"></div>
                    </div>
                    <div class="pet-stats">Энергия:</div>
                    <div class="progress-container">
                        <div class="progress-bar energy" style="width: ${pet.energy}%"></div>
                    </div>
                    <div class="pet-stats">Счастье:</div>
                    <div class="progress-container">
                        <div class="progress-bar happiness" style="width: ${pet.happiness}%"></div>
                    </div>
                    <div class="pet-stats">Опыт:</div>
                    <div class="progress-container">
                        <div class="progress-bar level" style="width: ${(pet.xp / (pet.level * 20)) * 100}%"></div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="feedPet(${pet.id})">Кормить</button>
                        <button onclick="restPet(${pet.id})">Отдых</button>
                        <button onclick="playWithPet(${pet.id})">Играть</button>
                    </div>
                `;
                
                petContainer.appendChild(petElement);
            });
            
            // Обновление информации об эволюции
            document.getElementById('current-stage').textContent = evolutionStages[gameState.evolutionStage].name;
            document.getElementById('total-pets').textContent = gameState.pets.length;
            document.getElementById('max-level').textContent = evolutionStages[gameState.evolutionStage].maxLevel;
            
            // Рендер лога
            const logElement = document.getElementById('game-log');
            logElement.innerHTML = gameState.logs.map(log => 
                `<div class="log-entry"><strong>[${log.time}]</strong> ${log.message}</div>`
            ).join('');
        }

        // Сохранение игры
        function saveGame() {
            if (gameState.gameStarted) {
                localStorage.setItem('evolutionTamagotchi', JSON.stringify(gameState));
            }
        }

        // Загрузка игры
        function loadGame() {
            const savedGame = localStorage.getItem('evolutionTamagotchi');
            if (savedGame) {
                Object.assign(gameState, JSON.parse(savedGame));
            }
        }

        // Глобальные функции для вызова из HTML
        window.feedPet = feedPet;
        window.restPet = restPet;
        window.playWithPet = playWithPet;

        // Запуск игры
        initGame();
    </script>
</body>
</html>