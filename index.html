<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эволюционный Тамагочи</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #pet-count {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        #pet-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .pet {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            position: relative;
            margin: 20px;
            transition: all 0.3s;
        }
        
        .pet::before {
            content: "";
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: white;
            border-radius: 50%;
            top: 20px;
            left: 20px;
        }
        
        .pet::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #333;
            border-radius: 50%;
            top: 30px;
            left: 30px;
        }
        
        .stats {
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }
        
        .stat {
            margin-bottom: 5px;
        }
        
        .stat-label {
            display: inline-block;
            width: 70px;
        }
        
        .progress-container {
            display: inline-block;
            width: calc(100% - 80px);
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        
        #actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            background-color: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #evolution-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        
        .evolution-pet {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 10px;
            display: inline-block;
        }
        
        #menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .menu-button {
            margin: 10px;
            padding: 15px 30px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="menu-screen">
        <h1>Эволюционный Тамагочи</h1>
        <button id="new-game-btn" class="menu-button">Новая игра</button>
        <button id="continue-btn" class="menu-button">Продолжить</button>
    </div>
    
    <div id="pet-count">Питомцев: 0</div>
    
    <div id="pet-container">
        <div class="pet" id="current-pet" style="background-color: #FF5733;"></div>
        
        <div class="stats">
            <div class="stat">
                <span class="stat-label">Уровень:</span>
                <span id="level">1</span>
            </div>
            <div class="stat">
                <span class="stat-label">Опыт:</span>
                <div class="progress-container">
                    <div id="exp-bar" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat">
                <span class="stat-label">Здоровье:</span>
                <div class="progress-container">
                    <div id="health-bar" class="progress-bar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat">
                <span class="stat-label">Голод:</span>
                <div class="progress-container">
                    <div id="hunger-bar" class="progress-bar" style="width: 50%"></div>
                </div>
            </div>
            <div class="stat">
                <span class="stat-label">Энергия:</span>
                <div class="progress-container">
                    <div id="energy-bar" class="progress-bar" style="width: 80%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="actions">
        <button id="feed-btn">Покормить</button>
        <button id="play-btn">Поиграть</button>
        <button id="sleep-btn">Отдых</button>
        <button id="heal-btn">Лечить</button>
        <button id="train-btn">Тренировать</button>
    </div>
    
    <div id="evolution-screen">
        <h2>Эволюция!</h2>
        <div>
            <div id="old-pet" class="evolution-pet" style="background-color: #FF5733;"></div>
            <span style="font-size: 24px;">→</span>
            <div id="new-pet" class="evolution-pet" style="background-color: #33FF57;"></div>
        </div>
        <p>Ваш питомец эволюционировал!</p>
        <button id="evolution-ok-btn">OK</button>
    </div>

    <script>
        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Состояние игры
        let gameState = {
            pets: [],
            currentPetIndex: 0,
            lastUpdate: Date.now(),
            colors: ['#FF5733', '#33FF57', '#3357FF', '#F3FF33', '#FF33F3'],
            version: 1
        };
        
        // Виды питомцев и их эволюции
        const speciesData = {
            'egg': { requirements: { level: 0 }, next: ['basic'] },
            'basic': { requirements: { level: 3 }, next: ['advanced1', 'advanced2'] },
            'advanced1': { requirements: { level: 6 }, next: ['final1'] },
            'advanced2': { requirements: { level: 6 }, next: ['final2'] },
            'final1': { requirements: { level: 10 }, next: [] },
            'final2': { requirements: { level: 10 }, next: [] }
        };
        
        // Элементы интерфейса
        const elements = {
            menuScreen: document.getElementById('menu-screen'),
            petCount: document.getElementById('pet-count'),
            petContainer: document.getElementById('pet-container'),
            currentPet: document.getElementById('current-pet'),
            level: document.getElementById('level'),
            expBar: document.getElementById('exp-bar'),
            healthBar: document.getElementById('health-bar'),
            hungerBar: document.getElementById('hunger-bar'),
            energyBar: document.getElementById('energy-bar'),
            feedBtn: document.getElementById('feed-btn'),
            playBtn: document.getElementById('play-btn'),
            sleepBtn: document.getElementById('sleep-btn'),
            healBtn: document.getElementById('heal-btn'),
            trainBtn: document.getElementById('train-btn'),
            evolutionScreen: document.getElementById('evolution-screen'),
            oldPet: document.getElementById('old-pet'),
            newPet: document.getElementById('new-pet'),
            evolutionOkBtn: document.getElementById('evolution-ok-btn'),
            newGameBtn: document.getElementById('new-game-btn'),
            continueBtn: document.getElementById('continue-btn')
        };
        
        // Инициализация игры
        function initGame() {
            loadGame();
            setupEventListeners();
            
            if (gameState.pets.length > 0) {
                showGame();
            } else {
                showMenu();
            }
            
            // Запускаем игровой цикл
            setInterval(gameLoop, 1000);
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Кнопки меню
            elements.newGameBtn.addEventListener('click', startNewGame);
            elements.continueBtn.addEventListener('click', showGame);
            
            // Игровые действия
            elements.feedBtn.addEventListener('click', () => performAction('feed'));
            elements.playBtn.addEventListener('click', () => performAction('play'));
            elements.sleepBtn.addEventListener('click', () => performAction('sleep'));
            elements.healBtn.addEventListener('click', () => performAction('heal'));
            elements.trainBtn.addEventListener('click', () => performAction('train'));
            
            // Эволюция
            elements.evolutionOkBtn.addEventListener('click', finishEvolution);
        }
        
        // Игровой цикл
        function gameLoop() {
            if (gameState.pets.length === 0) return;
            
            const now = Date.now();
            const deltaTime = (now - gameState.lastUpdate) / 1000; // в секундах
            gameState.lastUpdate = now;
            
            // Обновляем всех питомцев (но активно только текущий)
            gameState.pets.forEach((pet, index) => {
                const isActive = index === gameState.currentPetIndex;
                updatePet(pet, deltaTime, isActive);
            });
            
            // Сохраняем игру после каждого обновления
            saveGame();
            updateUI();
        }
        
        // Обновление состояния питомца
        function updatePet(pet, deltaTime, isActive) {
            // Уменьшаем показатели со временем
            if (isActive) {
                pet.hunger = Math.max(0, pet.hunger - 0.5 * deltaTime);
                pet.energy = Math.max(0, pet.energy - 0.3 * deltaTime);
                
                // Если голод или энергия на нуле, уменьшаем здоровье
                if (pet.hunger <= 0 || pet.energy <= 0) {
                    pet.health = Math.max(0, pet.health - 1 * deltaTime);
                }
            }
            
            // Проверяем, не умер ли питомец
            if (pet.health <= 0 && !pet.isDead) {
                pet.isDead = true;
                pet.deathTime = Date.now();
            }
            
            // Если питомец мертв более 5 минут, удаляем его
            if (pet.isDead && Date.now() - pet.deathTime > 300000) {
                const index = gameState.pets.indexOf(pet);
                if (index !== -1) {
                    gameState.pets.splice(index, 1);
                    if (gameState.currentPetIndex >= index) {
                        gameState.currentPetIndex = Math.max(0, gameState.currentPetIndex - 1);
                    }
                }
            }
        }
        
        // Выполнение действия с питомцем
        function performAction(action) {
            const pet = getCurrentPet();
            if (!pet || pet.isDead) return;
            
            switch (action) {
                case 'feed':
                    pet.hunger = Math.min(100, pet.hunger + 30);
                    pet.energy = Math.min(100, pet.energy - 5);
                    pet.exp += 5;
                    break;
                case 'play':
                    pet.energy = Math.min(100, pet.energy - 10);
                    pet.hunger = Math.max(0, pet.hunger - 5);
                    pet.exp += 10;
                    break;
                case 'sleep':
                    pet.energy = Math.min(100, pet.energy + 40);
                    pet.hunger = Math.max(0, pet.hunger - 10);
                    pet.exp += 5;
                    break;
                case 'heal':
                    pet.health = Math.min(100, pet.health + 30);
                    pet.energy = Math.max(0, pet.energy - 15);
                    pet.exp += 5;
                    break;
                case 'train':
                    pet.energy = Math.max(0, pet.energy - 20);
                    pet.hunger = Math.max(0, pet.hunger - 15);
                    pet.exp += 20;
                    break;
            }
            
            checkLevelUp(pet);
            updateUI();
            saveGame();
        }
        
        // Проверка повышения уровня
        function checkLevelUp(pet) {
            const expNeeded = getExpForLevel(pet.level + 1);
            
            if (pet.exp >= expNeeded) {
                pet.level++;
                pet.exp -= expNeeded;
                
                // Проверяем, доступна ли эволюция
                checkEvolution(pet);
                
                // Если уровень кратен 3, питомец может разделиться
                if (pet.level % 3 === 0) {
                    reproducePet(pet);
                }
            }
        }
        
        // Проверка доступности эволюции
        function checkEvolution(pet) {
            const speciesInfo = speciesData[pet.species];
            const nextSpecies = speciesInfo.next;
            
            for (const next of nextSpecies) {
                if (pet.level >= speciesData[next].requirements.level) {
                    startEvolution(pet, next);
                    return;
                }
            }
        }
        
        // Эволюция питомца
        function startEvolution(pet, newSpecies) {
            // Сохраняем текущий цвет
            const oldColor = pet.color;
            
            // Генерируем новый цвет для эволюции
            const availableColors = gameState.colors.filter(c => c !== oldColor);
            const newColor = availableColors[Math.floor(Math.random() * availableColors.length)];
            
            // Показываем экран эволюции
            elements.oldPet.style.backgroundColor = oldColor;
            elements.newPet.style.backgroundColor = newColor;
            elements.evolutionScreen.style.display = 'flex';
            
            // Сохраняем новые данные во временные свойства
            pet.newSpecies = newSpecies;
            pet.newColor = newColor;
        }
        
        // Завершение эволюции
        function finishEvolution() {
            const pet = getCurrentPet();
            if (!pet || !pet.newSpecies) return;
            
            // Меняем вид и цвет питомца
            pet.species = pet.newSpecies;
            pet.color = pet.newColor;
            delete pet.newSpecies;
            delete pet.newColor;
            
            // Обновляем интерфейс
            elements.evolutionScreen.style.display = 'none';
            updateUI();
            saveGame();
        }
        
        // Размножение питомца делением
        function reproducePet(parentPet) {
            // Генерируем новый цвет (отличный от родительского)
            const availableColors = gameState.colors.filter(c => c !== parentPet.color);
            if (availableColors.length === 0) return;
            
            const newColor = availableColors[Math.floor(Math.random() * availableColors.length)];
            
            // Создаем нового питомца
            const newPet = {
                species: parentPet.species,
                color: newColor,
                level: 1,
                exp: 0,
                health: 100,
                hunger: 50,
                energy: 80,
                isDead: false,
                birthTime: Date.now()
            };
            
            // Добавляем нового питомца в коллекцию
            gameState.pets.push(newPet);
            
            // Уведомляем пользователя
            alert(`Ваш питомец достиг уровня ${parentPet.level} и разделился!`);
        }
        
        // Получение текущего питомца
        function getCurrentPet() {
            return gameState.pets[gameState.currentPetIndex];
        }
        
        // Получение опыта для уровня
        function getExpForLevel(level) {
            return 100 * Math.pow(level, 1.5);
        }
        
        // Обновление интерфейса
        function updateUI() {
            const pet = getCurrentPet();
            if (!pet) return;
            
            // Обновляем счетчик питомцев
            elements.petCount.textContent = `Питомцев: ${gameState.pets.length}`;
            
            // Обновляем внешний вид питомца
            elements.currentPet.style.backgroundColor = pet.color;
            if (pet.isDead) {
                elements.currentPet.style.opacity = '0.5';
            } else {
                elements.currentPet.style.opacity = '1';
            }
            
            // Обновляем статистику
            elements.level.textContent = pet.level;
            
            const expPercent = (pet.exp / getExpForLevel(pet.level + 1)) * 100;
            elements.expBar.style.width = `${expPercent}%`;
            
            elements.healthBar.style.width = `${pet.health}%`;
            elements.hungerBar.style.width = `${pet.hunger}%`;
            elements.energyBar.style.width = `${pet.energy}%`;
            
            // Блокируем кнопки, если питомец мертв
            if (pet.isDead) {
                elements.feedBtn.disabled = true;
                elements.playBtn.disabled = true;
                elements.sleepBtn.disabled = true;
                elements.healBtn.disabled = true;
                elements.trainBtn.disabled = true;
            } else {
                elements.feedBtn.disabled = false;
                elements.playBtn.disabled = false;
                elements.sleepBtn.disabled = false;
                elements.healBtn.disabled = false;
                elements.trainBtn.disabled = false;
            }
        }
        
        // Начать новую игру
        function startNewGame() {
            // Создаем нового питомца
            const newPet = {
                species: 'egg',
                color: gameState.colors[0],
                level: 1,
                exp: 0,
                health: 100,
                hunger: 50,
                energy: 80,
                isDead: false,
                birthTime: Date.now()
            };
            
            // Очищаем старых питомцев и добавляем нового
            gameState.pets = [newPet];
            gameState.currentPetIndex = 0;
            gameState.lastUpdate = Date.now();
            
            // Сохраняем и показываем игру
            saveGame();
            showGame();
        }
        
        // Сохранить игру
        function saveGame() {
            localStorage.setItem('simpleTamagotchi', JSON.stringify(gameState));
        }
        
        // Загрузить игру
        function loadGame() {
            const savedGame = localStorage.getItem('simpleTamagotchi');
            if (savedGame) {
                const parsed = JSON.parse(savedGame);
                
                // Проверка версии сохранения
                if (parsed.version === gameState.version) {
                    gameState = parsed;
                }
            }
        }
        
        // Показать меню
        function showMenu() {
            elements.menuScreen.style.display = 'flex';
        }
        
        // Показать игру
        function showGame() {
            elements.menuScreen.style.display = 'none';
            updateUI();
        }
        
        // Инициализируем игру при загрузке
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>