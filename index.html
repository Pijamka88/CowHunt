<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–ø–∏–∫–∏: –ú–∏—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --grass: #7cfc00;
            --water: #4682b4;
            --sand: #f5deb3;
            --rock: #808080;
            --tree: #2e8b57;
            --house: #8b4513;
            --tapir: #4b0082;
            --menu-bg: #f5e7d0;
            --border: #5e3a1e;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            overflow: hidden;
            touch-action: none;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #game-world {
            position: absolute;
            background-color: var(--grass);
            display: grid;
            grid-template-columns: repeat(100, 40px);
            grid-template-rows: repeat(100, 40px);
        }
        
        .tile {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(0,0,0,0.1);
            position: relative;
            box-sizing: border-box;
        }
        
        .water {
            background-color: var(--water);
        }
        
        .sand {
            background-color: var(--sand);
        }
        
        .rock {
            background-color: var(--rock);
        }
        
        .tree {
            background-color: var(--tree);
        }
        
        .house {
            background-color: var(--house);
        }
        
        .tapir {
            position: absolute;
            font-size: 30px;
            z-index: 10;
            transition: all 1s ease;
            user-select: none;
        }
        
        #build-menu {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--menu-bg);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid var(--border);
            display: none;
            z-index: 100;
        }
        
        #build-menu.active {
            display: block;
        }
        
        .build-options {
            display: flex;
            gap: 10px;
        }
        
        .build-btn {
            width: 50px;
            height: 50px;
            border: 1px solid var(--border);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
        }
        
        #main-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--menu-bg);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--border);
            text-align: center;
            z-index: 200;
        }
        
        .menu-btn {
            padding: 10px 20px;
            margin: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            background-color: white;
        }
        
        #controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 50;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--menu-bg);
            border: 2px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
        }
        
        #camera {
            position: absolute;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="camera">
            <div id="game-world"></div>
        </div>
        
        <div id="build-menu">
            <h3>–ü–æ—Å—Ç—Ä–æ–π–∫–∞</h3>
            <div class="build-options">
                <div class="build-btn" data-type="tree">üå≤</div>
                <div class="build-btn" data-type="rock">ü™®</div>
                <div class="build-btn" data-type="house">üè†</div>
                <div class="build-btn" data-type="water">üíß</div>
                <div class="build-btn" data-type="sand">üèñÔ∏è</div>
            </div>
        </div>
        
        <div id="controls">
            <div class="control-btn" id="build-btn">üî®</div>
            <div class="control-btn" id="menu-btn">‚öôÔ∏è</div>
        </div>
    </div>
    
    <div id="main-menu">
        <h1>–¢–∞–ø–∏–∫–∏: –ú–∏—Ä</h1>
        <button class="menu-btn" id="new-game-btn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <button class="menu-btn" id="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        const gameState = {
            world: {},
            tapirs: [],
            buildings: [],
            camera: { x: 0, y: 0 },
            version: 1,
            hasSave: false
        };
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const elements = {
            gameWorld: document.getElementById('game-world'),
            buildMenu: document.getElementById('build-menu'),
            buildBtn: document.getElementById('build-btn'),
            menuBtn: document.getElementById('menu-btn'),
            mainMenu: document.getElementById('main-menu'),
            newGameBtn: document.getElementById('new-game-btn'),
            continueBtn: document.getElementById('continue-btn'),
            camera: document.getElementById('camera')
        };
        
        // –†–∞–∑–º–µ—Ä—ã –º–∏—Ä–∞
        const WORLD_SIZE = 100;
        const TILE_SIZE = 40;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            loadGame();
            setupEventListeners();
            
            if (gameState.hasSave) {
                renderWorld();
            } else {
                showMainMenu();
            }
            
            // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            setInterval(gameLoop, 1000/30);
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∏—Ä–∞
        function createNewWorld() {
            gameState.world = {};
            gameState.tapirs = [];
            gameState.buildings = [];
            gameState.camera = { x: 0, y: 0 };
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∞–Ω–¥—à–∞—Ñ—Ç–∞
            for (let y = 0; y < WORLD_SIZE; y++) {
                for (let x = 0; x < WORLD_SIZE; x++) {
                    const key = `${x},${y}`;
                    
                    // 10% –≤–æ–¥—ã, 5% –ø–µ—Å–∫–∞
                    const rand = Math.random();
                    if (rand < 0.1) {
                        gameState.world[key] = 'water';
                    } else if (rand < 0.15) {
                        gameState.world[key] = 'sand';
                    } else {
                        gameState.world[key] = 'grass';
                    }
                }
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ 5 —Ç–∞–ø–∏–∫–æ–≤
            for (let i = 0; i < 5; i++) {
                createTapir(
                    Math.floor(Math.random() * WORLD_SIZE),
                    Math.floor(Math.random() * WORLD_SIZE)
                );
            }
            
            gameState.hasSave = true;
            renderWorld();
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–ø–∏–∫–∞
        function createTapir(x, y) {
            const tapir = {
                id: Date.now() + Math.random(),
                x: x,
                y: y,
                direction: Math.random() * Math.PI * 2,
                speed: 0.5 + Math.random() * 0.5,
                nextMove: 0
            };
            
            gameState.tapirs.push(tapir);
            return tapir;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
        function addBuilding(x, y, type) {
            const key = `${x},${y}`;
            gameState.world[key] = type;
            renderTile(x, y);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏—Ä–∞
        function renderWorld() {
            elements.gameWorld.innerHTML = '';
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–π–ª–æ–≤
            for (let y = 0; y < WORLD_SIZE; y++) {
                for (let x = 0; x < WORLD_SIZE; x++) {
                    renderTile(x, y);
                }
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–ø–∏–∫–æ–≤
            gameState.tapirs.forEach(tapir => {
                renderTapir(tapir);
            });
            
            updateCamera();
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–π–ª–∞
        function renderTile(x, y) {
            const key = `${x},${y}`;
            const tileType = gameState.world[key] || 'grass';
            
            let tile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
            
            if (!tile) {
                tile = document.createElement('div');
                tile.className = `tile ${tileType}`;
                tile.dataset.x = x;
                tile.dataset.y = y;
                elements.gameWorld.appendChild(tile);
                
                // –ö–ª–∏–∫ –ø–æ —Ç–∞–π–ª—É
                tile.addEventListener('click', () => {
                    if (elements.buildMenu.classList.contains('active')) {
                        addBuilding(x, y, currentBuildingType);
                    }
                });
            } else {
                tile.className = `tile ${tileType}`;
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–ø–∏–∫–∞
        function renderTapir(tapir) {
            let tapirElement = document.getElementById(`tapir-${tapir.id}`);
            
            if (!tapirElement) {
                tapirElement = document.createElement('div');
                tapirElement.id = `tapir-${tapir.id}`;
                tapirElement.className = 'tapir';
                tapirElement.innerHTML = 'ü¶è';
                elements.gameWorld.appendChild(tapirElement);
            }
            
            const screenX = tapir.x * TILE_SIZE - gameState.camera.x;
            const screenY = tapir.y * TILE_SIZE - gameState.camera.y;
            
            tapirElement.style.left = `${screenX}px`;
            tapirElement.style.top = `${screenY}px`;
            
            // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è
            if (tapir.direction > Math.PI/2 && tapir.direction < 3*Math.PI/2) {
                tapirElement.style.transform = 'scaleX(-1)';
            } else {
                tapirElement.style.transform = 'scaleX(1)';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã
        function updateCamera() {
            elements.camera.style.transform = `translate(${-gameState.camera.x}px, ${-gameState.camera.y}px)`;
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            if (!gameState.hasSave) return;
            
            const now = Date.now();
            
            // –î–≤–∏–∂–µ–Ω–∏–µ —Ç–∞–ø–∏–∫–æ–≤
            gameState.tapirs.forEach(tapir => {
                if (now > tapir.nextMove) {
                    // –°–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    if (Math.random() < 0.1) {
                        tapir.direction += (Math.random() - 0.5) * Math.PI/2;
                    }
                    
                    // –ù–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    const newX = tapir.x + Math.cos(tapir.direction) * tapir.speed * 0.1;
                    const newY = tapir.y + Math.sin(tapir.direction) * tapir.speed * 0.1;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –º–∏—Ä–∞
                    if (newX >= 0 && newX < WORLD_SIZE && newY >= 0 && newY < WORLD_SIZE) {
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
                        const tileKey = `${Math.floor(newX)},${Math.floor(newY)}`;
                        const tileType = gameState.world[tileKey];
                        
                        if (tileType !== 'water' && tileType !== 'rock') {
                            tapir.x = newX;
                            tapir.y = newY;
                        } else {
                            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏
                            tapir.direction = Math.random() * Math.PI * 2;
                        }
                    } else {
                        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É –≥—Ä–∞–Ω–∏—Ü—ã
                        tapir.direction = Math.random() * Math.PI * 2;
                    }
                    
                    renderTapir(tapir);
                    tapir.nextMove = now + 1000;
                }
            });
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            elements.newGameBtn.addEventListener('click', () => {
                createNewWorld();
                hideMainMenu();
            });
            
            elements.continueBtn.addEventListener('click', hideMainMenu);
            
            // –ö–Ω–æ–ø–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
            elements.buildBtn.addEventListener('click', toggleBuildMenu);
            
            // –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é
            elements.menuBtn.addEventListener('click', showMainMenu);
            
            // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
            document.querySelectorAll('.build-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentBuildingType = btn.dataset.type;
                    elements.buildMenu.classList.remove('active');
                });
            });
            
            // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            let isDragging = false;
            let lastX, lastY;
            
            elements.gameWorld.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
                e.preventDefault();
            });
            
            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - lastX;
                    const dy = e.clientY - lastY;
                    
                    gameState.camera.x -= dx;
                    gameState.camera.y -= dy;
                    
                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                    const maxCamera = WORLD_SIZE * TILE_SIZE - window.innerWidth;
                    gameState.camera.x = Math.max(0, Math.min(gameState.camera.x, maxCamera));
                    gameState.camera.y = Math.max(0, Math.min(gameState.camera.y, maxCamera));
                    
                    updateCamera();
                    
                    lastX = e.clientX;
                    lastY = e.clientY;
                }
            });
            
            window.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // –¢–∞—á-—Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            elements.gameWorld.addEventListener('touchstart', (e) => {
                isDragging = true;
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
                e.preventDefault();
            });
            
            window.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const dx = e.touches[0].clientX - lastX;
                    const dy = e.touches[0].clientY - lastY;
                    
                    gameState.camera.x -= dx;
                    gameState.camera.y -= dy;
                    
                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                    const maxCamera = WORLD_SIZE * TILE_SIZE - window.innerWidth;
                    gameState.camera.x = Math.max(0, Math.min(gameState.camera.x, maxCamera));
                    gameState.camera.y = Math.max(0, Math.min(gameState.camera.y, maxCamera));
                    
                    updateCamera();
                    
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;
                }
            });
            
            window.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
        let currentBuildingType = 'tree';
        
        function toggleBuildMenu() {
            elements.buildMenu.classList.toggle('active');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        function showMainMenu() {
            elements.mainMenu.style.display = 'block';
        }
        
        // –°–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        function hideMainMenu() {
            elements.mainMenu.style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã
        function saveGame() {
            gameState.hasSave = true;
            localStorage.setItem('tapirWorld', JSON.stringify(gameState));
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã
        function loadGame() {
            const savedGame = localStorage.getItem('tapirWorld');
            if (savedGame) {
                const parsed = JSON.parse(savedGame);
                if (parsed.version === gameState.version) {
                    Object.assign(gameState, parsed);
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>