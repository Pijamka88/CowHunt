<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Bear Tamagotchi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #A0522D;
            --background-color: #F5DEB3;
            --text-color: #4B3621;
            --highlight-color: #D2B48C;
            --border-color: #5D4037;
        }

        body {
            font-family: 'Times New Roman', serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23D2B48C" fill-opacity="0.2" d="M0 0h100v100H0z"/></svg>');
            background-size: 200px;
        }

        #game-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .pets-counter {
            background-color: var(--secondary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }

        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .pet {
            background-color: var(--highlight-color);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border: 2px solid var(--border-color);
            position: relative;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .pet:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .pet.active {
            background-color: var(--secondary-color);
            border-color: var(--text-color);
        }

        .pet-emoji {
            font-size: 40px;
            margin-bottom: 5px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .pet-level {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--primary-color);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }

        .pet-stats {
            font-size: 12px;
            margin-top: 5px;
        }

        .stats-bar {
            height: 5px;
            background-color: #ddd;
            border-radius: 3px;
            margin: 2px 0;
            overflow: hidden;
        }

        .stats-fill {
            height: 100%;
            border-radius: 3px;
        }

        .health-fill { background-color: #8B0000; }
        .hunger-fill { background-color: #556B2F; }
        .energy-fill { background-color: #483D8B; }
        .happiness-fill { background-color: #FF8C00; }

        .actions-panel {
            background-color: var(--primary-color);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .actions-title {
            color: white;
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        button {
            background-color: var(--secondary-color);
            border: none;
            color: white;
            padding: 10px;
            text-align: center;
            font-family: 'Times New Roman', serif;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #8B4513;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(139, 69, 19, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            animation: fadeInOut 3s forwards;
            display: none;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }

        .pet-dead {
            filter: grayscale(100%);
            opacity: 0.7;
        }

        .evolution-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .evolution-content {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 3px solid var(--border-color);
            max-width: 80%;
        }

        .evolution-emoji {
            font-size: 60px;
            margin: 20px 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="header">
            <h1>Medieval Bears</h1>
            <div class="pets-counter" id="pets-counter">0</div>
        </div>

        <div class="pets-grid" id="pets-grid">
            <!-- Pets will be rendered here -->
        </div>

        <div class="actions-panel">
            <h3 class="actions-title">Actions</h3>
            <div class="action-buttons">
                <button id="feed-btn">Feed (üçñ)</button>
                <button id="play-btn">Play (‚öîÔ∏è)</button>
                <button id="sleep-btn">Sleep (üõèÔ∏è)</button>
                <button id="heal-btn">Heal (‚ù§Ô∏è)</button>
                <button id="train-btn">Train (üèãÔ∏è)</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>
    </div>

    <div class="evolution-animation" id="evolution-animation" style="display: none;">
        <div class="evolution-content">
            <h2>Evolution!</h2>
            <div class="evolution-emoji" id="evolution-emoji">üêª</div>
            <p id="evolution-text">Your bear has evolved!</p>
            <button id="evolution-close-btn">Continue</button>
        </div>
    </div>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Game state
        let gameState = {
            pets: [],
            activePetIndex: 0,
            lastUpdate: Date.now(),
            version: 2
        };
        
        // Bear species data
        const speciesData = {
            'cub': {
                emoji: 'üêª',
                color: '#8B4513', // Brown
                next: 'bear',
                levelReq: 3,
                stats: { health: 100, hunger: 50, energy: 80, happiness: 70 }
            },
            'bear': {
                emoji: 'üêª‚Äç‚ùÑÔ∏è',
                color: '#A9A9A9', // Gray
                next: 'knight',
                levelReq: 6,
                stats: { health: 150, hunger: 70, energy: 90, happiness: 80 }
            },
            'knight': {
                emoji: 'üêª‚Äç‚öîÔ∏è',
                color: '#556B2F', // Dark Olive Green
                next: 'king',
                levelReq: 9,
                stats: { health: 200, hunger: 90, energy: 100, happiness: 90 }
            },
            'king': {
                emoji: 'üêª‚Äçüëë',
                color: '#DAA520', // Goldenrod
                next: null,
                levelReq: 12,
                stats: { health: 250, hunger: 100, energy: 120, happiness: 100 }
            }
        };
        
        // DOM elements
        const elements = {
            petsCounter: document.getElementById('pets-counter'),
            petsGrid: document.getElementById('pets-grid'),
            feedBtn: document.getElementById('feed-btn'),
            playBtn: document.getElementById('play-btn'),
            sleepBtn: document.getElementById('sleep-btn'),
            healBtn: document.getElementById('heal-btn'),
            trainBtn: document.getElementById('train-btn'),
            notification: document.getElementById('notification'),
            evolutionAnimation: document.getElementById('evolution-animation'),
            evolutionEmoji: document.getElementById('evolution-emoji'),
            evolutionText: document.getElementById('evolution-text'),
            evolutionCloseBtn: document.getElementById('evolution-close-btn')
        };
        
        // Initialize game
        function initGame() {
            loadGame();
            setupEventListeners();
            
            if (gameState.pets.length === 0) {
                // Start with one bear cub
                addNewPet();
            }
            
            renderPets();
            updateUI();
            
            // Start game loop
            setInterval(gameLoop, 1000);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Action buttons
            elements.feedBtn.addEventListener('click', () => performAction('feed'));
            elements.playBtn.addEventListener('click', () => performAction('play'));
            elements.sleepBtn.addEventListener('click', () => performAction('sleep'));
            elements.healBtn.addEventListener('click', () => performAction('heal'));
            elements.trainBtn.addEventListener('click', () => performAction('train'));
            
            // Evolution close button
            elements.evolutionCloseBtn.addEventListener('click', () => {
                elements.evolutionAnimation.style.display = 'none';
            });
        }
        
        // Game loop
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - gameState.lastUpdate) / 1000; // in seconds
            gameState.lastUpdate = now;
            
            // Update all pets
            gameState.pets.forEach(pet => {
                updatePet(pet, deltaTime);
            });
            
            // Save game and update UI
            saveGame();
            updateUI();
        }
        
        // Update pet stats over time
        function updatePet(pet, deltaTime) {
            if (pet.isDead) return;
            
            // Decrease stats over time
            pet.hunger = Math.max(0, pet.hunger - 0.5 * deltaTime);
            pet.energy = Math.max(0, pet.energy - 0.3 * deltaTime);
            pet.happiness = Math.max(0, pet.happiness - 0.2 * deltaTime);
            
            // Health penalty if hunger or energy is too low
            if (pet.hunger <= 0 || pet.energy <= 0) {
                pet.health = Math.max(0, pet.health - 1 * deltaTime);
            }
            
            // Happiness penalty if health is low
            if (pet.health <= 0) {
                pet.happiness = Math.max(0, pet.happiness - 1 * deltaTime);
            }
            
            // Check for death
            if (pet.health <= 0 && !pet.isDead) {
                pet.isDead = true;
                showNotification(`Your ${speciesData[pet.species].emoji} has died!`);
            }
            
            // Check for automatic evolution
            if (!pet.isDead && pet.species !== 'king' && pet.level >= speciesData[pet.species].levelReq) {
                evolvePet(pet);
            }
        }
        
        // Perform action on active pet
        function performAction(action) {
            const pet = gameState.pets[gameState.activePetIndex];
            if (!pet || pet.isDead) return;
            
            switch (action) {
                case 'feed':
                    pet.hunger = Math.min(100, pet.hunger + 30);
                    pet.energy = Math.min(100, pet.energy - 5);
                    pet.exp += 5;
                    showNotification(`Fed the bear! +30 Hunger`);
                    break;
                case 'play':
                    pet.happiness = Math.min(100, pet.happiness + 20);
                    pet.energy = Math.min(100, pet.energy - 10);
                    pet.hunger = Math.max(0, pet.hunger - 5);
                    pet.exp += 10;
                    showNotification(`Played with the bear! +20 Happiness`);
                    break;
                case 'sleep':
                    pet.energy = Math.min(100, pet.energy + 40);
                    pet.hunger = Math.max(0, pet.hunger - 10);
                    pet.exp += 5;
                    showNotification(`Bear slept well! +40 Energy`);
                    break;
                case 'heal':
                    const speciesStats = speciesData[pet.species].stats;
                    pet.health = Math.min(speciesStats.health, pet.health + 30);
                    pet.energy = Math.max(0, pet.energy - 15);
                    pet.exp += 5;
                    showNotification(`Healed the bear! +30 Health`);
                    break;
                case 'train':
                    pet.energy = Math.max(0, pet.energy - 20);
                    pet.hunger = Math.max(0, pet.hunger - 15);
                    pet.exp += 20;
                    showNotification(`Trained the bear! +20 Exp`);
                    break;
            }
            
            checkLevelUp(pet);
            renderPets();
            saveGame();
        }
        
        // Check for level up
        function checkLevelUp(pet) {
            const expNeeded = getExpForLevel(pet.level + 1);
            
            if (pet.exp >= expNeeded) {
                pet.level++;
                pet.exp -= expNeeded;
                showNotification(`Level up! Now level ${pet.level}`);
                
                // Every 3 levels, add a new pet
                if (pet.level % 3 === 0) {
                    addNewPet();
                    showNotification(`A new bear cub has appeared!`);
                }
            }
        }
        
        // Evolve pet to next species
        function evolvePet(pet) {
            const currentSpecies = pet.species;
            const nextSpecies = speciesData[currentSpecies].next;
            
            if (!nextSpecies) return;
            
            // Update pet species
            pet.species = nextSpecies;
            
            // Update stats to new species base
            const newStats = speciesData[nextSpecies].stats;
            pet.health = newStats.health;
            pet.hunger = newStats.hunger;
            pet.energy = newStats.energy;
            pet.happiness = newStats.happiness;
            
            // Show evolution animation
            showEvolution(currentSpecies, nextSpecies);
        }
        
        // Add new pet to the collection
        function addNewPet() {
            const newPet = {
                species: 'cub',
                level: 1,
                exp: 0,
                health: speciesData['cub'].stats.health,
                hunger: speciesData['cub'].stats.hunger,
                energy: speciesData['cub'].stats.energy,
                happiness: speciesData['cub'].stats.happiness,
                isDead: false
            };
            
            gameState.pets.push(newPet);
            gameState.activePetIndex = gameState.pets.length - 1;
        }
        
        // Calculate exp needed for level
        function getExpForLevel(level) {
            return 100 * Math.pow(level, 1.5);
        }
        
        // Render all pets
        function renderPets() {
            elements.petsGrid.innerHTML = '';
            
            gameState.pets.forEach((pet, index) => {
                const species = speciesData[pet.species];
                const isActive = index === gameState.activePetIndex;
                
                const petElement = document.createElement('div');
                petElement.className = `pet ${isActive ? 'active' : ''} ${pet.isDead ? 'pet-dead' : ''}`;
                petElement.style.backgroundColor = species.color;
                petElement.style.opacity = pet.isDead ? '0.7' : '1';
                petElement.onclick = () => {
                    gameState.activePetIndex = index;
                    renderPets();
                    updateUI();
                };
                
                const emojiElement = document.createElement('div');
                emojiElement.className = 'pet-emoji';
                emojiElement.textContent = species.emoji;
                
                const levelElement = document.createElement('div');
                levelElement.className = 'pet-level';
                levelElement.textContent = pet.level;
                
                const statsElement = document.createElement('div');
                statsElement.className = 'pet-stats';
                
                // Health bar
                const maxHealth = species.stats.health;
                statsElement.innerHTML += `
                    <div>‚ù§Ô∏è ${Math.floor(pet.health)}/${maxHealth}</div>
                    <div class="stats-bar"><div class="stats-fill health-fill" style="width: ${(pet.health / maxHealth) * 100}%"></div></div>
                `;
                
                // Hunger bar
                statsElement.innerHTML += `
                    <div>üçñ ${Math.floor(pet.hunger)}/100</div>
                    <div class="stats-bar"><div class="stats-fill hunger-fill" style="width: ${pet.hunger}%"></div></div>
                `;
                
                // Energy bar
                statsElement.innerHTML += `
                    <div>‚ö° ${Math.floor(pet.energy)}/100</div>
                    <div class="stats-bar"><div class="stats-fill energy-fill" style="width: ${pet.energy}%"></div></div>
                `;
                
                // Happiness bar
                statsElement.innerHTML += `
                    <div>üòä ${Math.floor(pet.happiness)}/100</div>
                    <div class="stats-bar"><div class="stats-fill happiness-fill" style="width: ${pet.happiness}%"></div></div>
                `;
                
                petElement.appendChild(emojiElement);
                petElement.appendChild(levelElement);
                petElement.appendChild(statsElement);
                elements.petsGrid.appendChild(petElement);
            });
        }
        
        // Update UI elements
        function updateUI() {
            // Update pets counter
            elements.petsCounter.textContent = gameState.pets.length;
            
            // Update action buttons state
            const activePet = gameState.pets[gameState.activePetIndex];
            if (activePet) {
                const isDead = activePet.isDead;
                elements.feedBtn.disabled = isDead;
                elements.playBtn.disabled = isDead;
                elements.sleepBtn.disabled = isDead;
                elements.healBtn.disabled = isDead;
                elements.trainBtn.disabled = isDead;
            }
        }
        
        // Show notification
        function showNotification(message) {
            elements.notification.textContent = message;
            elements.notification.style.display = 'block';
            
            // Hide after animation
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }
        
        // Show evolution animation
        function showEvolution(oldSpecies, newSpecies) {
            elements.evolutionEmoji.textContent = `${speciesData[oldSpecies].emoji} ‚Üí ${speciesData[newSpecies].emoji}`;
            elements.evolutionText.textContent = `Your bear evolved into a ${newSpecies}!`;
            elements.evolutionAnimation.style.display = 'flex';
        }
        
        // Save game state
        function saveGame() {
            localStorage.setItem('medievalBearTamagotchi', JSON.stringify(gameState));
        }
        
        // Load game state
        function loadGame() {
            const savedGame = localStorage.getItem('medievalBearTamagotchi');
            if (savedGame) {
                const parsed = JSON.parse(savedGame);
                
                // Check version for compatibility
                if (parsed.version === gameState.version) {
                    gameState = parsed;
                }
            }
        }
        
        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>