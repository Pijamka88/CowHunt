<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolution Tamagotchi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .menu button, .action-button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .menu button:hover, .action-button:hover {
            background-color: #45a049;
        }
        .pet-container {
            text-align: center;
            margin: 20px 0;
        }
        .pet-stats {
            margin-top: 15px;
            text-align: left;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .pet-stats div {
            margin: 5px 0;
        }
        .progress-bar {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 5px 0;
        }
        .progress {
            height: 20px;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .action-button {
            flex: 1 1 40%;
            min-width: 100px;
        }
        .evolution-message {
            color: #ff5722;
            font-weight: bold;
            margin: 10px 0;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .pet-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .back-button {
            background-color: #f44336;
            margin-top: 15px;
        }
        .back-button:hover {
            background-color: #d32f2f;
        }
        h1, h2, h3 {
            color: #2E7D32;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container" id="game-container">
        <!-- Content will be dynamically loaded here -->
    </div>

    <script>
        // Game state
        const gameState = {
            currentScreen: 'menu',
            pets: [],
            resources: {
                food: 10,
                energy: 100,
                money: 0
            },
            gameTime: 0,
            lastUpdate: Date.now(),
            settings: {
                volume: 0.5
            }
        };

        // Pet types and evolution paths
        const petTypes = {
            basic: {
                name: "Basic Cell",
                maxHealth: 100,
                maxHunger: 100,
                maxEnergy: 100,
                growthRate: 0.5,
                evolutionThreshold: 100,
                nextStage: "advanced",
                actions: ["feed", "play", "rest"]
            },
            advanced: {
                name: "Advanced Organism",
                maxHealth: 150,
                maxHunger: 120,
                maxEnergy: 120,
                growthRate: 0.4,
                evolutionThreshold: 200,
                nextStage: "complex",
                actions: ["feed", "play", "train", "rest"]
            },
            complex: {
                name: "Complex Lifeform",
                maxHealth: 200,
                maxHunger: 150,
                maxEnergy: 150,
                growthRate: 0.3,
                evolutionThreshold: 300,
                nextStage: "final",
                actions: ["feed", "play", "train", "study", "rest"]
            },
            final: {
                name: "Final Evolution",
                maxHealth: 300,
                maxHunger: 200,
                maxEnergy: 200,
                growthRate: 0.2,
                evolutionThreshold: 0, // Can't evolve further
                nextStage: null,
                actions: ["feed", "play", "train", "study", "meditate", "rest"]
            }
        };

        // Initialize the game
        function initGame() {
            loadGame();
            updateGameState();
            renderScreen(gameState.currentScreen);
            
            // Set up game loop
            setInterval(gameLoop, 1000);
            
            // Initialize Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
            }
        }

        // Game loop
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - gameState.lastUpdate) / 1000; // in seconds
            gameState.lastUpdate = now;
            
            updateGameState(deltaTime);
            saveGame();
            
            // Re-render current screen if needed
            if (gameState.currentScreen === 'game') {
                renderScreen('game');
            }
        }

        // Update game state
        function updateGameState(deltaTime = 0) {
            gameState.gameTime += deltaTime;
            
            // Update each pet
            gameState.pets.forEach(pet => {
                // Increase hunger and decrease energy over time
                pet.hunger = Math.min(pet.maxHunger, pet.hunger + deltaTime * 0.5);
                pet.energy = Math.max(0, pet.energy - deltaTime * 0.3);
                
                // Health is affected by hunger and energy
                if (pet.hunger > pet.maxHunger * 0.8 || pet.energy < pet.maxEnergy * 0.2) {
                    pet.health = Math.max(0, pet.health - deltaTime * 0.2);
                } else if (pet.health < pet.maxHealth) {
                    pet.health = Math.min(pet.maxHealth, pet.health + deltaTime * 0.1);
                }
                
                // Growth increases when needs are met
                if (pet.hunger < pet.maxHunger * 0.6 && pet.energy > pet.maxEnergy * 0.4) {
                    pet.growth = Math.min(pet.evolutionThreshold, pet.growth + deltaTime * pet.growthRate);
                }
                
                // Check for evolution
                if (pet.growth >= pet.evolutionThreshold && pet.nextStage) {
                    evolvePet(pet);
                }
            });
            
            // Remove dead pets
            gameState.pets = gameState.pets.filter(pet => pet.health > 0);
            
            // Generate resources over time
            gameState.resources.energy = Math.min(100, gameState.resources.energy + deltaTime * 0.05);
            
            // If no pets left and not in menu, go to menu
            if (gameState.pets.length === 0 && gameState.currentScreen !== 'menu') {
                gameState.currentScreen = 'menu';
                renderScreen('menu');
            }
        }

        // Create a new pet
        function createPet(type = 'basic') {
            const typeInfo = petTypes[type];
            const newPet = {
                id: Date.now().toString(),
                type: type,
                name: typeInfo.name + " " + (gameState.pets.length + 1),
                health: typeInfo.maxHealth,
                maxHealth: typeInfo.maxHealth,
                hunger: 0,
                maxHunger: typeInfo.maxHunger,
                energy: typeInfo.maxEnergy,
                maxEnergy: typeInfo.maxEnergy,
                growth: 0,
                growthRate: typeInfo.growthRate,
                evolutionThreshold: typeInfo.evolutionThreshold,
                nextStage: typeInfo.nextStage,
                actions: [...typeInfo.actions],
                lastAction: null
            };
            gameState.pets.push(newPet);
            return newPet;
        }

        // Evolve a pet
        function evolvePet(pet) {
            const nextType = pet.nextStage;
            if (!nextType) return;
            
            const typeInfo = petTypes[nextType];
            
            // Update pet properties
            pet.type = nextType;
            pet.name = typeInfo.name + " " + pet.id.substring(-3);
            pet.maxHealth = typeInfo.maxHealth;
            pet.health = typeInfo.maxHealth;
            pet.maxHunger = typeInfo.maxHunger;
            pet.hunger = 0;
            pet.maxEnergy = typeInfo.maxEnergy;
            pet.energy = typeInfo.maxEnergy;
            pet.growth = 0;
            pet.growthRate = typeInfo.growthRate;
            pet.evolutionThreshold = typeInfo.evolutionThreshold;
            pet.nextStage = typeInfo.nextStage;
            pet.actions = [...typeInfo.actions];
            
            // If growth threshold is high enough, pet divides
            if (pet.growth >= pet.evolutionThreshold * 1.5 && gameState.pets.length < 10) {
                dividePet(pet);
            }
        }

        // Pet divides into two
        function dividePet(pet) {
            const newPet = {
                ...JSON.parse(JSON.stringify(pet)),
                id: Date.now().toString(),
                name: petTypes[pet.type].name + " " + (gameState.pets.length + 1),
                growth: 0
            };
            gameState.pets.push(newPet);
            pet.growth = pet.evolutionThreshold * 0.5; // Reset growth after division
            return newPet;
        }

        // Pet actions
        function performAction(pet, action) {
            const cost = {
                feed: { food: 5, energy: 0 },
                play: { food: 0, energy: 10 },
                train: { food: 5, energy: 15 },
                study: { food: 10, energy: 20 },
                meditate: { food: 0, energy: 5 },
                rest: { food: 0, energy: -20 }
            }[action];
            
            // Check if we have enough resources
            if (gameState.resources.food < cost.food || gameState.resources.energy < cost.energy) {
                return false;
            }
            
            // Spend resources
            gameState.resources.food -= cost.food;
            gameState.resources.energy -= cost.energy;
            
            // Apply action effects
            switch (action) {
                case 'feed':
                    pet.hunger = Math.max(0, pet.hunger - 30);
                    break;
                case 'play':
                    pet.growth += 5;
                    pet.energy = Math.max(0, pet.energy - 10);
                    gameState.resources.money += 1;
                    break;
                case 'train':
                    pet.growth += 10;
                    pet.energy = Math.max(0, pet.energy - 15);
                    gameState.resources.money += 2;
                    break;
                case 'study':
                    pet.growth += 15;
                    pet.energy = Math.max(0, pet.energy - 20);
                    gameState.resources.money += 3;
                    break;
                case 'meditate':
                    pet.health = Math.min(pet.maxHealth, pet.health + 20);
                    pet.energy = Math.min(pet.maxEnergy, pet.energy + 10);
                    break;
                case 'rest':
                    pet.energy = Math.min(pet.maxEnergy, pet.energy + 40);
                    break;
            }
            
            pet.lastAction = action;
            return true;
        }

        // Render screens
        function renderScreen(screen) {
            gameState.currentScreen = screen;
            const container = document.getElementById('game-container');
            container.innerHTML = '';
            
            switch (screen) {
                case 'menu':
                    renderMenu(container);
                    break;
                case 'game':
                    renderGame(container);
                    break;
                case 'pets':
                    renderPetsList(container);
                    break;
                case 'stats':
                    renderStats(container);
                    break;
                case 'settings':
                    renderSettings(container);
                    break;
            }
        }

        // Render menu screen
        function renderMenu(container) {
            const title = document.createElement('h1');
            title.textContent = 'Evolution Tamagotchi';
            container.appendChild(title);
            
            const menu = document.createElement('div');
            menu.className = 'menu';
            
            if (gameState.pets.length > 0) {
                const continueBtn = document.createElement('button');
                continueBtn.textContent = 'Continue Game';
                continueBtn.onclick = () => renderScreen('game');
                menu.appendChild(continueBtn);
            }
            
            const newGameBtn = document.createElement('button');
            newGameBtn.textContent = 'New Game';
            newGameBtn.onclick = () => {
                gameState.pets = [];
                gameState.resources = { food: 10, energy: 100, money: 0 };
                createPet();
                renderScreen('game');
            };
            menu.appendChild(newGameBtn);
            
            const petsBtn = document.createElement('button');
            petsBtn.textContent = 'My Pets';
            petsBtn.onclick = () => renderScreen('pets');
            menu.appendChild(petsBtn);
            
            const statsBtn = document.createElement('button');
            statsBtn.textContent = 'Statistics';
            statsBtn.onclick = () => renderScreen('stats');
            menu.appendChild(statsBtn);
            
            const settingsBtn = document.createElement('button');
            settingsBtn.textContent = 'Settings';
            settingsBtn.onclick = () => renderScreen('settings');
            menu.appendChild(settingsBtn);
            
            container.appendChild(menu);
        }

        // Render game screen
        function renderGame(container) {
            if (gameState.pets.length === 0) {
                createPet();
            }
            
            const pet = gameState.pets[0]; // For simplicity, work with the first pet
            
            const header = document.createElement('div');
            header.innerHTML = `
                <h2>${pet.name}</h2>
                <div>Level: ${pet.type.toUpperCase()}</div>
            `;
            container.appendChild(header);
            
            const petContainer = document.createElement('div');
            petContainer.className = 'pet-container';
            
            // Pet status
            const petStatus = document.createElement('div');
            petStatus.className = 'pet-stats';
            petStatus.innerHTML = `
                <div>
                    <div>Health: ${Math.round(pet.health)}/${pet.maxHealth}</div>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${(pet.health / pet.maxHealth) * 100}%; background-color: #f44336;">${Math.round((pet.health / pet.maxHealth) * 100)}%</div>
                    </div>
                </div>
                <div>
                    <div>Hunger: ${Math.round(pet.hunger)}/${pet.maxHunger}</div>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${(pet.hunger / pet.maxHunger) * 100}%; background-color: #ff9800;">${Math.round((pet.hunger / pet.maxHunger) * 100)}%</div>
                    </div>
                </div>
                <div>
                    <div>Energy: ${Math.round(pet.energy)}/${pet.maxEnergy}</div>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${(pet.energy / pet.maxEnergy) * 100}%; background-color: #2196F3;">${Math.round((pet.energy / pet.maxEnergy) * 100)}%</div>
                    </div>
                </div>
                <div>
                    <div>Growth: ${Math.round(pet.growth)}/${pet.evolutionThreshold}</div>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${(pet.growth / pet.evolutionThreshold) * 100}%; background-color: #4CAF50;">${Math.round((pet.growth / pet.evolutionThreshold) * 100)}%</div>
                    </div>
                </div>
                ${pet.nextStage ? `<div>Next evolution: ${petTypes[pet.nextStage].name}</div>` : '<div>Max evolution reached</div>'}
                ${pet.lastAction ? `<div>Last action: ${pet.lastAction}</div>` : ''}
            `;
            petContainer.appendChild(petStatus);
            container.appendChild(petContainer);
            
            // Resources display
            const resources = document.createElement('div');
            resources.className = 'pet-stats';
            resources.innerHTML = `
                <h3>Resources</h3>
                <div>Food: ${Math.round(gameState.resources.food)}</div>
                <div>Energy: ${Math.round(gameState.resources.energy)}/100</div>
                <div>Money: ${Math.round(gameState.resources.money)}</div>
            `;
            container.appendChild(resources);
            
            // Actions
            const actionsTitle = document.createElement('h3');
            actionsTitle.textContent = 'Actions';
            container.appendChild(actionsTitle);
            
            const actions = document.createElement('div');
            actions.className = 'actions';
            
            pet.actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = 'action-button';
                btn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
                btn.onclick = () => {
                    if (performAction(pet, action)) {
                        renderScreen('game');
                    } else {
                        alert('Not enough resources for this action!');
                    }
                };
                actions.appendChild(btn);
            });
            
            container.appendChild(actions);
            
            // Back button
            const backBtn = document.createElement('button');
            backBtn.className = 'menu button back-button';
            backBtn.textContent = 'Back to Menu';
            backBtn.onclick = () => renderScreen('menu');
            container.appendChild(backBtn);
        }

        // Render pets list
        function renderPetsList(container) {
            const title = document.createElement('h1');
            title.textContent = 'My Pets';
            container.appendChild(title);
            
            if (gameState.pets.length === 0) {
                const noPets = document.createElement('p');
                noPets.textContent = 'You have no pets yet. Start a new game!';
                container.appendChild(noPets);
            } else {
                const petsGrid = document.createElement('div');
                petsGrid.className = 'pets-grid';
                
                gameState.pets.forEach(pet => {
                    const petCard = document.createElement('div');
                    petCard.className = 'pet-card';
                    petCard.innerHTML = `
                        <h3>${pet.name}</h3>
                        <div>Type: ${pet.type}</div>
                        <div>Health: ${Math.round(pet.health)}/${pet.maxHealth}</div>
                        <div>Growth: ${Math.round(pet.growth)}/${pet.evolutionThreshold}</div>
                    `;
                    petsGrid.appendChild(petCard);
                });
                
                container.appendChild(petsGrid);
            }
            
            const backBtn = document.createElement('button');
            backBtn.className = 'menu button back-button';
            backBtn.textContent = 'Back to Menu';
            backBtn.onclick = () => renderScreen('menu');
            container.appendChild(backBtn);
        }

        // Render statistics
        function renderStats(container) {
            const title = document.createElement('h1');
            title.textContent = 'Game Statistics';
            container.appendChild(title);
            
            const stats = document.createElement('div');
            stats.className = 'pet-stats';
            
            const playTime = new Date(gameState.gameTime * 1000).toISOString().substr(11, 8);
            const petsCreated = gameState.pets.length;
            const maxEvolution = gameState.pets.reduce((max, pet) => {
                const evolutionOrder = ['basic', 'advanced', 'complex', 'final'];
                return Math.max(max, evolutionOrder.indexOf(pet.type));
            }, 0);
            
            stats.innerHTML = `
                <div>Total play time: ${playTime}</div>
                <div>Pets created: ${petsCreated}</div>
                <div>Highest evolution: ${maxEvolution >= 0 ? petTypes[Object.keys(petTypes)[maxEvolution]].name : 'None'}</div>
                <div>Current money: ${Math.round(gameState.resources.money)}</div>
            `;
            
            container.appendChild(stats);
            
            const backBtn = document.createElement('button');
            backBtn.className = 'menu button back-button';
            backBtn.textContent = 'Back to Menu';
            backBtn.onclick = () => renderScreen('menu');
            container.appendChild(backBtn);
        }

        // Render settings
        function renderSettings(container) {
            const title = document.createElement('h1');
            title.textContent = 'Settings';
            container.appendChild(title);
            
            const settings = document.createElement('div');
            settings.className = 'pet-stats';
            
            const volumeLabel = document.createElement('label');
            volumeLabel.textContent = 'Volume: ';
            volumeLabel.style.marginRight = '10px';
            
            const volumeInput = document.createElement('input');
            volumeInput.type = 'range';
            volumeInput.min = '0';
            volumeInput.max = '1';
            volumeInput.step = '0.1';
            volumeInput.value = gameState.settings.volume;
            volumeInput.onchange = (e) => {
                gameState.settings.volume = parseFloat(e.target.value);
                saveGame();
            };
            
            volumeLabel.appendChild(volumeInput);
            settings.appendChild(volumeLabel);
            
            const saveLabel = document.createElement('div');
            saveLabel.style.marginTop = '10px';
            saveLabel.textContent = 'Game saves automatically';
            settings.appendChild(saveLabel);
            
            container.appendChild(settings);
            
            const backBtn = document.createElement('button');
            backBtn.className = 'menu button back-button';
            backBtn.textContent = 'Back to Menu';
            backBtn.onclick = () => renderScreen('menu');
            container.appendChild(backBtn);
        }

        // Save game to localStorage
        function saveGame() {
            localStorage.setItem('evolutionTamagotchi', JSON.stringify(gameState));
        }

        // Load game from localStorage
        function loadGame() {
            const savedGame = localStorage.getItem('evolutionTamagotchi');
            if (savedGame) {
                const parsed = JSON.parse(savedGame);
                Object.assign(gameState, parsed);
                
                // Ensure we have at least the basic structure
                if (!gameState.pets) gameState.pets = [];
                if (!gameState.resources) gameState.resources = { food: 10, energy: 100, money: 0 };
                if (!gameState.settings) gameState.settings = { volume: 0.5 };
            }
        }

        // Initialize the game when the page loads
        window.onload = initGame;
    </script>
</body>
</html>