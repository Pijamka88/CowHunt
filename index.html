<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarCows</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            touch-action: none;
            font-family: 'Courier New', monospace;
            color: #0ff;
        }

        #gameCanvas {
            border: 2px solid #0ff;
            box-shadow: 0 0 15px #0ff;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: radial-gradient(circle, #001122 0%, #000 100%);
        }

        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .title {
            font-size: 3em;
            text-shadow: 0 0 10px #0ff;
            margin-bottom: 2em;
            animation: glow 2s infinite;
        }

        .btn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.5em;
            background: transparent;
            border: 2px solid #0ff;
            color: #0ff;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn:hover {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 15px #0ff;
        }

        .hud {
            position: absolute;
            width: 100%;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.7);
        }

        #topHUD {
            top: 0;
            font-size: 1.5em;
        }

        #bottomHUD {
            bottom: 0;
            font-size: 1.2em;
            justify-content: space-around;
        }

        .hearts {
            display: flex;
            gap: 5px;
        }

        .heart {
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="%23ff3366" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>');
        }

        .crosshair {
            position: absolute;
            width: 40px;
            height: 40px;
            pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="none" stroke="%230ff" stroke-width="4" stroke-dasharray="10 5"/><line x1="50" y1="10" x2="50" y2="30" stroke="%230ff" stroke-width="4"/><line x1="50" y1="70" x2="50" y2="90" stroke="%230ff" stroke-width="4"/><line x1="10" y1="50" x2="30" y2="50" stroke="%230ff" stroke-width="4"/><line x1="70" y1="50" x2="90" y2="50" stroke="%230ff" stroke-width="4"/></svg>');
        }

        #reloading {
            display: none;
            position: absolute;
            color: #f00;
            font-size: 1.5em;
            text-shadow: 0 0 10px #f00;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #0ff; }
            50% { text-shadow: 0 0 20px #0ff, 0 0 30px #0ff; }
        }
    </style>
</head>
<body>
    <div id="mainMenu" class="screen main-menu">
        <h1 class="title">STARCOWS</h1>
        <button class="btn" onclick="showScreen('game')">Start Mission</button>
        <button class="btn" onclick="showScreen('howToPlay')">How To Play</button>
        <button class="btn" onclick="showScreen('highscores')">High Scores</button>
    </div>

    <div id="howToPlay" class="screen">
        <div class="hud">
            <button class="btn" onclick="showScreen('mainMenu')">Back</button>
        </div>
        <div style="padding: 20px; max-width: 600px; margin: auto;">
            <h2>Mission Briefing</h2>
            <p>- 60 seconds to complete</p>
            <p>- 5 shots before reload</p>
            <p>- 3 hull integrity points</p>
            <p>- Destroy anomalous space cows</p>
            <p>- [R] to reload weapons</p>
        </div>
    </div>

    <div id="highscores" class="screen">
        <div class="hud">
            <button class="btn" onclick="showScreen('mainMenu')">Back</button>
        </div>
        <div id="leaderboard" style="padding: 20px;"></div>
    </div>

    <div id="game" class="screen">
        <canvas id="gameCanvas"></canvas>
        <div id="topHUD" class="hud">
            <span>SCORE: <span id="score">0</span></span>
            <span>TIME: <span id="timer">60</span></span>
        </div>
        <div id="bottomHUD" class="hud">
            <span>AMMO: <span id="ammo">5</span></span>
            <span>HITS: <span id="hits">0</span></span>
            <span>MISS: <span id="miss">0</span></span>
            <div class="hearts" id="hearts">
                <div class="heart"></div>
                <div class="heart"></div>
                <div class="heart"></div>
            </div>
        </div>
        <div id="reloading">RELOADING...</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const screens = document.querySelectorAll('.screen');
        let gameState = {
            targets: [],
            score: 0,
            ammo: 5,
            hits: 0,
            miss: 0,
            lives: 3,
            isPlaying: false,
            reloading: false,
            timeLeft: 60,
            crosshair: { x: 0, y: 0 },
            patterns: [
                (t) => ({ x: t*2, y: Math.sin(t/10)*50 }),
                (t) => ({ x: t*1.5, y: t % 100 < 50 ? 20 : -20 }),
                (t) => ({ x: Math.sin(t/15)*50 + t*1.2, y: Math.cos(t/15)*50 })
            ]
        };

        // Leaderboard
        let leaderboard = JSON.parse(localStorage.getItem('starCowsLeaderboard') || [];

        // Canvas setup
        function resizeCanvas() {
            canvas.width = Math.min(window.innerWidth, 800);
            canvas.height = Math.min(window.innerHeight, 600);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Crosshair
        const crosshair = document.createElement('div');
        crosshair.className = 'crosshair';
        document.body.appendChild(crosshair);

        // Input handling
        function updateCrosshair(x, y) {
            gameState.crosshair.x = x;
            gameState.crosshair.y = y;
            crosshair.style.transform = `translate(${x-20}px, ${y-20}px)`;
        }

        canvas.addEventListener('mousemove', e => updateCrosshair(e.clientX, e.clientY));
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            updateCrosshair(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

        // Game functions
        function createTarget() {
            return {
                x: -100,
                y: Math.random() * (canvas.height - 100),
                type: Math.floor(Math.random() * 3),
                t: 0,
                speed: Math.random() * 2 + 1,
                alive: true
            };
        }

        function checkCollision(target) {
            const rect = canvas.getBoundingClientRect();
            const cx = gameState.crosshair.x - rect.left;
            const cy = gameState.crosshair.y - rect.top;
            return cx > target.x && cx < target.x + 80 &&
                   cy > target.y && cy < target.y + 60;
        }

        function drawCow(target) {
            ctx.save();
            ctx.translate(target.x, target.y);
            
            // Body
            ctx.fillStyle = target.alive ? '#8B4513' : '#555';
            ctx.fillRect(10, 20, 60, 30);
            
            // Head
            ctx.beginPath();
            ctx.arc(70, 35, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Legs
            ctx.fillRect(20, 50, 10, 20);
            ctx.fillRect(50, 50, 10, 20);
            
            // Wings
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(20, 30);
            ctx.lineTo(0, 10);
            ctx.moveTo(60, 30);
            ctx.lineTo(80, 10);
            ctx.stroke();
            
            ctx.restore();
        }

        function gameLoop() {
            if (!gameState.isPlaying) return;

            // Update targets
            gameState.targets = gameState.targets.filter(target => {
                if (!target.alive) return false;
                target.t += 0.1;
                const pattern = gameState.patterns[target.type](target.t);
                target.x = pattern.x * target.speed;
                target.y += pattern.y;
                return target.x < canvas.width + 100;
            });

            // Spawn new targets
            if (Math.random() < 0.03) {
                gameState.targets.push(createTarget());
            }

            // Draw
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars
            ctx.fillStyle = '#fff';
            for(let i = 0; i < 100; i++) {
                ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 2, 2);
            }

            gameState.targets.forEach(drawCow);

            requestAnimationFrame(gameLoop);
        }

        // Shooting logic
        function handleShoot() {
            if (!gameState.isPlaying || gameState.reloading || gameState.ammo <= 0) return;

            gameState.ammo--;
            let hit = false;
            
            gameState.targets.forEach(target => {
                if (checkCollision(target) && target.alive) {
                    target.alive = false;
                    gameState.score += 100;
                    gameState.hits++;
                    hit = true;
                }
            });

            if (!hit) gameState.miss++;
            updateHUD();
            
            if (gameState.ammo <= 0) reload();
        }

        // Reload logic
        function reload() {
            if (gameState.reloading) return;
            
            gameState.reloading = true;
            document.getElementById('reloading').style.display = 'block';
            setTimeout(() => {
                gameState.ammo = 5;
                gameState.reloading = false;
                document.getElementById('reloading').style.display = 'none';
                updateHUD();
            }, 2000);
        }

        function updateHUD() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('ammo').textContent = gameState.ammo;
            document.getElementById('hits').textContent = gameState.hits;
            document.getElementById('miss').textContent = gameState.miss;
            document.getElementById('hearts').innerHTML = 
                Array(gameState.lives).fill('<div class="heart"></div>').join('');
        }

        // Game control
        function startGame() {
            gameState = {
                targets: [],
                score: 0,
                ammo: 5,
                hits: 0,
                miss: 0,
                lives: 3,
                isPlaying: true,
                reloading: false,
                timeLeft: 60,
                crosshair: { x: 0, y: 0 },
                patterns: gameState.patterns
            };

            const timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(timer);
                    endGame();
                }
            }, 1000);

            updateHUD();
            gameLoop();
        }

        function endGame() {
            gameState.isPlaying = false;
            const name = prompt('Mission Failed! Enter your callsign:', 'COWBOY');
            if (name) {
                leaderboard.push({ name, score: gameState.score });
                leaderboard.sort((a, b) => b.score - a.score);
                leaderboard = leaderboard.slice(0, 5);
                localStorage.setItem('starCowsLeaderboard', JSON.stringify(leaderboard));
            }
            showScreen('mainMenu');
        }

        // UI functions
        function showScreen(id) {
            screens.forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
            if (id === 'game') startGame();
            if (id === 'highscores') {
                document.getElementById('leaderboard').innerHTML = leaderboard
                    .map((e, i) => `<div>${i+1}. ${e.name} - ${e.score}</div>`)
                    .join('');
            }
        }

        // Event listeners
        canvas.addEventListener('mousedown', handleShoot);
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            handleShoot();
        });
        document.addEventListener('keydown', e => e.key === 'r' && reload());

        // Init
        showScreen('mainMenu');
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>