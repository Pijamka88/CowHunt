<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Cow Hunt</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #1a1a2e;
            touch-action: none;
            font-family: 'Arial', sans-serif;
            color: white;
        }

        .screen {
            display: none;
            position: absolute;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #mainMenu {
            display: flex;
            background: linear-gradient(45deg, #0f0c29, #302b63);
        }

        #gameScreen {
            background: linear-gradient(45deg, #0f0c29, #302b63);
        }

        .menu-btn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2em;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .menu-btn:hover {
            transform: scale(1.1);
        }

        #gameCanvas {
            border: 2px solid #4CAF50;
            margin-top: 20px;
        }

        .hud {
            position: absolute;
            display: flex;
            justify-content: space-between;
            width: 95%;
            padding: 10px;
            font-size: 1.2em;
        }

        #topHud {
            top: 10px;
        }

        #bottomHud {
            bottom: 10px;
        }

        .hearts {
            display: flex;
            gap: 5px;
        }

        .heart {
            color: #ff3366;
            font-size: 1.5em;
        }

        #leaderboard {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            max-height: 70vh;
            overflow-y: auto;
        }

        #howToPlay {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
        }

        .crosshair {
            position: absolute;
            width: 40px;
            height: 40px;
            pointer-events: none;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" stroke="%234CAF50" stroke-width="4" fill="none"/><line x1="50" y1="10" x2="50" y2="30" stroke="%234CAF50" stroke-width="4"/><line x1="50" y1="70" x2="50" y2="90" stroke="%234CAF50" stroke-width="4"/><line x1="10" y1="50" x2="30" y2="50" stroke="%234CAF50" stroke-width="4"/><line x1="70" y1="50" x2="90" y2="50" stroke="%234CAF50" stroke-width="4"/></svg>');
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="mainMenu" class="screen">
        <h1>Space Cow Hunt</h1>
        <button class="menu-btn" onclick="showScreen('gameScreen')">Start Game</button>
        <button class="menu-btn" onclick="showScreen('howToPlay')">How to Play</button>
        <button class="menu-btn" onclick="showScreen('leaderboard')">High Scores</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="hud" id="topHud">
            <div>Score: <span id="score">0</span></div>
            <div>Time: <span id="timer">60</span>s</div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="hud" id="bottomHud">
            <div class="hearts">
                <span class="heart">♥</span>
                <span class="heart">♥</span>
                <span class="heart">♥</span>
            </div>
            <div>Ammo: <span id="ammo">5</span></div>
            <div>Hits: <span id="hits">0</span></div>
        </div>
    </div>

    <!-- How to Play -->
    <div id="howToPlay" class="screen">
        <div id="howToPlayContent">
            <h2>How to Play</h2>
            <p>Shoot space cows in 60 seconds!</p>
            <p>- Tap to shoot (5 shots before reload)</p>
            <p>- Avoid hitting friendly cows</p>
            <p>- Collect power-ups for bonuses</p>
            <button class="menu-btn" onclick="showScreen('mainMenu')">Back</button>
        </div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="screen">
        <h2>Top 5 Scores</h2>
        <div id="scoresList"></div>
        <button class="menu-btn" onclick="showScreen('mainMenu')">Back</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameState = null;
        const COW_TYPES = [
            { color: '#FF69B4', score: 100, speed: 2 },
            { color: '#00FF00', score: 200, speed: 3 },
            { color: '#FF0000', score: 300, speed: 4 }
        ];

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'flex';
            if(screenId === 'gameScreen') startGame();
        }

        // Game initialization
        function resizeCanvas() {
            canvas.width = Math.min(window.innerWidth - 20, 800);
            canvas.height = Math.min(window.innerHeight - 100, 600);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Crosshair
        const crosshair = document.createElement('div');
        crosshair.className = 'crosshair';
        document.body.appendChild(crosshair);

        // Input handling
        function updateCrosshair(e) {
            const x = e.clientX || e.touches[0].clientX;
            const y = e.clientY || e.touches[0].clientY;
            crosshair.style.transform = `translate(${x - 20}px, ${y - 20}px)`;
            gameState.crosshair = { x, y };
        }

        canvas.addEventListener('mousemove', updateCrosshair);
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            updateCrosshair(e);
        }, { passive: false });

        // Game functions
        function createCow() {
            const type = COW_TYPES[Math.floor(Math.random() * COW_TYPES.length)];
            return {
                x: Math.random() < 0.5 ? -50 : canvas.width + 50,
                y: Math.random() * (canvas.height - 50),
                speed: type.speed,
                direction: Math.random() < 0.5 ? 1 : -1,
                type: type,
                width: 50,
                height: 30,
                active: true,
                angle: 0
            };
        }

        function drawCow(cow) {
            ctx.save();
            ctx.translate(cow.x + 25, cow.y + 15);
            ctx.rotate(cow.angle);
            
            // Body
            ctx.fillStyle = cow.type.color;
            ctx.fillRect(-20, -10, 40, 20);
            
            // Head
            ctx.beginPath();
            ctx.arc(15, 0, 10, 0, Math.PI * 2);
            ctx.fill();
            
            // Legs
            ctx.fillRect(-15, 10, 5, 15);
            ctx.fillRect(5, 10, 5, 15);
            
            // Wings
            ctx.beginPath();
            ctx.moveTo(-20, -10);
            ctx.lineTo(-30, -20);
            ctx.lineTo(-20, -15);
            ctx.fill();
            
            ctx.restore();
        }

        function checkCollision(cow) {
            const rect = canvas.getBoundingClientRect();
            const x = gameState.crosshair.x - rect.left;
            const y = gameState.crosshair.y - rect.top;
            return x > cow.x && x < cow.x + cow.width &&
                   y > cow.y && y < cow.y + cow.height;
        }

        // Game loop
        function gameLoop(timestamp) {
            if (!gameState.isPlaying) return;

            // Update game state
            const deltaTime = timestamp - gameState.lastFrame;
            gameState.lastFrame = timestamp;
            gameState.timeLeft -= deltaTime;

            // Spawn cows
            if (timestamp - gameState.lastSpawn > 1000) {
                gameState.cows.push(createCow());
                gameState.lastSpawn = timestamp;
            }

            // Update cows
            gameState.cows = gameState.cows.filter(cow => {
                cow.x += cow.speed * cow.direction;
                cow.y += Math.sin(cow.angle) * 2;
                cow.angle += 0.1;
                return cow.active && cow.x > -100 && cow.x < canvas.width + 100;
            });

            // Update HUD
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('ammo').textContent = gameState.reloading ? 'Reloading' : gameState.ammo;
            document.getElementById('timer').textContent = Math.ceil(gameState.timeLeft / 1000);
            document.getElementById('hits').textContent = `${gameState.hits}/${gameState.shots}`;
            document.querySelectorAll('.heart').forEach((h, i) => 
                h.style.color = i < gameState.lives ? '#ff3366' : '#444');

            // Check game over
            if (gameState.timeLeft <= 0 || gameState.lives <= 0) {
                endGame();
                return;
            }

            // Draw
            ctx.fillStyle = 'rgba(25,25,112,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            gameState.cows.forEach(drawCow);

            requestAnimationFrame(gameLoop);
        }

        // Game controls
        function startGame() {
            gameState = {
                cows: [],
                score: 0,
                ammo: 5,
                shots: 0,
                hits: 0,
                lives: 3,
                isPlaying: true,
                reloading: false,
                lastFrame: 0,
                lastSpawn: 0,
                timeLeft: 60000,
                crosshair: { x: 0, y: 0 }
            };
            crosshair.style.display = 'block';
            requestAnimationFrame(gameLoop);
        }

        function endGame() {
            gameState.isPlaying = false;
            crosshair.style.display = 'none';
            updateLeaderboard(gameState.score);
            showScreen('leaderboard');
        }

        // Shooting logic
        function handleShoot() {
            if (!gameState || !gameState.isPlaying || gameState.reloading) return;
            
            gameState.shots++;
            gameState.ammo--;
            
            gameState.cows.forEach(cow => {
                if (checkCollision(cow)) {
                    cow.active = false;
                    gameState.score += cow.type.score;
                    gameState.hits++;
                }
            });

            if (gameState.ammo <= 0) {
                gameState.reloading = true;
                setTimeout(() => {
                    gameState.ammo = 5;
                    gameState.reloading = false;
                }, 2000);
            }
        }

        canvas.addEventListener('mousedown', handleShoot);
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            handleShoot();
        }, { passive: false });

        // Leaderboard
        function updateLeaderboard(score) {
            let scores = JSON.parse(localStorage.getItem('scores') || '[]');
            scores.push({ score, date: new Date().toLocaleString() });
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 5);
            localStorage.setItem('scores', JSON.stringify(scores));
            
            const list = document.getElementById('scoresList');
            list.innerHTML = scores.map((s, i) => 
                `<div>${i+1}. ${s.score} - ${s.date}</div>`).join('');
        }

        // Init
        showScreen('mainMenu');
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>