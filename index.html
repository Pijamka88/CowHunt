<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эволюционный Тамагочи</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            padding: 15px;
            box-sizing: border-box;
        }
        
        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #50a8eb;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3a7bb8;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .game-screen {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        .pet-info {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            background-color: #4caf50;
            width: 100%;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .evolution-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .pets-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .pet-card {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .pet-card h4 {
            margin: 0 0 5px 0;
        }
        
        .pet-card button {
            width: 100%;
            padding: 5px;
            font-size: 14px;
        }
        
        .log {
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-menu">
            <h1>Эволюционный Тамагочи</h1>
            <div class="menu">
                <button id="new-game-btn">Новая игра</button>
                <button id="continue-game-btn">Продолжить</button>
                <button id="about-btn">О игре</button>
            </div>
        </div>
        
        <div id="game-screen" class="game-screen">
            <div class="pet-info">
                <h2 id="pet-name">Питомец</h2>
                <p>Уровень: <span id="pet-level">1</span></p>
                <p>Опыт: <span id="pet-exp">0</span>/<span id="pet-exp-to-next">100</span></p>
                <p>Тип: <span id="pet-type">Обычный</span></p>
                
                <div class="stats">
                    <div class="stat">
                        <span>Голод</span>
                        <div class="stat-bar">
                            <div id="hunger-bar" class="stat-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <span>Энергия</span>
                        <div class="stat-bar">
                            <div id="energy-bar" class="stat-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <span>Счастье</span>
                        <div class="stat-bar">
                            <div id="happiness-bar" class="stat-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <span>Здоровье</span>
                        <div class="stat-bar">
                            <div id="health-bar" class="stat-fill" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="evolution-info" id="evolution-info">
                    До следующей эволюции: уровень 5
                </div>
            </div>
            
            <div class="actions">
                <button id="feed-btn">Покормить</button>
                <button id="play-btn">Поиграть</button>
                <button id="sleep-btn">Уложить спать</button>
                <button id="heal-btn">Лечить</button>
                <button id="train-btn">Тренировать</button>
                <button id="evolve-btn" disabled>Эволюционировать</button>
            </div>
            
            <div id="pets-container" class="pets-container" style="display: none;">
                <h3>Ваши питомцы</h3>
                <div id="pets-list"></div>
            </div>
            
            <div class="log">
                <h3>Журнал событий</h3>
                <div id="log-entries"></div>
            </div>
            
            <button id="back-to-menu-btn">В главное меню</button>
        </div>
        
        <div id="about-screen" class="game-screen" style="display: none;">
            <h2>О игре</h2>
            <p>Эволюционный Тамагочи - это игра, где вы заботитесь о питомце, который со временем эволюционирует и размножается.</p>
            <p>Особенности:</p>
            <ul>
                <li>Питомец развивается и эволюционирует</li>
                <li>После достижения определенного уровня питомец может разделиться</li>
                <li>Управляйте несколькими питомцами одновременно</li>
                <li>Разные типы питомцев с уникальными характеристиками</li>
            </ul>
            <button id="back-from-about-btn">Назад</button>
        </div>
    </div>

    <script>
        // Игровые константы
        const PET_TYPES = {
            NORMAL: { name: 'Обычный', maxHealth: 100, evolutionLevel: 5 },
            STRONG: { name: 'Сильный', maxHealth: 150, evolutionLevel: 10 },
            SMART: { name: 'Умный', maxHealth: 120, evolutionLevel: 8 },
            MAGIC: { name: 'Магический', maxHealth: 130, evolutionLevel: 12 },
            ULTIMATE: { name: 'Совершенный', maxHealth: 200, evolutionLevel: null }
        };
        
        const EVOLUTION_CHAIN = [
            PET_TYPES.NORMAL,
            PET_TYPES.STRONG,
            PET_TYPES.SMART,
            PET_TYPES.MAGIC,
            PET_TYPES.ULTIMATE
        ];
        
        // Игровые переменные
        let gameState = {
            pets: [],
            currentPetIndex: 0,
            gameTime: 0,
            log: []
        };
        
        // DOM элементы
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const aboutScreen = document.getElementById('about-screen');
        const newGameBtn = document.getElementById('new-game-btn');
        const continueGameBtn = document.getElementById('continue-game-btn');
        const aboutBtn = document.getElementById('about-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const backFromAboutBtn = document.getElementById('back-from-about-btn');
        
        // Инициализация Telegram Web App
        let tg = window.Telegram.WebApp;
        
        // Инициализация игры
        function initGame() {
            loadGame();
            setupEventListeners();
            
            if (gameState.pets.length > 0) {
                continueGameBtn.disabled = false;
            } else {
                continueGameBtn.disabled = true;
            }
            
            tg.expand();
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            newGameBtn.addEventListener('click', startNewGame);
            continueGameBtn.addEventListener('click', continueGame);
            aboutBtn.addEventListener('click', showAbout);
            backToMenuBtn.addEventListener('click', showMainMenu);
            backFromAboutBtn.addEventListener('click', showMainMenu);
            
            document.getElementById('feed-btn').addEventListener('click', () => performAction('feed'));
            document.getElementById('play-btn').addEventListener('click', () => performAction('play'));
            document.getElementById('sleep-btn').addEventListener('click', () => performAction('sleep'));
            document.getElementById('heal-btn').addEventListener('click', () => performAction('heal'));
            document.getElementById('train-btn').addEventListener('click', () => performAction('train'));
            document.getElementById('evolve-btn').addEventListener('click', evolvePet);
        }
        
        // Загрузка игры из localStorage
        function loadGame() {
            const savedGame = localStorage.getItem('evolutionTamagotchi');
            if (savedGame) {
                gameState = JSON.parse(savedGame);
                
                // Восстановление объектов питомцев (потерянных при сериализации)
                gameState.pets = gameState.pets.map(pet => {
                    return {
                        ...pet,
                        type: PET_TYPES[pet.typeName] || PET_TYPES.NORMAL
                    };
                });
            }
        }
        
        // Сохранение игры в localStorage
        function saveGame() {
            // Преобразуем объекты типов в строки для сериализации
            const petsToSave = gameState.pets.map(pet => {
                return {
                    ...pet,
                    typeName: pet.type.name.toUpperCase(),
                    type: undefined // Удаляем объект типа
                };
            });
            
            const gameStateToSave = {
                ...gameState,
                pets: petsToSave
            };
            
            localStorage.setItem('evolutionTamagotchi', JSON.stringify(gameStateToSave));
        }
        
        // Начало новой игры
        function startNewGame() {
            const defaultName = tg.initDataUnsafe.user?.first_name ? 
                `Тамагочи ${tg.initDataUnsafe.user.first_name}` : 'Мой Тамагочи';
            
            gameState = {
                pets: [createNewPet(defaultName)],
                currentPetIndex: 0,
                gameTime: 0,
                log: [`Создан новый питомец: ${defaultName}`]
            };
            
            saveGame();
            showGameScreen();
            updateGameUI();
        }
        
        // Создание нового питомца
        function createNewPet(name) {
            return {
                name: name,
                level: 1,
                exp: 0,
                expToNext: 100,
                type: PET_TYPES.NORMAL,
                hunger: 100,
                energy: 100,
                happiness: 100,
                health: 100,
                lastActionTime: Date.now(),
                canEvolve: false
            };
        }
        
        // Продолжение игры
        function continueGame() {
            if (gameState.pets.length > 0) {
                // Обновляем состояние питомцев после загрузки
                const now = Date.now();
                gameState.pets.forEach(pet => {
                    const timePassed = now - pet.lastActionTime;
                    updatePetStatsOverTime(pet, timePassed);
                    pet.lastActionTime = now;
                });
                
                showGameScreen();
                updateGameUI();
            }
        }
        
        // Показать главное меню
        function showMainMenu() {
            mainMenu.style.display = 'block';
            gameScreen.style.display = 'none';
            aboutScreen.style.display = 'none';
        }
        
        // Показать экран игры
        function showGameScreen() {
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'flex';
            aboutScreen.style.display = 'none';
            
            if (gameState.pets.length > 1) {
                document.getElementById('pets-container').style.display = 'block';
                updatePetsList();
            } else {
                document.getElementById('pets-container').style.display = 'none';
            }
        }
        
        // Показать экран "О игре"
        function showAbout() {
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'none';
            aboutScreen.style.display = 'block';
        }
        
        // Обновление интерфейса игры
        function updateGameUI() {
            const pet = getCurrentPet();
            
            document.getElementById('pet-name').textContent = pet.name;
            document.getElementById('pet-level').textContent = pet.level;
            document.getElementById('pet-exp').textContent = pet.exp;
            document.getElementById('pet-exp-to-next').textContent = pet.expToNext;
            document.getElementById('pet-type').textContent = pet.type.name;
            
            document.getElementById('hunger-bar').style.width = `${pet.hunger}%`;
            document.getElementById('energy-bar').style.width = `${pet.energy}%`;
            document.getElementById('happiness-bar').style.width = `${pet.happiness}%`;
            document.getElementById('health-bar').style.width = `${pet.health}%`;
            
            // Кнопка эволюции
            const evolveBtn = document.getElementById('evolve-btn');
            evolveBtn.disabled = !pet.canEvolve;
            
            // Информация об эволюции
            const evolutionInfo = document.getElementById('evolution-info');
            if (pet.type === PET_TYPES.ULTIMATE) {
                evolutionInfo.textContent = 'Ваш питомец достиг максимальной эволюции!';
            } else {
                const nextTypeIndex = EVOLUTION_CHAIN.findIndex(t => t === pet.type) + 1;
                if (nextTypeIndex < EVOLUTION_CHAIN.length) {
                    const nextType = EVOLUTION_CHAIN[nextTypeIndex];
                    evolutionInfo.textContent = `До следующей эволюции (${nextType.name}): уровень ${nextType.evolutionLevel}`;
                }
            }
            
            // Обновление журнала
            updateLog();
        }
        
        // Обновление списка питомцев
        function updatePetsList() {
            const petsList = document.getElementById('pets-list');
            petsList.innerHTML = '';
            
            gameState.pets.forEach((pet, index) => {
                const petCard = document.createElement('div');
                petCard.className = 'pet-card';
                
                petCard.innerHTML = `
                    <h4>${pet.name}</h4>
                    <p>Ур. ${pet.level} ${pet.type.name}</p>
                    <p>Здоровье: ${Math.round(pet.health)}%</p>
                    <button class="select-pet-btn" data-index="${index}">Выбрать</button>
                `;
                
                petsList.appendChild(petCard);
            });
            
            // Добавляем обработчики для кнопок выбора
            document.querySelectorAll('.select-pet-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    gameState.currentPetIndex = parseInt(this.getAttribute('data-index'));
                    updateGameUI();
                });
            });
        }
        
        // Обновление журнала событий
        function updateLog() {
            const logEntries = document.getElementById('log-entries');
            logEntries.innerHTML = '';
            
            gameState.log.slice().reverse().forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = entry;
                logEntries.appendChild(logEntry);
            });
        }
        
        // Добавление записи в журнал
        function addLogEntry(message) {
            gameState.log.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            if (gameState.log.length > 50) {
                gameState.log.shift();
            }
            updateLog();
        }
        
        // Получение текущего питомца
        function getCurrentPet() {
            return gameState.pets[gameState.currentPetIndex];
        }
        
        // Выполнение действия
        function performAction(action) {
            const pet = getCurrentPet();
            const now = Date.now();
            const timePassed = now - pet.lastActionTime;
            
            // Обновляем статистику за прошедшее время
            updatePetStatsOverTime(pet, timePassed);
            
            // Выполняем действие
            let message = '';
            
            switch (action) {
                case 'feed':
                    if (pet.hunger >= 100) {
                        message = `${pet.name} не хочет есть.`;
                    } else {
                        pet.hunger = Math.min(100, pet.hunger + 30);
                        pet.energy = Math.max(0, pet.energy - 5);
                        message = `Вы покормили ${pet.name}.`;
                    }
                    break;
                    
                case 'play':
                    if (pet.energy <= 10) {
                        message = `${pet.name} слишком устал для игр.`;
                    } else {
                        pet.happiness = Math.min(100, pet.happiness + 25);
                        pet.energy = Math.max(0, pet.energy - 20);
                        pet.hunger = Math.max(0, pet.hunger - 10);
                        message = `Вы поиграли с ${pet.name}.`;
                    }
                    break;
                    
                case 'sleep':
                    pet.energy = Math.min(100, pet.energy + 50);
                    pet.hunger = Math.max(0, pet.hunger - 20);
                    message = `${pet.name} поспал и восстановил силы.`;
                    break;
                    
                case 'heal':
                    if (pet.health >= 100) {
                        message = `${pet.name} полностью здоров!`;
                    } else {
                        pet.health = Math.min(100, pet.health + 30);
                        pet.happiness = Math.min(100, pet.happiness + 10);
                        pet.energy = Math.max(0, pet.energy - 10);
                        message = `Вы полечили ${pet.name}.`;
                    }
                    break;
                    
                case 'train':
                    if (pet.energy <= 15) {
                        message = `${pet.name} слишком устал для тренировки.`;
                    } else {
                        const expGain = 10 + Math.floor(Math.random() * 10);
                        pet.exp += expGain;
                        pet.energy = Math.max(0, pet.energy - 25);
                        pet.hunger = Math.max(0, pet.hunger - 15);
                        message = `Вы потренировали ${pet.name} и получили ${expGain} опыта.`;
                        
                        // Проверка уровня
                        checkLevelUp(pet);
                    }
                    break;
            }
            
            pet.lastActionTime = now;
            addLogEntry(message);
            
            // Проверка на возможность эволюции
            checkEvolution(pet);
            
            // Сохраняем игру и обновляем интерфейс
            saveGame();
            updateGameUI();
        }
        
        // Обновление статистики питомца с течением времени
        function updatePetStatsOverTime(pet, timePassed) {
            // Примерно каждые 5 минут в реальном времени статистика ухудшается
            const minutesPassed = timePassed / (1000 * 60);
            
            if (minutesPassed > 0) {
                pet.hunger = Math.max(0, pet.hunger - minutesPassed * 0.5);
                pet.energy = Math.max(0, pet.energy - minutesPassed * 0.3);
                pet.happiness = Math.max(0, pet.happiness - minutesPassed * 0.2);
                
                // Если показатели слишком низкие, ухудшается здоровье
                if (pet.hunger < 20 || pet.energy < 10 || pet.happiness < 15) {
                    pet.health = Math.max(0, pet.health - minutesPassed * 0.1);
                }
                
                // Если здоровье на нуле, питомец "умирает"
                if (pet.health <= 0) {
                    pet.health = 0;
                    addLogEntry(`⚠️ ${pet.name} в критическом состоянии!`);
                }
            }
        }
        
        // Проверка повышения уровня
        function checkLevelUp(pet) {
            if (pet.exp >= pet.expToNext) {
                pet.level++;
                pet.exp -= pet.expToNext;
                pet.expToNext = Math.floor(pet.expToNext * 1.5);
                
                // Улучшение характеристик
                pet.type.maxHealth += 10;
                pet.health = Math.min(pet.type.maxHealth, pet.health + 20);
                pet.hunger = Math.min(100, pet.hunger + 10);
                pet.energy = Math.min(100, pet.energy + 15);
                pet.happiness = Math.min(100, pet.happiness + 10);
                
                addLogEntry(`🎉 ${pet.name} достиг уровня ${pet.level}!`);
                
                // Проверка на возможность деления
                if (pet.level % 3 === 0 && gameState.pets.length < 5) {
                    const newPet = createNewPet(`${pet.name}-${gameState.pets.length + 1}`);
                    newPet.level = pet.level - 1;
                    newPet.type = pet.type;
                    gameState.pets.push(newPet);
                    
                    addLogEntry(`✨ ${pet.name} разделился и создал нового питомца: ${newPet.name}!`);
                    
                    if (gameState.pets.length > 1) {
                        document.getElementById('pets-container').style.display = 'block';
                        updatePetsList();
                    }
                }
                
                // Проверка на возможность эволюции
                checkEvolution(pet);
            }
        }
        
        // Проверка на возможность эволюции
        function checkEvolution(pet) {
            const currentTypeIndex = EVOLUTION_CHAIN.findIndex(t => t === pet.type);
            
            if (currentTypeIndex < EVOLUTION_CHAIN.length - 1) {
                const nextType = EVOLUTION_CHAIN[currentTypeIndex + 1];
                pet.canEvolve = pet.level >= nextType.evolutionLevel;
            } else {
                pet.canEvolve = false;
            }
        }
        
        // Эволюция питомца
        function evolvePet() {
            const pet = getCurrentPet();
            
            if (pet.canEvolve) {
                const currentTypeIndex = EVOLUTION_CHAIN.findIndex(t => t === pet.type);
                const nextType = EVOLUTION_CHAIN[currentTypeIndex + 1];
                
                pet.type = nextType;
                pet.canEvolve = false;
                
                // Улучшение характеристик при эволюции
                pet.health = nextType.maxHealth;
                pet.hunger = 100;
                pet.energy = 100;
                pet.happiness = 100;
                
                addLogEntry(`🌟 ${pet.name} эволюционировал в ${nextType.name}!`);
                
                saveGame();
                updateGameUI();
            }
        }
        
        // Инициализация игры при загрузке страницы
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>