<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Harvest</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .container {
            max-width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-icon {
            width: 20px;
            height: 20px;
        }
        
        .farm {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .plot {
            aspect-ratio: 1/1;
            background-color: #8BC34A;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .plot-soil {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #5D4037;
            opacity: 0.3;
        }
        
        .crop {
            width: 80%;
            height: 80%;
            object-fit: contain;
            z-index: 2;
            transition: transform 0.2s;
        }
        
        .crop:hover {
            transform: scale(1.1);
        }
        
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(255,255,255,0.3);
            z-index: 3;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #FFEB3B;
            width: 0%;
        }
        
        .shop {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .shop-title {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .shop-item {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .shop-item:hover {
            background-color: #e9e9e9;
        }
        
        .shop-item-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
        }
        
        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .shop-item-price {
            color: #4CAF50;
            font-size: 0.9em;
        }
        
        .upgrades {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .upgrades-title {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        
        .upgrade {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .upgrade:hover {
            background-color: #e9e9e9;
        }
        
        .upgrade-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upgrade-icon {
            width: 30px;
            height: 30px;
        }
        
        .upgrade-price {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-title {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .button-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .button-primary:hover {
            background-color: #3e8e41;
        }
        
        .button-secondary {
            background-color: #f1f1f1;
            color: #333;
        }
        
        .button-secondary:hover {
            background-color: #e1e1e1;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 101;
            animation: notificationFadeInOut 2.5s;
            opacity: 0;
        }
        
        @keyframes notificationFadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        
        .achievement {
            background-color: #FFD700;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .achievement-icon {
            width: 30px;
            height: 30px;
        }
        
        .achievement-locked {
            opacity: 0.5;
            background-color: #f1f1f1;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border-bottom: 2px solid transparent;
        }
        
        .tab-button.active {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Happy Harvest</h1>
            <div class="stats">
                <div class="stat">
                    <img src="https://cdn-icons-png.flaticon.com/512/3132/3132693.png" class="stat-icon" alt="Coins">
                    <span id="coins">0</span>
                </div>
                <div class="stat">
                    <img src="https://cdn-icons-png.flaticon.com/512/3522/3522691.png" class="stat-icon" alt="Level">
                    <span id="level">1</span>
                </div>
                <div class="stat">
                    <img src="https://cdn-icons-png.flaticon.com/512/3522/3522671.png" class="stat-icon" alt="XP">
                    <span id="xp">0</span>/<span id="max-xp">100</span>
                </div>
            </div>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('farm-tab')">Ферма</button>
            <button class="tab-button" onclick="openTab('shop-tab')">Магазин</button>
            <button class="tab-button" onclick="openTab('upgrades-tab')">Улучшения</button>
            <button class="tab-button" onclick="openTab('achievements-tab')">Достижения</button>
        </div>
        
        <div id="farm-tab" class="tab-content active">
            <div class="farm" id="farm">
                <!-- Plots will be generated here -->
            </div>
        </div>
        
        <div id="shop-tab" class="tab-content">
            <div class="shop">
                <h3 class="shop-title">Семена</h3>
                <div class="shop-items" id="seeds-shop">
                    <!-- Seed items will be generated here -->
                </div>
            </div>
        </div>
        
        <div id="upgrades-tab" class="tab-content">
            <div class="upgrades">
                <h3 class="upgrades-title">Улучшения фермы</h3>
                <div id="upgrades-list">
                    <!-- Upgrades will be generated here -->
                </div>
            </div>
        </div>
        
        <div id="achievements-tab" class="tab-content">
            <div class="upgrades">
                <h3 class="upgrades-title">Достижения</h3>
                <div id="achievements-list">
                    <!-- Achievements will be generated here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="harvest-modal">
        <div class="modal-content">
            <h3 class="modal-title">Урожай собран!</h3>
            <p id="harvest-message">Вы собрали 10 морковок и заработали 50 монет!</p>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="closeModal('harvest-modal')">OK</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <h3 class="modal-title" id="confirm-title">Подтверждение</h3>
            <p id="confirm-message">Вы уверены, что хотите купить это?</p>
            <div class="modal-buttons">
                <button class="button button-secondary" onclick="closeModal('confirm-modal')">Отмена</button>
                <button class="button button-primary" onclick="confirmPurchase()">Купить</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="achievement-modal">
        <div class="modal-content">
            <h3 class="modal-title">Достижение разблокировано!</h3>
            <div id="achievement-modal-content" style="display: flex; align-items: center; gap: 15px;">
                <img id="achievement-modal-icon" src="" width="50" height="50">
                <div>
                    <h4 id="achievement-modal-name" style="margin: 0 0 5px 0;"></h4>
                    <p id="achievement-modal-desc" style="margin: 0;"></p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="button button-primary" onclick="closeModal('achievement-modal')">OK</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // Game state
        const gameState = {
            coins: 50,
            level: 1,
            xp: 0,
            maxXp: 100,
            plots: 5,
            unlockedPlots: 3,
            crops: {},
            inventory: {},
            upgrades: {},
            achievements: {},
            selectedItem: null,
            selectedUpgrade: null
        };
        
        // Crop data
        const cropsData = {
            carrot: {
                name: "Морковь",
                growthTime: 10,
                value: 5,
                minHarvest: 1,
                maxHarvest: 3,
                seedCost: 2,
                image: "https://cdn-icons-png.flaticon.com/512/184/184515.png"
            },
            potato: {
                name: "Картофель",
                growthTime: 20,
                value: 10,
                minHarvest: 1,
                maxHarvest: 2,
                seedCost: 5,
                image: "https://cdn-icons-png.flaticon.com/512/3082/3082035.png",
                unlockLevel: 2
            },
            tomato: {
                name: "Помидор",
                growthTime: 30,
                value: 20,
                minHarvest: 1,
                maxHarvest: 4,
                seedCost: 10,
                image: "https://cdn-icons-png.flaticon.com/512/184/184516.png",
                unlockLevel: 3
            },
            strawberry: {
                name: "Клубника",
                growthTime: 45,
                value: 30,
                minHarvest: 2,
                maxHarvest: 6,
                seedCost: 15,
                image: "https://cdn-icons-png.flaticon.com/512/2909/2909788.png",
                unlockLevel: 5
            },
            pumpkin: {
                name: "Тыква",
                growthTime: 60,
                value: 50,
                minHarvest: 1,
                maxHarvest: 2,
                seedCost: 25,
                image: "https://cdn-icons-png.flaticon.com/512/3081/3081984.png",
                unlockLevel: 7
            }
        };
        
        // Upgrades data
        const upgradesData = {
            morePlots: {
                name: "Дополнительные грядки",
                description: "Открывает +1 грядку для посадки",
                cost: 100,
                icon: "https://cdn-icons-png.flaticon.com/512/2921/2921125.png",
                apply: () => {
                    gameState.unlockedPlots = Math.min(gameState.unlockedPlots + 1, gameState.plots);
                    renderFarm();
                },
                maxLevel: 2
            },
            fasterGrowth: {
                name: "Ускоренный рост",
                description: "Все культуры растут на 10% быстрее",
                cost: 200,
                icon: "https://cdn-icons-png.flaticon.com/512/3076/3076134.png",
                growthMultiplier: 0.9,
                maxLevel: 5
            },
            betterHarvest: {
                name: "Улучшенный урожай",
                description: "+1 к минимальному и максимальному урожаю",
                cost: 300,
                icon: "https://cdn-icons-png.flaticon.com/512/3076/3076136.png",
                harvestBonus: 1,
                maxLevel: 3
            },
            autoHarvest: {
                name: "Автосбор",
                description: "Автоматически собирает урожай с готовых грядок",
                cost: 500,
                icon: "https://cdn-icons-png.flaticon.com/512/2936/2936886.png",
                apply: () => {
                    startAutoHarvest();
                },
                maxLevel: 1
            }
        };
        
        // Achievements data
        const achievementsData = {
            firstHarvest: {
                name: "Первый урожай",
                description: "Собери свой первый урожай",
                icon: "https://cdn-icons-png.flaticon.com/512/3132/3132692.png",
                check: () => gameState.achievements.firstHarvest?.unlocked || false
            },
            farmer: {
                name: "Фермер",
                description: "Собери 100 урожаев",
                icon: "https://cdn-icons-png.flaticon.com/512/3132/3132697.png",
                check: () => (gameState.achievements.farmer?.progress || 0) >= 100,
                progress: () => gameState.achievements.farmer?.progress || 0,
                target: 100
            },
            millionaire: {
                name: "Миллионер",
                description: "Заработай 1000 монет",
                icon: "https://cdn-icons-png.flaticon.com/512/3132/3132693.png",
                check: () => (gameState.achievements.millionaire?.progress || 0) >= 1000,
                progress: () => gameState.achievements.millionaire?.progress || 0,
                target: 1000
            },
            expert: {
                name: "Эксперт",
                description: "Достигни 10 уровня",
                icon: "https://cdn-icons-png.flaticon.com/512/3132/3132699.png",
                check: () => gameState.level >= 10,
                progress: () => gameState.level,
                target: 10
            },
            collector: {
                name: "Коллекционер",
                description: "Вырасти все виды культур",
                icon: "https://cdn-icons-png.flaticon.com/512/3132/3132695.png",
                check: () => {
                    const grownCrops = Object.keys(gameState.achievements.collector?.progress || {});
                    return grownCrops.length >= Object.keys(cropsData).length;
                },
                progress: () => Object.keys(gameState.achievements.collector?.progress || {}).length,
                target: Object.keys(cropsData).length
            }
        };
        
        // Initialize game state
        function initGameState() {
            // Initialize crops
            for (let i = 0; i < gameState.plots; i++) {
                gameState.crops[i] = null;
            }
            
            // Initialize inventory
            for (const cropId in cropsData) {
                gameState.inventory[cropId] = 0;
            }
            
            // Initialize upgrades
            for (const upgradeId in upgradesData) {
                gameState.upgrades[upgradeId] = {
                    level: 0,
                    purchased: false
                };
            }
            
            // Initialize achievements
            for (const achievementId in achievementsData) {
                if (!gameState.achievements[achievementId]) {
                    gameState.achievements[achievementId] = {
                        unlocked: false,
                        progress: achievementId === 'collector' ? {} : 0
                    };
                }
            }
            
            // Load saved data
            loadGame();
        }
        
        // Save game state
        function saveGame() {
            localStorage.setItem('happyHarvestSave', JSON.stringify(gameState));
        }
        
        // Load game state
        function loadGame() {
            const savedData = localStorage.getItem('happyHarvestSave');
            if (savedData) {
                const savedState = JSON.parse(savedData);
                
                // Merge saved state with current state
                for (const key in savedState) {
                    if (gameState.hasOwnProperty(key)) {
                        if (typeof savedState[key] === 'object' && !Array.isArray(savedState[key])) {
                            Object.assign(gameState[key], savedState[key]);
                        } else {
                            gameState[key] = savedState[key];
                        }
                    }
                }
                
                // Update UI
                updateStats();
                renderFarm();
                renderShop();
                renderUpgrades();
                renderAchievements();
                
                showNotification('Игра загружена!');
            }
        }
        
        // Update stats display
        function updateStats() {
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('xp').textContent = gameState.xp;
            document.getElementById('max-xp').textContent = gameState.maxXp;
        }
        
        // Render farm plots
        function renderFarm() {
            const farmElement = document.getElementById('farm');
            farmElement.innerHTML = '';
            
            for (let i = 0; i < gameState.plots; i++) {
                const plotElement = document.createElement('div');
                plotElement.className = `plot ${i >= gameState.unlockedPlots ? 'locked' : ''}`;
                plotElement.onclick = () => handlePlotClick(i);
                
                const soilElement = document.createElement('div');
                soilElement.className = 'plot-soil';
                plotElement.appendChild(soilElement);
                
                if (i >= gameState.unlockedPlots) {
                    const lockIcon = document.createElement('img');
                    lockIcon.src = 'https://cdn-icons-png.flaticon.com/512/3523/3523067.png';
                    lockIcon.className = 'crop';
                    plotElement.appendChild(lockIcon);
                } else if (gameState.crops[i]) {
                    const crop = gameState.crops[i];
                    const cropData = cropsData[crop.type];
                    
                    const cropElement = document.createElement('img');
                    cropElement.src = cropData.image;
                    cropElement.className = 'crop';
                    plotElement.appendChild(cropElement);
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-fill';
                    
                    // Calculate growth percentage
                    const now = Date.now();
                    const growthTime = cropData.growthTime * 1000 * (gameState.upgrades.fasterGrowth?.level ? 
                        Math.pow(upgradesData.fasterGrowth.growthMultiplier, gameState.upgrades.fasterGrowth.level) : 1);
                    const elapsed = now - crop.plantedAt;
                    const percentage = Math.min(100, (elapsed / growthTime) * 100);
                    
                    progressFill.style.width = `${percentage}%`;
                    
                    // Change color based on growth stage
                    if (percentage < 33) {
                        progressFill.style.backgroundColor = '#FF5722';
                    } else if (percentage < 66) {
                        progressFill.style.backgroundColor = '#FFC107';
                    } else {
                        progressFill.style.backgroundColor = '#4CAF50';
                    }
                    
                    progressBar.appendChild(progressFill);
                    plotElement.appendChild(progressBar);
                    
                    // Check if crop is ready
                    if (percentage >= 100) {
                        plotElement.style.border = '2px solid gold';
                    }
                }
                
                farmElement.appendChild(plotElement);
            }
        }
        
        // Handle plot click
        function handlePlotClick(plotIndex) {
            if (plotIndex >= gameState.unlockedPlots) {
                showNotification('Эта грядка заблокирована! Купите улучшение, чтобы разблокировать.');
                return;
            }
            
            const crop = gameState.crops[plotIndex];
            
            if (!crop) {
                // Plot is empty - open shop
                openTab('shop-tab');
                showNotification('Выберите семена для посадки в магазине');
            } else {
                // Check if crop is ready to harvest
                const cropData = cropsData[crop.type];
                const growthTime = cropData.growthTime * 1000 * (gameState.upgrades.fasterGrowth?.level ? 
                    Math.pow(upgradesData.fasterGrowth.growthMultiplier, gameState.upgrades.fasterGrowth.level) : 1);
                const elapsed = Date.now() - crop.plantedAt;
                
                if (elapsed >= growthTime) {
                    harvestCrop(plotIndex);
                } else {
                    const timeLeft = Math.ceil((growthTime - elapsed) / 1000);
                    showNotification(`${cropData.name} будет готов через ${timeLeft} сек.`);
                }
            }
        }
        
        // Harvest crop
        function harvestCrop(plotIndex) {
            const crop = gameState.crops[plotIndex];
            const cropData = cropsData[crop.type];
            
            // Calculate harvest amount
            let minHarvest = cropData.minHarvest;
            let maxHarvest = cropData.maxHarvest;
            
            if (gameState.upgrades.betterHarvest?.level) {
                minHarvest += upgradesData.betterHarvest.harvestBonus * gameState.upgrades.betterHarvest.level;
                maxHarvest += upgradesData.betterHarvest.harvestBonus * gameState.upgrades.betterHarvest.level;
            }
            
            const harvestAmount = Math.floor(Math.random() * (maxHarvest - minHarvest + 1)) + minHarvest;
            const coinsEarned = harvestAmount * cropData.value;
            
            // Update game state
            gameState.coins += coinsEarned;
            gameState.inventory[crop.type] = (gameState.inventory[crop.type] || 0) + harvestAmount;
            gameState.crops[plotIndex] = null;
            
            // Add XP
            addXp(5);
            
            // Update achievements
            updateAchievementProgress('farmer', 1);
            updateAchievementProgress('millionaire', coinsEarned);
            updateCollectorAchievement(crop.type);
            
            // Show harvest message
            document.getElementById('harvest-message').textContent = 
                `Вы собрали ${harvestAmount} ${getRussianNounForm(harvestAmount, cropData.name, cropData.name + 'а', cropData.name + 'ов')} и заработали ${coinsEarned} монет!`;
            openModal('harvest-modal');
            
            // Update UI
            updateStats();
            renderFarm();
        }
        
        // Auto-harvest ready crops
        function startAutoHarvest() {
            if (!gameState.upgrades.autoHarvest.purchased) return;
            
            setInterval(() => {
                for (let i = 0; i < gameState.unlockedPlots; i++) {
                    const crop = gameState.crops[i];
                    if (crop) {
                        const cropData = cropsData[crop.type];
                        const growthTime = cropData.growthTime * 1000 * (gameState.upgrades.fasterGrowth?.level ? 
                            Math.pow(upgradesData.fasterGrowth.growthMultiplier, gameState.upgrades.fasterGrowth.level) : 1);
                        const elapsed = Date.now() - crop.plantedAt;
                        
                        if (elapsed >= growthTime) {
                            harvestCrop(i);
                        }
                    }
                }
            }, 5000);
        }
        
        // Plant crop
        function plantCrop(plotIndex, cropType) {
            if (gameState.crops[plotIndex]) return;
            
            gameState.crops[plotIndex] = {
                type: cropType,
                plantedAt: Date.now()
            };
            
            showNotification(`Вы посадили ${cropsData[cropType].name}`);
            renderFarm();
            saveGame();
        }
        
        // Render shop
        function renderShop() {
            const shopElement = document.getElementById('seeds-shop');
            shopElement.innerHTML = '';
            
            for (const cropId in cropsData) {
                const cropData = cropsData[cropId];
                
                // Check if crop is unlocked
                if (cropData.unlockLevel && cropData.unlockLevel > gameState.level) continue;
                
                const shopItem = document.createElement('div');
                shopItem.className = 'shop-item';
                shopItem.onclick = () => selectSeed(cropId);
                
                const icon = document.createElement('img');
                icon.src = cropData.image;
                icon.className = 'shop-item-icon';
                shopItem.appendChild(icon);
                
                const name = document.createElement('div');
                name.className = 'shop-item-name';
                name.textContent = cropData.name;
                shopItem.appendChild(name);
                
                const price = document.createElement('div');
                price.className = 'shop-item-price';
                price.textContent = `${cropData.seedCost} монет`;
                shopItem.appendChild(price);
                
                shopElement.appendChild(shopItem);
            }
        }
        
        // Select seed for planting
        function selectSeed(cropId) {
            const cropData = cropsData[cropId];
            
            if (gameState.coins < cropData.seedCost) {
                showNotification('Недостаточно монет!');
                return;
            }
            
            // Find first empty plot
            for (let i = 0; i < gameState.unlockedPlots; i++) {
                if (!gameState.crops[i]) {
                    gameState.coins -= cropData.seedCost;
                    updateStats();
                    plantCrop(i, cropId);
                    return;
                }
            }
            
            showNotification('Нет свободных грядок!');
        }
        
        // Render upgrades
        function renderUpgrades() {
            const upgradesList = document.getElementById('upgrades-list');
            upgradesList.innerHTML = '';
            
            for (const upgradeId in upgradesData) {
                const upgradeData = upgradesData[upgradeId];
                const upgradeState = gameState.upgrades[upgradeId];
                
                // Check if upgrade is already maxed out
                if (upgradeState.level >= upgradeData.maxLevel) continue;
                
                const upgradeElement = document.createElement('div');
                upgradeElement.className = 'upgrade';
                upgradeElement.onclick = () => selectUpgrade(upgradeId);
                
                const upgradeInfo = document.createElement('div');
                upgradeInfo.className = 'upgrade-info';
                
                const icon = document.createElement('img');
                icon.src = upgradeData.icon;
                icon.className = 'upgrade-icon';
                upgradeInfo.appendChild(icon);
                
                const textContainer = document.createElement('div');
                
                const name = document.createElement('div');
                name.textContent = `${upgradeData.name} (Ур. ${upgradeState.level + 1})`;
                textContainer.appendChild(name);
                
                const desc = document.createElement('div');
                desc.style.fontSize = '0.9em';
                desc.style.color = '#666';
                desc.textContent = upgradeData.description;
                textContainer.appendChild(desc);
                
                upgradeInfo.appendChild(textContainer);
                upgradeElement.appendChild(upgradeInfo);
                
                const price = document.createElement('div');
                price.className = 'upgrade-price';
                price.textContent = `${upgradeData.cost * (upgradeState.level + 1)} монет`;
                upgradeElement.appendChild(price);
                
                upgradesList.appendChild(upgradeElement);
            }
        }
        
        // Select upgrade
        function selectUpgrade(upgradeId) {
            const upgradeData = upgradesData[upgradeId];
            const upgradeState = gameState.upgrades[upgradeId];
            const cost = upgradeData.cost * (upgradeState.level + 1);
            
            if (gameState.coins < cost) {
                showNotification('Недостаточно монет для этого улучшения!');
                return;
            }
            
            gameState.selectedUpgrade = upgradeId;
            
            document.getElementById('confirm-title').textContent = `Купить улучшение?`;
            document.getElementById('confirm-message').textContent = 
                `${upgradeData.name} (Ур. ${upgradeState.level + 1}) - ${cost} монет`;
            
            openModal('confirm-modal');
        }
        
        // Confirm purchase
        function confirmPurchase() {
            const upgradeId = gameState.selectedUpgrade;
            const upgradeData = upgradesData[upgradeId];
            const upgradeState = gameState.upgrades[upgradeId];
            const cost = upgradeData.cost * (upgradeState.level + 1);
            
            gameState.coins -= cost;
            upgradeState.level++;
            
            if (upgradeState.level >= upgradeData.maxLevel) {
                upgradeState.purchased = true;
            }
            
            // Apply upgrade effects
            if (upgradeData.apply) {
                upgradeData.apply();
            }
            
            closeModal('confirm-modal');
            updateStats();
            renderUpgrades();
            saveGame();
            
            showNotification(`Улучшение "${upgradeData.name}" куплено!`);
        }
        
        // Render achievements
        function renderAchievements() {
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            
            for (const achievementId in achievementsData) {
                const achievementData = achievementsData[achievementId];
                const achievementState = gameState.achievements[achievementId];
                
                const achievementElement = document.createElement('div');
                achievementElement.className = `achievement ${achievementState.unlocked ? '' : 'achievement-locked'}`;
                
                const icon = document.createElement('img');
                icon.src = achievementData.icon;
                icon.className = 'achievement-icon';
                achievementElement.appendChild(icon);
                
                const textContainer = document.createElement('div');
                
                const name = document.createElement('div');
                name.textContent = achievementData.name;
                name.style.fontWeight = 'bold';
                textContainer.appendChild(name);
                
                const desc = document.createElement('div');
                desc.textContent = achievementData.description;
                desc.style.fontSize = '0.9em';
                textContainer.appendChild(desc);
                
                if (achievementData.progress && !achievementState.unlocked) {
                    const progress = document.createElement('div');
                    progress.style.fontSize = '0.8em';
                    progress.style.marginTop = '5px';
                    progress.textContent = `${achievementData.progress()}/${achievementData.target}`;
                    textContainer.appendChild(progress);
                }
                
                if (achievementState.unlocked) {
                    const badge = document.createElement('div');
                    badge.textContent = '✔️ Получено';
                    badge.style.fontSize = '0.8em';
                    badge.style.color = '#4CAF50';
                    badge.style.marginTop = '5px';
                    textContainer.appendChild(badge);
                }
                
                achievementElement.appendChild(textContainer);
                achievementsList.appendChild(achievementElement);
            }
        }
        
        // Update achievement progress
        function updateAchievementProgress(achievementId, amount) {
            const achievement = gameState.achievements[achievementId];
            if (!achievement || achievement.unlocked) return;
            
            if (typeof achievement.progress === 'number') {
                achievement.progress += amount;
            }
            
            if (achievementsData[achievementId].check()) {
                unlockAchievement(achievementId);
            }
        }
        
        // Update collector achievement
        function updateCollectorAchievement(cropType) {
            const achievement = gameState.achievements.collector;
            if (!achievement || achievement.unlocked) return;
            
            if (!achievement.progress[cropType]) {
                achievement.progress[cropType] = true;
                
                if (achievementsData.collector.check()) {
                    unlockAchievement('collector');
                }
            }
        }
        
        // Unlock achievement
        function unlockAchievement(achievementId) {
            const achievement = gameState.achievements[achievementId];
            if (achievement.unlocked) return;
            
            achievement.unlocked = true;
            
            // Show achievement popup
            const achievementData = achievementsData[achievementId];
            document.getElementById('achievement-modal-icon').src = achievementData.icon;
            document.getElementById('achievement-modal-name').textContent = achievementData.name;
            document.getElementById('achievement-modal-desc').textContent = achievementData.description;
            
            openModal('achievement-modal');
            renderAchievements();
            saveGame();
        }
        
        // Add XP
        function addXp(amount) {
            gameState.xp += amount;
            
            // Check for level up
            if (gameState.xp >= gameState.maxXp) {
                gameState.level++;
                gameState.xp -= gameState.maxXp;
                gameState.maxXp = Math.floor(gameState.maxXp * 1.5);
                
                showNotification(`Уровень повышен! Теперь вы ${gameState.level} уровня.`);
                
                // Check for level-based achievements
                if (achievementsData.expert.check() && !gameState.achievements.expert.unlocked) {
                    unlockAchievement('expert');
                }
            }
            
            updateStats();
            saveGame();
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Trigger animation
            notification.style.animation = 'none';
            void notification.offsetWidth; // Trigger reflow
            notification.style.animation = 'notificationFadeInOut 2.5s';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2500);
        }
        
        // Open modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Open tab
        function openTab(tabId) {
            // Hide all tab contents
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Deactivate all tab buttons
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Show the selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Activate the clicked button
            event.currentTarget.classList.add('active');
        }
        
        // Helper function for Russian noun forms
        function getRussianNounForm(number, form1, form2, form5) {
            number = Math.abs(number) % 100;
            const n1 = number % 10;
            
            if (number > 10 && number < 20) return form5;
            if (n1 > 1 && n1 < 5) return form2;
            if (n1 === 1) return form1;
            return form5;
        }
        
        // Initialize Telegram Web App
        let tg = null;
        
        function initTelegram() {
            tg = window.Telegram.WebApp;
            tg.expand();
            
            // Set theme colors
            const themeParams = tg.themeParams;
            document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#707070');
            document.documentElement.style.setProperty('--tg-theme-link-color', themeParams.link_color || '#3390ec');
            document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#3390ec');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
            
            // Handle back button
            tg.BackButton.onClick(() => {
                tg.close();
            });
        }
        
        // Initialize game
        window.onload = function() {
            initTelegram();
            initGameState();
            updateStats();
            renderFarm();
            renderShop();
            renderUpgrades();
            renderAchievements();
            
            // Check for first harvest achievement
            if (!gameState.achievements.firstHarvest.unlocked) {
                unlockAchievement('firstHarvest');
            }
            
            // Start game loop
            setInterval(() => {
                renderFarm();
            }, 1000);
        };
    </script>
</body>
</html>
