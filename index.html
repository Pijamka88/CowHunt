<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Bear Evolution</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 0;
            background-color: #f0e6d2;
            color: #3a3226;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23d4c9a8" d="M50 0 L100 50 L50 100 L0 50 Z" opacity="0.1"/></svg>');
            background-size: 100px 100px;
        }

        #game-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #8b7355;
            padding-bottom: 10px;
        }

        .header h1 {
            color: #5d4b36;
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-style: italic;
            color: #7a6a52;
        }

        .pets-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            min-height: 300px;
        }

        .pet {
            width: 120px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .pet:hover {
            transform: translateY(-5px);
        }

        .pet-emoji {
            font-size: 60px;
            margin-bottom: 10px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .pet-level {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #8b7355;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #5d4b36;
        }

        .pet-health {
            height: 5px;
            background-color: #e0d5c0;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .pet-health-bar {
            height: 100%;
            background-color: #c62828;
            width: 100%;
            transition: width 0.3s ease;
        }

        .pet-name {
            font-weight: bold;
            margin-top: 5px;
            color: #5d4b36;
        }

        .stats-container {
            background-color: #e0d5c0;
            border: 2px solid #8b7355;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .stat {
            margin-bottom: 10px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .progress-container {
            height: 20px;
            background-color: #d4c9a8;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #8b7355;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #5d4b36, #8b7355);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        }

        .actions-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            background: linear-gradient(to bottom, #8b7355, #5d4b36);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
            font-size: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .action-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-btn:disabled {
            background: #d4c9a8;
            color: #a09888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .pets-count {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #8b7355;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            border: 2px solid #5d4b36;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .evolution-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(139, 115, 85, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s infinite;
            border: 2px solid #5d4b36;
            max-width: 80%;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        .evolution-emoji {
            font-size: 40px;
            margin: 10px 0;
        }

        .dead-pet {
            opacity: 0.6;
            filter: grayscale(70%);
        }

        .action-progress {
            height: 5px;
            background-color: #d4c9a8;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .action-progress-bar {
            height: 100%;
            background-color: #5d4b36;
            width: 0%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="header">
            <h1>Medieval Bear Evolution</h1>
            <p>Raise your bears to greatness!</p>
        </div>

        <div class="pets-count" id="pets-count">0</div>

        <div class="pets-container" id="pets-container">
            <!-- Pets will appear here -->
        </div>

        <div class="stats-container">
            <div class="stat">
                <div class="stat-label">
                    <span>Health</span>
                    <span id="health-value">100/100</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="health-bar" style="width: 100%">100%</div>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">
                    <span>Hunger</span>
                    <span id="hunger-value">50/100</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="hunger-bar" style="width: 50%">50%</div>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">
                    <span>Energy</span>
                    <span id="energy-value">80/100</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="energy-bar" style="width: 80%">80%</div>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">
                    <span>Happiness</span>
                    <span id="happiness-value">70/100</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="happiness-bar" style="width: 70%">70%</div>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">
                    <span>Experience</span>
                    <span id="exp-value">0/100</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="exp-bar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <div class="actions-container">
            <button class="action-btn" id="feed-btn">
                Feed
                <div class="action-progress">
                    <div class="action-progress-bar" id="feed-progress"></div>
                </div>
            </button>
            <button class="action-btn" id="play-btn">
                Play
                <div class="action-progress">
                    <div class="action-progress-bar" id="play-progress"></div>
                </div>
            </button>
            <button class="action-btn" id="sleep-btn">
                Rest
                <div class="action-progress">
                    <div class="action-progress-bar" id="sleep-progress"></div>
                </div>
            </button>
            <button class="action-btn" id="train-btn">
                Train
                <div class="action-progress">
                    <div class="action-progress-bar" id="train-progress"></div>
                </div>
            </button>
            <button class="action-btn" id="heal-btn">
                Heal
                <div class="action-progress">
                    <div class="action-progress-bar" id="heal-progress"></div>
                </div>
            </button>
            <button class="action-btn" id="clean-btn">
                Clean
                <div class="action-progress">
                    <div class="action-progress-bar" id="clean-progress"></div>
                </div>
            </button>
        </div>
    </div>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Game state
        const gameState = {
            pets: [],
            selectedPetIndex: 0,
            lastUpdate: Date.now(),
            actionProgress: {
                feed: 0,
                play: 0,
                sleep: 0,
                train: 0,
                heal: 0,
                clean: 0
            },
            version: 1
        };
        
        // Bear evolution stages with different colors
        const bearStages = [
            { emoji: 'üêª', color: '#8B4513', name: 'Cub' },          // Brown (level 1-3)
            { emoji: 'üêª', color: '#A0522D', name: 'Bear' },          // Sienna (level 4-6)
            { emoji: 'üêª', color: '#D2691E', name: 'Grizzly' },       // Chocolate (level 7-9)
            { emoji: 'üêª', color: '#CD853F', name: 'Elder' },         // Peru (level 10-12)
            { emoji: 'üêª', color: '#DAA520', name: 'Golden' },        // Goldenrod (max level)
            { emoji: 'üêª', color: '#B8860B', name: 'Legendary' }      // DarkGoldenrod (special)
        ];
        
        // DOM elements
        const elements = {
            petsContainer: document.getElementById('pets-container'),
            petsCount: document.getElementById('pets-count'),
            
            // Stats
            healthValue: document.getElementById('health-value'),
            healthBar: document.getElementById('health-bar'),
            hungerValue: document.getElementById('hunger-value'),
            hungerBar: document.getElementById('hunger-bar'),
            energyValue: document.getElementById('energy-value'),
            energyBar: document.getElementById('energy-bar'),
            happinessValue: document.getElementById('happiness-value'),
            happinessBar: document.getElementById('happiness-bar'),
            expValue: document.getElementById('exp-value'),
            expBar: document.getElementById('exp-bar'),
            
            // Action buttons
            feedBtn: document.getElementById('feed-btn'),
            playBtn: document.getElementById('play-btn'),
            sleepBtn: document.getElementById('sleep-btn'),
            trainBtn: document.getElementById('train-btn'),
            healBtn: document.getElementById('heal-btn'),
            cleanBtn: document.getElementById('clean-btn'),
            
            // Progress bars
            feedProgress: document.getElementById('feed-progress'),
            playProgress: document.getElementById('play-progress'),
            sleepProgress: document.getElementById('sleep-progress'),
            trainProgress: document.getElementById('train-progress'),
            healProgress: document.getElementById('heal-progress'),
            cleanProgress: document.getElementById('clean-progress')
        };
        
        // Initialize the game
        function initGame() {
            loadGame();
            setupEventListeners();
            
            // Start with one pet if none exists
            if (gameState.pets.length === 0) {
                addNewPet();
            }
            
            updateUI();
            
            // Start game loop
            setInterval(gameLoop, 1000);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Action buttons
            elements.feedBtn.addEventListener('click', () => startAction('feed'));
            elements.playBtn.addEventListener('click', () => startAction('play'));
            elements.sleepBtn.addEventListener('click', () => startAction('sleep'));
            elements.trainBtn.addEventListener('click', () => startAction('train'));
            elements.healBtn.addEventListener('click', () => startAction('heal'));
            elements.cleanBtn.addEventListener('click', () => startAction('clean'));
            
            // Button release events
            document.addEventListener('mouseup', stopAction);
            document.addEventListener('touchend', stopAction);
        }
        
        // Game loop
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - gameState.lastUpdate) / 1000; // in seconds
            gameState.lastUpdate = now;
            
            // Update all pets
            gameState.pets.forEach(pet => {
                updatePet(pet, deltaTime);
            });
            
            // Update action progress bars
            updateActionProgressBars();
            
            // Save game state
            saveGame();
            updateUI();
        }
        
        // Update a pet's stats over time
        function updatePet(pet, deltaTime) {
            if (pet.isDead) return;
            
            // Decrease stats over time
            pet.hunger = Math.max(0, pet.hunger - 0.3 * deltaTime);
            pet.energy = Math.max(0, pet.energy - 0.2 * deltaTime);
            pet.happiness = Math.max(0, pet.happiness - 0.1 * deltaTime);
            
            // If hunger or energy is too low, decrease health
            if (pet.hunger <= 20 || pet.energy <= 20) {
                pet.health = Math.max(0, pet.health - 0.5 * deltaTime);
            }
            
            // If health reaches zero, pet dies
            if (pet.health <= 0 && !pet.isDead) {
                pet.isDead = true;
                pet.deathTime = Date.now();
            }
            
            // Remove dead pets after 5 minutes
            if (pet.isDead && Date.now() - pet.deathTime > 300000) {
                const index = gameState.pets.indexOf(pet);
                if (index !== -1) {
                    gameState.pets.splice(index, 1);
                    if (gameState.selectedPetIndex >= index) {
                        gameState.selectedPetIndex = Math.max(0, gameState.selectedPetIndex - 1);
                    }
                }
            }
        }
        
        // Start an action (button pressed)
        function startAction(action) {
            gameState.actionProgress[action] = 0;
            const interval = setInterval(() => {
                gameState.actionProgress[action] += 2;
                if (gameState.actionProgress[action] >= 100) {
                    completeAction(action);
                    clearInterval(interval);
                }
            }, 20);
            
            // Store the interval so we can clear it if the button is released early
            gameState.actionProgress[`${action}Interval`] = interval;
        }
        
        // Stop an action (button released)
        function stopAction() {
            // Clear all action intervals
            Object.keys(gameState.actionProgress).forEach(key => {
                if (key.endsWith('Interval')) {
                    clearInterval(gameState.actionProgress[key]);
                    const action = key.replace('Interval', '');
                    gameState.actionProgress[action] = 0;
                }
            });
        }
        
        // Complete an action (progress reached 100%)
        function completeAction(action) {
            const pet = getSelectedPet();
            if (!pet || pet.isDead) return;
            
            switch (action) {
                case 'feed':
                    pet.hunger = Math.min(100, pet.hunger + 25);
                    pet.energy = Math.max(0, pet.energy - 5);
                    pet.exp += 5;
                    break;
                case 'play':
                    pet.happiness = Math.min(100, pet.happiness + 20);
                    pet.energy = Math.max(0, pet.energy - 10);
                    pet.hunger = Math.max(0, pet.hunger - 5);
                    pet.exp += 10;
                    break;
                case 'sleep':
                    pet.energy = Math.min(100, pet.energy + 30);
                    pet.hunger = Math.max(0, pet.hunger - 10);
                    pet.exp += 5;
                    break;
                case 'train':
                    pet.energy = Math.max(0, pet.energy - 15);
                    pet.hunger = Math.max(0, pet.hunger - 10);
                    pet.exp += 20;
                    break;
                case 'heal':
                    pet.health = Math.min(100, pet.health + 20);
                    pet.energy = Math.max(0, pet.energy - 10);
                    pet.exp += 5;
                    break;
                case 'clean':
                    pet.happiness = Math.min(100, pet.happiness + 10);
                    pet.health = Math.min(100, pet.health + 5);
                    pet.exp += 5;
                    break;
            }
            
            checkLevelUp(pet);
            updateUI();
        }
        
        // Update action progress bars
        function updateActionProgressBars() {
            elements.feedProgress.style.width = `${gameState.actionProgress.feed}%`;
            elements.playProgress.style.width = `${gameState.actionProgress.play}%`;
            elements.sleepProgress.style.width = `${gameState.actionProgress.sleep}%`;
            elements.trainProgress.style.width = `${gameState.actionProgress.train}%`;
            elements.healProgress.style.width = `${gameState.actionProgress.heal}%`;
            elements.cleanProgress.style.width = `${gameState.actionProgress.clean}%`;
        }
        
        // Check if pet should level up
        function checkLevelUp(pet) {
            if (pet.level >= 12) return; // Max level
            
            const expNeeded = getExpForLevel(pet.level + 1);
            
            if (pet.exp >= expNeeded) {
                pet.level++;
                pet.exp -= expNeeded;
                
                // Check for evolution
                checkEvolution(pet);
                
                // Check for reproduction every 3 levels
                if (pet.level % 3 === 0 && pet.level < 12) {
                    reproducePet(pet);
                }
            }
        }
        
        // Check if pet should evolve
        function checkEvolution(pet) {
            const currentStage = getBearStage(pet.level - 1);
            const newStage = getBearStage(pet.level);
            
            if (currentStage.name !== newStage.name) {
                showEvolutionNotification(pet, newStage);
            }
        }
        
        // Show evolution notification
        function showEvolutionNotification(pet, newStage) {
            const notification = document.createElement('div');
            notification.className = 'evolution-notification';
            notification.innerHTML = `
                <h3>Evolution!</h3>
                <div class="evolution-emoji">${newStage.emoji}</div>
                <p>Your bear has evolved into a ${newStage.name}!</p>
                <p>Level ${pet.level}</p>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Reproduce pet (create a new one)
        function reproducePet(parentPet) {
            addNewPet();
            
            // Show a brief notification
            const notification = document.createElement('div');
            notification.className = 'evolution-notification';
            notification.innerHTML = `
                <h3>New Bear!</h3>
                <div class="evolution-emoji">üêª</div>
                <p>Your ${parentPet.level}-level bear has produced offspring!</p>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Add a new pet
        function addNewPet() {
            const newPet = {
                level: 1,
                exp: 0,
                health: 100,
                hunger: 50,
                energy: 80,
                happiness: 70,
                isDead: false,
                birthTime: Date.now()
            };
            
            gameState.pets.push(newPet);
            
            // Select the new pet if it's the first one
            if (gameState.pets.length === 1) {
                gameState.selectedPetIndex = 0;
            }
        }
        
        // Get the currently selected pet
        function getSelectedPet() {
            return gameState.pets[gameState.selectedPetIndex];
        }
        
        // Get bear stage based on level
        function getBearStage(level) {
            if (level >= 12) return bearStages[5]; // Legendary
            if (level >= 10) return bearStages[4]; // Golden
            if (level >= 7) return bearStages[3]; // Elder
            if (level >= 4) return bearStages[2]; // Grizzly
            if (level >= 2) return bearStages[1]; // Bear
            return bearStages[0]; // Cub
        }
        
        // Get experience needed for a level
        function getExpForLevel(level) {
            return 100 * Math.pow(level, 1.2);
        }
        
        // Update the UI
        function updateUI() {
            updatePetsDisplay();
            updateStatsDisplay();
            updateActionButtons();
            updatePetsCount();
        }
        
        // Update pets display
        function updatePetsDisplay() {
            elements.petsContainer.innerHTML = '';
            
            gameState.pets.forEach((pet, index) => {
                const petElement = document.createElement('div');
                petElement.className = `pet ${pet.isDead ? 'dead-pet' : ''}`;
                
                const stage = getBearStage(pet.level);
                
                petElement.innerHTML = `
                    <div class="pet-level">${pet.level}</div>
                    <div class="pet-emoji" style="color: ${stage.color}">${stage.emoji}</div>
                    <div class="pet-name">${stage.name}</div>
                    <div class="pet-health">
                        <div class="pet-health-bar" style="width: ${pet.health}%"></div>
                    </div>
                `;
                
                // Select pet on click
                petElement.addEventListener('click', () => {
                    gameState.selectedPetIndex = index;
                    updateUI();
                });
                
                // Highlight selected pet
                if (index === gameState.selectedPetIndex) {
                    petElement.style.transform = 'scale(1.1)';
                    petElement.style.boxShadow = '0 0 10px rgba(139, 115, 85, 0.7)';
                }
                
                elements.petsContainer.appendChild(petElement);
            });
        }
        
        // Update stats display
        function updateStatsDisplay() {
            const pet = getSelectedPet();
            if (!pet) return;
            
            // Health
            elements.healthValue.textContent = `${Math.round(pet.health)}/100`;
            elements.healthBar.style.width = `${pet.health}%`;
            elements.healthBar.textContent = `${Math.round(pet.health)}%`;
            
            // Hunger
            elements.hungerValue.textContent = `${Math.round(pet.hunger)}/100`;
            elements.hungerBar.style.width = `${pet.hunger}%`;
            elements.hungerBar.textContent = `${Math.round(pet.hunger)}%`;
            
            // Energy
            elements.energyValue.textContent = `${Math.round(pet.energy)}/100`;
            elements.energyBar.style.width = `${pet.energy}%`;
            elements.energyBar.textContent = `${Math.round(pet.energy)}%`;
            
            // Happiness
            elements.happinessValue.textContent = `${Math.round(pet.happiness)}/100`;
            elements.happinessBar.style.width = `${pet.happiness}%`;
            elements.happinessBar.textContent = `${Math.round(pet.happiness)}%`;
            
            // Experience
            const expNeeded = getExpForLevel(pet.level + 1);
            const expPercent = pet.level < 12 ? (pet.exp / expNeeded) * 100 : 100;
            elements.expValue.textContent = pet.level < 12 ? 
                `${Math.round(pet.exp)}/${Math.round(expNeeded)}` : 'MAX';
            elements.expBar.style.width = `${expPercent}%`;
            elements.expBar.textContent = pet.level < 12 ? `${Math.round(expPercent)}%` : 'MAX';
        }
        
        // Update action buttons state
        function updateActionButtons() {
            const pet = getSelectedPet();
            const isDead = !pet || pet.isDead;
            
            elements.feedBtn.disabled = isDead;
            elements.playBtn.disabled = isDead;
            elements.sleepBtn.disabled = isDead;
            elements.trainBtn.disabled = isDead;
            elements.healBtn.disabled = isDead;
            elements.cleanBtn.disabled = isDead;
        }
        
        // Update pets count display
        function updatePetsCount() {
            elements.petsCount.textContent = gameState.pets.length;
        }
        
        // Save game state
        function saveGame() {
            localStorage.setItem('medievalBearEvolution', JSON.stringify(gameState));
        }
        
        // Load game state
        function loadGame() {
            const savedGame = localStorage.getItem('medievalBearEvolution');
            if (savedGame) {
                const parsed = JSON.parse(savedGame);
                
                // Check version for compatibility
                if (parsed.version === gameState.version) {
                    Object.assign(gameState, parsed);
                }
            }
        }
        
        // Initialize the game when the page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>