<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эволюционный Тамагочи</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            background-color: #50a8eb;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3a7bb8;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .pet-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .pet {
            border: 2px solid #50a8eb;
            border-radius: 10px;
            padding: 15px;
            width: 200px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .pet-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        .pet-stats {
            text-align: left;
            margin-top: 10px;
        }
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 5px 0;
        }
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #4caf50;
        }
        .hunger {
            background-color: #ff9800;
        }
        .energy {
            background-color: #2196f3;
        }
        .happiness {
            background-color: #e91e63;
        }
        .level {
            background-color: #9c27b0;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }
        .action-buttons button {
            padding: 5px 10px;
            font-size: 14px;
        }
        .back-button {
            background-color: #f44336;
            margin-top: 20px;
        }
        .back-button:hover {
            background-color: #d32f2f;
        }
        .hidden {
            display: none;
        }
        .evolution-notice {
            color: #9c27b0;
            font-weight: bold;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu">
            <h1>Эволюционный Тамагочи</h1>
            <p>Вырастите своего питомца, ухаживайте за ним и наблюдайте, как он эволюционирует через деление!</p>
            <div class="menu">
                <button id="new-game-btn">Новая игра</button>
                <button id="continue-game-btn">Продолжить игру</button>
                <button id="how-to-play-btn">Как играть?</button>
            </div>
        </div>

        <!-- Экран обучения -->
        <div id="how-to-play" class="hidden">
            <h2>Как играть</h2>
            <p>1. У вас есть питомец с четырьмя характеристиками:</p>
            <ul>
                <li><strong>Голод</strong> - кормите питомца, чтобы уменьшить голод</li>
                <li><strong>Энергия</strong> - давайте питомцу отдыхать, чтобы восстановить энергию</li>
                <li><strong>Счастье</strong> - играйте с питомцем, чтобы увеличить счастье</li>
                <li><strong>Уровень</strong> - растёт со временем при хорошем уходе</li>
            </ul>
            <p>2. Когда уровень питомца достигает максимума, он делится на два новых питомца.</p>
            <p>3. Вы можете ухаживать за несколькими питомцами одновременно.</p>
            <p>4. Игра автоматически сохраняется в вашем браузере.</p>
            <button id="back-from-help" class="back-button">Назад</button>
        </div>

        <!-- Игровой экран -->
        <div id="game-screen" class="hidden">
            <h2>Ваши питомцы</h2>
            <div id="pets-container" class="pet-container"></div>
            <button id="back-to-menu" class="back-button">В главное меню</button>
        </div>

        <!-- Экран создания нового питомца -->
        <div id="new-pet-screen" class="hidden">
            <h2>Создание нового питомца</h2>
            <p>Дайте имя вашему первому питомцу:</p>
            <input type="text" id="pet-name-input" placeholder="Имя питомца" maxlength="20">
            <button id="create-pet-btn">Создать</button>
            <button id="cancel-create-pet" class="back-button">Отмена</button>
        </div>
    </div>

    <script>
        // Игровые константы
        const MAX_HUNGER = 100;
        const MAX_ENERGY = 100;
        const MAX_HAPPINESS = 100;
        const MAX_LEVEL = 10;
        
        const HUNGER_RATE = 2; // Скорость увеличения голода
        const ENERGY_RATE = 1.5; // Скорость уменьшения энергии
        const HAPPINESS_RATE = 1; // Скорость уменьшения счастья
        const LEVEL_RATE = 0.05; // Скорость увеличения уровня (при хорошем уходе)
        
        const FEED_AMOUNT = 30; // Сколько восстанавливает кормление
        const REST_AMOUNT = 40; // Сколько восстанавливает отдых
        const PLAY_AMOUNT = 25; // Сколько восстанавливает игра
        
        // Состояние игры
        let gameState = {
            pets: [],
            lastUpdate: Date.now(),
            gameStarted: false
        };
        
        // Элементы интерфейса
        const mainMenu = document.getElementById('main-menu');
        const howToPlay = document.getElementById('how-to-play');
        const gameScreen = document.getElementById('game-screen');
        const newPetScreen = document.getElementById('new-pet-screen');
        const petsContainer = document.getElementById('pets-container');
        
        // Кнопки
        const newGameBtn = document.getElementById('new-game-btn');
        const continueGameBtn = document.getElementById('continue-game-btn');
        const howToPlayBtn = document.getElementById('how-to-play-btn');
        const backFromHelpBtn = document.getElementById('back-from-help');
        const backToMenuBtn = document.getElementById('back-to-menu');
        const createPetBtn = document.getElementById('create-pet-btn');
        const cancelCreatePetBtn = document.getElementById('cancel-create-pet');
        const petNameInput = document.getElementById('pet-name-input');
        
        // Инициализация Telegram Web App
        let tg = window.Telegram.WebApp;
        
        // Обработчики событий
        newGameBtn.addEventListener('click', startNewGame);
        continueGameBtn.addEventListener('click', continueGame);
        howToPlayBtn.addEventListener('click', showHowToPlay);
        backFromHelpBtn.addEventListener('click', showMainMenu);
        backToMenuBtn.addEventListener('click', () => {
            saveGame();
            showMainMenu();
        });
        createPetBtn.addEventListener('click', createNewPet);
        cancelCreatePetBtn.addEventListener('click', showMainMenu);
        
        // Проверяем, есть ли сохранённая игра при загрузке
        window.addEventListener('DOMContentLoaded', () => {
            loadGame();
            
            if (gameState.gameStarted && gameState.pets.length > 0) {
                continueGameBtn.disabled = false;
            } else {
                continueGameBtn.disabled = true;
            }
            
            // Инициализируем Telegram Web App
            tg.expand();
            tg.MainButton.hide();
        });
        
        // Основные функции игры
        function startNewGame() {
            gameState = {
                pets: [],
                lastUpdate: Date.now(),
                gameStarted: true
            };
            showNewPetScreen();
        }
        
        function continueGame() {
            if (gameState.pets.length === 0) {
                alert('Нет сохранённых питомцев!');
                return;
            }
            
            updateGame();
            renderPets();
            showGameScreen();
            
            // Запускаем игровой цикл
            startGameLoop();
        }
        
        function showMainMenu() {
            mainMenu.classList.remove('hidden');
            howToPlay.classList.add('hidden');
            gameScreen.classList.add('hidden');
            newPetScreen.classList.add('hidden');
        }
        
        function showHowToPlay() {
            mainMenu.classList.add('hidden');
            howToPlay.classList.remove('hidden');
        }
        
        function showGameScreen() {
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }
        
        function showNewPetScreen() {
            mainMenu.classList.add('hidden');
            newPetScreen.classList.remove('hidden');
            petNameInput.value = '';
            petNameInput.focus();
        }
        
        function createNewPet() {
            const name = petNameInput.value.trim();
            if (name === '') {
                alert('Пожалуйста, введите имя питомца!');
                return;
            }
            
            const newPet = {
                id: Date.now().toString(),
                name: name,
                hunger: MAX_HUNGER / 2,
                energy: MAX_ENERGY / 2,
                happiness: MAX_HAPPINESS / 2,
                level: 1,
                lastFed: Date.now(),
                lastRested: Date.now(),
                lastPlayed: Date.now(),
                createdAt: Date.now()
            };
            
            gameState.pets.push(newPet);
            gameState.lastUpdate = Date.now();
            
            saveGame();
            updateGame();
            renderPets();
            showGameScreen();
            
            // Запускаем игровой цикл
            startGameLoop();
        }
        
        function updateGame() {
            const now = Date.now();
            const timePassed = (now - gameState.lastUpdate) / 1000; // в секундах
            gameState.lastUpdate = now;
            
            // Обновляем всех питомцев
            for (let pet of gameState.pets) {
                // Увеличиваем голод
                pet.hunger = Math.max(0, pet.hunger - HUNGER_RATE * timePassed);
                
                // Уменьшаем энергию
                pet.energy = Math.max(0, pet.energy - ENERGY_RATE * timePassed);
                
                // Уменьшаем счастье
                pet.happiness = Math.max(0, pet.happiness - HAPPINESS_RATE * timePassed);
                
                // Увеличиваем уровень, если питомец ухожен
                if (pet.hunger > 30 && pet.energy > 20 && pet.happiness > 25) {
                    pet.level = Math.min(MAX_LEVEL, pet.level + LEVEL_RATE * timePassed);
                }
                
                // Проверяем, достиг ли питомец максимального уровня для деления
                if (pet.level >= MAX_LEVEL) {
                    dividePet(pet);
                }
            }
            
            // Удаляем питомцев, которые "умерли" (если все показатели на нуле)
            gameState.pets = gameState.pets.filter(pet => 
                pet.hunger > 0 || pet.energy > 0 || pet.happiness > 0
            );
            
            // Если питомцев не осталось, показываем сообщение
            if (gameState.pets.length === 0 && gameState.gameStarted) {
                alert('Все ваши питомцы погибли! Игра начнётся заново.');
                showMainMenu();
                gameState.gameStarted = false;
                saveGame();
                return;
            }
            
            saveGame();
        }
        
        function dividePet(parentPet) {
            // Создаём двух новых питомцев на основе родителя
            const child1 = {
                id: Date.now().toString(),
                name: `${parentPet.name}-1`,
                hunger: MAX_HUNGER,
                energy: MAX_ENERGY,
                happiness: MAX_HAPPINESS,
                level: 1,
                lastFed: Date.now(),
                lastRested: Date.now(),
                lastPlayed: Date.now(),
                createdAt: Date.now()
            };
            
            const child2 = {
                id: (Date.now() + 1).toString(),
                name: `${parentPet.name}-2`,
                hunger: MAX_HUNGER,
                energy: MAX_ENERGY,
                happiness: MAX_HAPPINESS,
                level: 1,
                lastFed: Date.now(),
                lastRested: Date.now(),
                lastPlayed: Date.now(),
                createdAt: Date.now()
            };
            
            // Удаляем родителя и добавляем детей
            gameState.pets = gameState.pets.filter(pet => pet.id !== parentPet.id);
            gameState.pets.push(child1, child2);
            
            // Показываем уведомление о делении
            const notice = document.createElement('div');
            notice.className = 'evolution-notice';
            notice.textContent = `${parentPet.name} достиг максимального уровня и разделился на ${child1.name} и ${child2.name}!`;
            petsContainer.prepend(notice);
            
            // Удаляем уведомление через 5 секунд
            setTimeout(() => {
                notice.remove();
            }, 5000);
        }
        
        function renderPets() {
            petsContainer.innerHTML = '';
            
            if (gameState.pets.length === 0) {
                const noPetsMsg = document.createElement('p');
                noPetsMsg.textContent = 'У вас пока нет питомцев.';
                petsContainer.appendChild(noPetsMsg);
                return;
            }
            
            for (let pet of gameState.pets) {
                const petElement = document.createElement('div');
                petElement.className = 'pet';
                petElement.dataset.id = pet.id;
                
                const petStatus = getPetStatus(pet);
                
                petElement.innerHTML = `
                    <div class="pet-name">${pet.name} (${petStatus})</div>
                    <div class="pet-stats">
                        <div>Голод: ${Math.round(pet.hunger)}/${MAX_HUNGER}</div>
                        <div class="progress-container">
                            <div class="progress-bar hunger" style="width: ${(pet.hunger / MAX_HUNGER) * 100}%"></div>
                        </div>
                        
                        <div>Энергия: ${Math.round(pet.energy)}/${MAX_ENERGY}</div>
                        <div class="progress-container">
                            <div class="progress-bar energy" style="width: ${(pet.energy / MAX_ENERGY) * 100}%"></div>
                        </div>
                        
                        <div>Счастье: ${Math.round(pet.happiness)}/${MAX_HAPPINESS}</div>
                        <div class="progress-container">
                            <div class="progress-bar happiness" style="width: ${(pet.happiness / MAX_HAPPINESS) * 100}%"></div>
                        </div>
                        
                        <div>Уровень: ${Math.round(pet.level * 10) / 10}/${MAX_LEVEL}</div>
                        <div class="progress-container">
                            <div class="progress-bar level" style="width: ${(pet.level / MAX_LEVEL) * 100}%"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="feed-btn" ${pet.hunger >= MAX_HUNGER ? 'disabled' : ''}>Покормить</button>
                        <button class="rest-btn" ${pet.energy >= MAX_ENERGY ? 'disabled' : ''}>Отдых</button>
                        <button class="play-btn" ${pet.happiness >= MAX_HAPPINESS ? 'disabled' : ''}>Поиграть</button>
                    </div>
                `;
                
                // Добавляем обработчики действий
                petElement.querySelector('.feed-btn').addEventListener('click', () => feedPet(pet.id));
                petElement.querySelector('.rest-btn').addEventListener('click', () => restPet(pet.id));
                petElement.querySelector('.play-btn').addEventListener('click', () => playWithPet(pet.id));
                
                petsContainer.appendChild(petElement);
            }
        }
        
        function getPetStatus(pet) {
            if (pet.hunger <= 20 || pet.energy <= 15 || pet.happiness <= 10) {
                return '💀 Умирает';
            } else if (pet.hunger <= 40 || pet.energy <= 30 || pet.happiness <= 25) {
                return '😟 Плохо';
            } else if (pet.hunger <= 70 || pet.energy <= 60 || pet.happiness <= 50) {
                return '😐 Нормально';
            } else if (pet.level >= MAX_LEVEL * 0.8) {
                return '⚡ Готов к делению';
            } else {
                return '😊 Отлично';
            }
        }
        
        function feedPet(petId) {
            const pet = gameState.pets.find(p => p.id === petId);
            if (pet) {
                pet.hunger = Math.min(MAX_HUNGER, pet.hunger + FEED_AMOUNT);
                pet.lastFed = Date.now();
                saveGame();
                updateGame();
                renderPets();
            }
        }
        
        function restPet(petId) {
            const pet = gameState.pets.find(p => p.id === petId);
            if (pet) {
                pet.energy = Math.min(MAX_ENERGY, pet.energy + REST_AMOUNT);
                pet.lastRested = Date.now();
                saveGame();
                updateGame();
                renderPets();
            }
        }
        
        function playWithPet(petId) {
            const pet = gameState.pets.find(p => p.id === petId);
            if (pet) {
                pet.happiness = Math.min(MAX_HAPPINESS, pet.happiness + PLAY_AMOUNT);
                pet.lastPlayed = Date.now();
                saveGame();
                updateGame();
                renderPets();
            }
        }
        
        function startGameLoop() {
            // Останавливаем предыдущий цикл, если он был
            if (window.gameLoop) {
                clearInterval(window.gameLoop);
            }
            
            // Запускаем новый игровой цикл (обновление каждые 5 секунд)
            window.gameLoop = setInterval(() => {
                updateGame();
                renderPets();
            }, 5000);
        }
        
        // Сохранение и загрузка игры
        function saveGame() {
            localStorage.setItem('evolutionTamagotchi', JSON.stringify(gameState));
        }
        
        function loadGame() {
            const savedGame = localStorage.getItem('evolutionTamagotchi');
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);
                    // Проверяем, что загруженные данные имеют правильную структуру
                    if (parsed.pets && Array.isArray(parsed.pets)) {
                        gameState = parsed;
                    }
                } catch (e) {
                    console.error('Ошибка загрузки игры:', e);
                }
            }
        }
    </script>
</body>
</html>