<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тапики</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --color-primary: #8B4513;
            --color-secondary: #A0522D;
            --color-accent: #CD853F;
            --color-background: #F5DEB3;
            --color-text: #3E2723;
            --color-parchment: #F8F1E5;
        }

        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23A0522D" fill-opacity="0.1" d="M0 0h100v100H0z"/></svg>');
            background-size: 200px;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            box-sizing: border-box;
        }

        .parchment {
            background-color: var(--color-parchment);
            border: 15px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%238B4513" d="M0 0h100v100H0z"/></svg>') 30 round;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        h1, h2 {
            text-align: center;
            color: var(--color-primary);
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            font-variant: small-caps;
            margin-top: 0;
        }

        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Times New Roman', serif;
            transition: all 0.3s;
            margin: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background-color: var(--color-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        .pets-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .pet {
            position: relative;
            width: 120px;
            text-align: center;
        }

        .pet-svg {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            transition: all 0.3s;
            cursor: pointer;
        }

        .pet-svg:hover {
            transform: scale(1.1);
        }

        .pet-level {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--color-accent);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .pet-stats {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 5px;
            margin-top: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stat-bar {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }

        .stat-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .bar-container {
            flex-grow: 1;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            border-radius: 5px;
        }

        .hunger-bar {
            background-color: #FF9800;
        }

        .energy-bar {
            background-color: #4CAF50;
        }

        .happiness-bar {
            background-color: #E91E63;
        }

        .xp-bar {
            background-color: #2196F3;
        }

        .actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 8px 15px;
            font-size: 14px;
        }

        .pets-count {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: var(--color-primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .evolution-notice {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-parchment);
            padding: 20px;
            border: 5px solid var(--color-primary);
            border-radius: 10px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: pulse 1s infinite;
            font-weight: bold;
            font-size: 18px;
        }

        .how-to-play {
            text-align: left;
            line-height: 1.6;
        }

        .how-to-play ul {
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu" class="parchment">
            <h1>Тапики</h1>
            <p>Выращивайте своих мишек и наблюдайте за их эволюцией!</p>
            <div class="menu">
                <button id="new-game-btn">Новая игра</button>
                <button id="continue-game-btn">Продолжить</button>
                <button id="how-to-play-btn">Как играть?</button>
            </div>
        </div>

        <!-- Экран обучения -->
        <div id="how-to-play" class="parchment hidden">
            <h2>Как играть</h2>
            <div class="how-to-play">
                <p>1. У вас есть мишки с четырьмя характеристиками:</p>
                <ul>
                    <li><strong>Голод</strong> - кормите мишку, чтобы уменьшить голод</li>
                    <li><strong>Энергия</strong> - давайте мишке отдыхать, чтобы восстановить энергию</li>
                    <li><strong>Счастье</strong> - играйте с мишкой, чтобы увеличить счастье</li>
                    <li><strong>Опыт</strong> - растёт при хорошем уходе</li>
                </ul>
                <p>2. Когда мишка получает +3 уровня, она автоматически эволюционирует.</p>
                <p>3. Вы можете ухаживать за всеми мишками одновременно.</p>
                <p>4. Игра автоматически сохраняется.</p>
            </div>
            <button id="back-from-help" class="action-btn">Назад</button>
        </div>

        <!-- Игровой экран -->
        <div id="game-screen" class="parchment hidden">
            <h2>Ваши мишки</h2>
            <div id="pets-count" class="pets-count">Мишки: 0</div>
            <div id="pets-container" class="pets-container"></div>
            <div class="actions">
                <button id="feed-btn" class="action-btn">Покормить всех</button>
                <button id="rest-btn" class="action-btn">Отдохнуть всем</button>
                <button id="play-btn" class="action-btn">Поиграть со всеми</button>
                <button id="back-to-menu" class="action-btn">В меню</button>
            </div>
        </div>
    </div>

    <script>
        // Игровые константы
        const MAX_STAT = 100;
        const MAX_XP = 100;
        
        const HUNGER_RATE = 1.5;
        const ENERGY_RATE = 1.2;
        const HAPPINESS_RATE = 1;
        const XP_RATE = 0.8;
        
        const FEED_AMOUNT = 25;
        const REST_AMOUNT = 30;
        const PLAY_AMOUNT = 20;
        const XP_PER_ACTION = 5;
        
        const EVOLUTION_LEVELS = 3;
        
        // Цвета для мишек
        const BEAR_COLORS = [
            '#8B4513', // Коричневый
            '#A0522D', // Сиена
            '#CD853F', // Перу
            '#D2691E', // Шоколад
            '#B8860B', // Темно-золотой
            '#DAA520'  // Золотой дуб
        ];
        
        // Состояние игры
        let gameState = {
            bears: [],
            lastUpdate: Date.now(),
            gameStarted: false
        };
        
        // Элементы интерфейса
        const mainMenu = document.getElementById('main-menu');
        const howToPlay = document.getElementById('how-to-play');
        const gameScreen = document.getElementById('game-screen');
        const petsContainer = document.getElementById('pets-container');
        const petsCount = document.getElementById('pets-count');
        
        // Кнопки
        const newGameBtn = document.getElementById('new-game-btn');
        const continueGameBtn = document.getElementById('continue-game-btn');
        const howToPlayBtn = document.getElementById('how-to-play-btn');
        const backFromHelpBtn = document.getElementById('back-from-help');
        const backToMenuBtn = document.getElementById('back-to-menu');
        const feedBtn = document.getElementById('feed-btn');
        const restBtn = document.getElementById('rest-btn');
        const playBtn = document.getElementById('play-btn');
        
        // Инициализация Telegram Web App
        let tg = window.Telegram.WebApp;
        
        // Обработчики событий
        newGameBtn.addEventListener('click', startNewGame);
        continueGameBtn.addEventListener('click', continueGame);
        howToPlayBtn.addEventListener('click', showHowToPlay);
        backFromHelpBtn.addEventListener('click', showMainMenu);
        backToMenuBtn.addEventListener('click', () => {
            saveGame();
            showMainMenu();
        });
        feedBtn.addEventListener('click', feedAllBears);
        restBtn.addEventListener('click', restAllBears);
        playBtn.addEventListener('click', playWithAllBears);
        
        // Проверяем, есть ли сохранённая игра при загрузке
        window.addEventListener('DOMContentLoaded', () => {
            loadGame();
            
            if (gameState.gameStarted && gameState.bears.length > 0) {
                continueGameBtn.disabled = false;
            } else {
                continueGameBtn.disabled = true;
            }
            
            // Инициализируем Telegram Web App
            tg.expand();
            tg.MainButton.hide();
        });
        
        // Основные функции игры
        function startNewGame() {
            gameState = {
                bears: [createNewBear()],
                lastUpdate: Date.now(),
                gameStarted: true
            };
            
            updateGame();
            renderBears();
            showGameScreen();
            startGameLoop();
        }
        
        function createNewBear() {
            const color = BEAR_COLORS[Math.floor(Math.random() * BEAR_COLORS.length)];
            return {
                id: Date.now().toString(),
                color: color,
                hunger: MAX_STAT / 2,
                energy: MAX_STAT / 2,
                happiness: MAX_STAT / 2,
                xp: 0,
                level: 1,
                evolution: 0,
                lastFed: Date.now(),
                lastRested: Date.now(),
                lastPlayed: Date.now(),
                createdAt: Date.now()
            };
        }
        
        function continueGame() {
            if (gameState.bears.length === 0) {
                gameState.bears.push(createNewBear());
            }
            
            updateGame();
            renderBears();
            showGameScreen();
            startGameLoop();
        }
        
        function showMainMenu() {
            mainMenu.classList.remove('hidden');
            howToPlay.classList.add('hidden');
            gameScreen.classList.add('hidden');
        }
        
        function showHowToPlay() {
            mainMenu.classList.add('hidden');
            howToPlay.classList.remove('hidden');
        }
        
        function showGameScreen() {
            mainMenu.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            updatePetsCount();
        }
        
        function updateGame() {
            const now = Date.now();
            const timePassed = (now - gameState.lastUpdate) / 1000;
            gameState.lastUpdate = now;
            
            // Обновляем всех мишек
            for (let bear of gameState.bears) {
                // Уменьшаем характеристики
                bear.hunger = Math.max(0, bear.hunger - HUNGER_RATE * timePassed);
                bear.energy = Math.max(0, bear.energy - ENERGY_RATE * timePassed);
                bear.happiness = Math.max(0, bear.happiness - HAPPINESS_RATE * timePassed);
                
                // Увеличиваем опыт, если мишка ухожена
                if (bear.hunger > 30 && bear.energy > 20 && bear.happiness > 25) {
                    bear.xp = Math.min(MAX_XP, bear.xp + XP_RATE * timePassed);
                }
                
                // Проверяем, набрался ли опыт для уровня
                if (bear.xp >= MAX_XP) {
                    bear.xp = 0;
                    bear.level++;
                    
                    // Проверяем, достигнута ли эволюция
                    if (bear.level >= (bear.evolution + 1) * EVOLUTION_LEVELS) {
                        bear.evolution++;
                        showEvolutionNotice(bear);
                    }
                }
            }
            
            // Удаляем "умерших" мишек (если все показатели на нуле)
            gameState.bears = gameState.bears.filter(bear => 
                bear.hunger > 0 || bear.energy > 0 || bear.happiness > 0
            );
            
            // Если мишек не осталось, создаём новую
            if (gameState.bears.length === 0 && gameState.gameStarted) {
                gameState.bears.push(createNewBear());
            }
            
            saveGame();
            updatePetsCount();
        }
        
        function showEvolutionNotice(bear) {
            const notice = document.createElement('div');
            notice.className = 'evolution-notice';
            notice.innerHTML = `
                <div>Мишка эволюционировал!</div>
                <div>Уровень: ${bear.level}</div>
                <div>Этап эволюции: ${bear.evolution}</div>
            `;
            
            document.body.appendChild(notice);
            
            setTimeout(() => {
                notice.remove();
            }, 3000);
        }
        
        function renderBears() {
            petsContainer.innerHTML = '';
            
            if (gameState.bears.length === 0) {
                const noPetsMsg = document.createElement('p');
                noPetsMsg.textContent = 'У вас пока нет мишек.';
                petsContainer.appendChild(noPetsMsg);
                return;
            }
            
            for (let bear of gameState.bears) {
                const bearElement = document.createElement('div');
                bearElement.className = 'pet';
                
                // Создаем SVG мишки
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute("viewBox", "0 0 100 100");
                svg.setAttribute("class", "pet-svg");
                svg.innerHTML = `
                    <circle cx="50" cy="40" r="30" fill="${bear.color}"/>
                    <circle cx="40" cy="35" r="5" fill="black"/>
                    <circle cx="60" cy="35" r="5" fill="black"/>
                    <path d="M40 50 Q50 60 60 50" stroke="black" stroke-width="2" fill="none"/>
                    <circle cx="35" cy="25" r="5" fill="${bear.color}"/>
                    <circle cx="65" cy="25" r="5" fill="${bear.color}"/>
                `;
                
                // Анимация для активных мишек
                if (bear.hunger > 30 && bear.energy > 30 && bear.happiness > 30) {
                    svg.style.animation = "bounce 1s infinite";
                }
                
                bearElement.appendChild(svg);
                
                // Уровень мишки
                const levelElement = document.createElement('div');
                levelElement.className = 'pet-level';
                levelElement.textContent = bear.level;
                bearElement.appendChild(levelElement);
                
                // Статистика мишки
                const statsElement = document.createElement('div');
                statsElement.className = 'pet-stats';
                
                statsElement.innerHTML = `
                    <div class="stat-bar">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="#FF9800">
                            <path d="M12,3C8.14,3 5,6.14 5,10C5,12.38 6.19,14.47 8,15.74V17C8,17.55 8.45,18 9,18H15C15.55,18 16,17.55 16,17V15.74C17.81,14.47 19,12.38 19,10C19,6.14 15.86,3 12,3M9,20V21C9,21.55 9.45,22 10,22H14C14.55,22 15,21.55 15,21V20H9Z"/>
                        </svg>
                        <div class="bar-container">
                            <div class="bar hunger-bar" style="width: ${(bear.hunger / MAX_STAT) * 100}%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="#4CAF50">
                            <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M17,8.4L13.4,12L17,15.6L15.6,17L12,13.4L8.4,17L7,15.6L10.6,12L7,8.4L8.4,7L12,10.6L15.6,7L17,8.4Z"/>
                        </svg>
                        <div class="bar-container">
                            <div class="bar energy-bar" style="width: ${(bear.energy / MAX_STAT) * 100}%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="#E91E63">
                            <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/>
                        </svg>
                        <div class="bar-container">
                            <div class="bar happiness-bar" style="width: ${(bear.happiness / MAX_STAT) * 100}%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <svg class="stat-icon" viewBox="0 0 24 24" fill="#2196F3">
                            <path d="M12,2L4,5V11.09C4,16.14 7.41,20.85 12,22C16.59,20.85 20,16.14 20,11.09V5L12,2M14.5,14.59L12,12.09L9.5,14.59L8.09,13.18L10.59,10.68L8.09,8.18L9.5,6.77L12,9.27L14.5,6.77L15.91,8.18L13.41,10.68L15.91,13.18L14.5,14.59Z"/>
                        </svg>
                        <div class="bar-container">
                            <div class="bar xp-bar" style="width: ${(bear.xp / MAX_XP) * 100}%"></div>
                        </div>
                    </div>
                `;
                
                bearElement.appendChild(statsElement);
                petsContainer.appendChild(bearElement);
            }
        }
        
        function feedAllBears() {
            for (let bear of gameState.bears) {
                if (bear.hunger < MAX_STAT) {
                    bear.hunger = Math.min(MAX_STAT, bear.hunger + FEED_AMOUNT);
                    bear.xp = Math.min(MAX_XP, bear.xp + XP_PER_ACTION);
                    bear.lastFed = Date.now();
                }
            }
            saveGame();
            updateGame();
            renderBears();
        }
        
        function restAllBears() {
            for (let bear of gameState.bears) {
                if (bear.energy < MAX_STAT) {
                    bear.energy = Math.min(MAX_STAT, bear.energy + REST_AMOUNT);
                    bear.xp = Math.min(MAX_XP, bear.xp + XP_PER_ACTION);
                    bear.lastRested = Date.now();
                }
            }
            saveGame();
            updateGame();
            renderBears();
        }
        
        function playWithAllBears() {
            for (let bear of gameState.bears) {
                if (bear.happiness < MAX_STAT) {
                    bear.happiness = Math.min(MAX_STAT, bear.happiness + PLAY_AMOUNT);
                    bear.xp = Math.min(MAX_XP, bear.xp + XP_PER_ACTION);
                    bear.lastPlayed = Date.now();
                }
            }
            saveGame();
            updateGame();
            renderBears();
        }
        
        function updatePetsCount() {
            petsCount.textContent = `Мишки: ${gameState.bears.length}`;
        }
        
        function startGameLoop() {
            if (window.gameLoop) {
                clearInterval(window.gameLoop);
            }
            
            window.gameLoop = setInterval(() => {
                updateGame();
                renderBears();
            }, 3000);
        }
        
        // Сохранение и загрузка игры
        function saveGame() {
            localStorage.setItem('tapikiGame', JSON.stringify(gameState));
        }
        
        function loadGame() {
            const savedGame = localStorage.getItem('tapikiGame');
            if (savedGame) {
                try {
                    const parsed = JSON.parse(savedGame);
                    if (parsed.bears && Array.isArray(parsed.bears)) {
                        gameState = parsed;
                    }
                } catch (e) {
                    console.error('Ошибка загрузки игры:', e);
                }
            }
        }
    </script>
</body>
</html>