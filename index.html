<!DOCTYPE html>
<html>
<head>
    <title>Cosmo Cows</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            touch-action: none;
            background: #000;
            font-family: 'Arial', sans-serif;
        }
        #gameCanvas {
            background: #000;
        }
        .menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 10, 30, 0.9);
            padding: 30px;
            color: white;
            text-align: center;
            border-radius: 15px;
            border: 1px solid #3a7bd5;
            box-shadow: 0 0 20px rgba(58, 123, 213, 0.6);
            z-index: 1000;
            max-width: 80%;
        }
        .menu h1 {
            color: #3a7bd5;
            text-shadow: 0 0 10px rgba(58, 123, 213, 0.8);
            margin-bottom: 20px;
        }
        .menu button {
            padding: 12px 25px;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
            background: linear-gradient(to right, #3a7bd5, #00d2ff);
            border: none;
            color: white;
            border-radius: 25px;
            transition: all 0.3s;
        }
        .menu button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(58, 123, 213, 0.8);
        }
        #hud {
            position: fixed;
            top: 15px;
            left: 15px;
            color: white;
            background: rgba(0, 10, 30, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #3a7bd5;
            display: flex;
            gap: 20px;
            font-size: 18px;
        }
        .hearts {
            color: #ff3e3e;
            letter-spacing: 3px;
        }
        #timer {
            color: #00d2ff;
        }
        #stats {
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="mainMenu" class="menu">
        <h1>Cosmo Cows</h1>
        <p>Защитите галактику от космических коров!</p>
        <button onclick="startGame()">Начать миссию</button>
    </div>

    <div id="gameOverMenu" class="menu" style="display: none;">
        <h1>Миссия завершена</h1>
        <p>Попаданий: <span id="finalHits">0</span></p>
        <p>Промахов: <span id="finalMisses">0</span></p>
        <p>Точность: <span id="finalAccuracy">0</span>%</p>
        <p>Счет: <span id="finalScore">0</span></p>
        <button onclick="startGame()">Повторить миссию</button>
    </div>

    <div id="hud">
        <div class="hearts" id="lives">❤❤❤</div>
        <div id="timer">1:00</div>
        <div id="stats">0/0</div>
        <div id="ammo">5</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameActive = false;
        let cows = [];
        let shots = [];
        let stars = [];
        let nebulae = [];
        let score = 0;
        let lives = 3;
        let timeLeft = 60;
        let hits = 0;
        let misses = 0;
        let ammo = 5;
        let isReloading = false;
        let gameTimer;
        let lastSpawnTime = 0;

        // Configuration
        const config = {
            cowSpeed: 1.2,
            spawnInterval: 1000,
            maxCows: 12,
            cowWidth: 60,
            cowHeight: 40,
            reloadTime: 2000,
            starCount: 200,
            nebulaCount: 3
        };

        // Cow types
        const cowTypes = [
            { color: '#a8e6cf', helmetColor: 'rgba(100, 200, 255, 0.3)', score: 100 },
            { color: '#dcedc1', helmetColor: 'rgba(150, 240, 200, 0.3)', score: 150 },
            { color: '#ffd3b6', helmetColor: 'rgba(255, 200, 150, 0.3)', score: 200 },
            { color: '#ffaaa5', helmetColor: 'rgba(255, 150, 150, 0.3)', score: 250 }
        ];

        // Initialize stars
        for (let i = 0; i < config.starCount; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 1.5,
                speed: 0.2 + Math.random() * 0.8
            });
        }

        // Initialize nebulae
        for (let i = 0; i < config.nebulaCount; i++) {
            nebulae.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: 100 + Math.random() * 200,
                color: `rgba(58, 123, 213, ${0.05 + Math.random() * 0.1})`
            });
        }

        class Cow {
            constructor() {
                this.type = Math.floor(Math.random() * cowTypes.length);
                this.width = config.cowWidth;
                this.height = config.cowHeight;
                this.reset();
                this.health = 1;
                this.hitAnim = 0;
                this.isDying = false;
                this.deathAnim = 0;
            }

            reset() {
                // Randomly choose left or right side
                const side = Math.random() > 0.5 ? -this.width : canvas.width;
                
                this.x = side;
                this.y = 50 + Math.random() * (canvas.height - 100);
                
                // Move from left to right or vice versa
                this.vx = side < 0 ? config.cowSpeed : -config.cowSpeed;
                this.vy = (Math.random() - 0.5) * 0.5;
                
                // Random speed variation
                const speedVar = 0.7 + Math.random() * 0.6;
                this.vx *= speedVar;
                this.vy *= speedVar;
                
                this.color = cowTypes[this.type].color;
                this.helmetColor = cowTypes[this.type].helmetColor;
                this.scoreValue = cowTypes[this.type].score;
            }

            update() {
                if (this.isDying) {
                    this.deathAnim += 0.05;
                    if (this.deathAnim >= 1) {
                        this.reset();
                        this.isDying = false;
                        this.deathAnim = 0;
                        this.health = 1;
                    }
                    return;
                }
                
                if (this.hitAnim > 0) {
                    this.hitAnim -= 0.1;
                }
                
                this.x += this.vx;
                this.y += this.vy;
                
                // Bounce off top and bottom
                if (this.y < this.height/2 || this.y > canvas.height - this.height/2) {
                    this.vy = -this.vy;
                }
                
                // Reset when off screen
                if ((this.vx > 0 && this.x > canvas.width + this.width) || 
                    (this.vx < 0 && this.x < -this.width)) {
                    this.reset();
                }
            }

            draw() {
                if (this.isDying) {
                    // Death animation
                    const size = 1 + this.deathAnim * 2;
                    const alpha = 1 - this.deathAnim;
                    
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.scale(size, size);
                    
                    // Explosion particles
                    for (let i = 0; i < 5; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const dist = this.deathAnim * 30;
                        ctx.fillStyle = `rgba(255, ${100 + Math.random() * 155}, 0, ${alpha})`;
                        ctx.beginPath();
                        ctx.arc(
                            Math.cos(angle) * dist, 
                            Math.sin(angle) * dist, 
                            3 + Math.random() * 4, 
                            0, 
                            Math.PI * 2
                        );
                        ctx.fill();
                    }
                    
                    ctx.restore();
                    return;
                }
                
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // Hit animation
                if (this.hitAnim > 0) {
                    ctx.scale(1 + this.hitAnim * 0.3, 1 + this.hitAnim * 0.3);
                }
                
                // Body
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.roundRect(-this.width/2, -this.height/2, this.width, this.height, [this.width/4]);
                ctx.fill();
                
                // Spots
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                for (let i = 0; i < 5; i++) {
                    const spotX = -this.width/3 + Math.random() * (this.width/1.5);
                    const spotY = -this.height/3 + Math.random() * (this.height/1.5);
                    const spotSize = 3 + Math.random() * 5;
                    ctx.beginPath();
                    ctx.arc(spotX, spotY, spotSize, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Helmet
                ctx.strokeStyle = 'rgba(100, 200, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.fillStyle = this.helmetColor;
                ctx.beginPath();
                ctx.arc(0, -this.height/6, this.width/2.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                
                // Eyes
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(this.width/6, -this.height/6, 3, 0, Math.PI * 2);
                ctx.arc(-this.width/6, -this.height/6, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Wings
                ctx.fillStyle = 'rgba(200, 240, 255, 0.6)';
                ctx.beginPath();
                ctx.moveTo(this.width/2, -this.height/4);
                ctx.lineTo(this.width/2 + 15, 0);
                ctx.lineTo(this.width/2, this.height/4);
                ctx.closePath();
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(-this.width/2, -this.height/4);
                ctx.lineTo(-this.width/2 - 15, 0);
                ctx.lineTo(-this.width/2, this.height/4);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }
            
            hit() {
                this.health -= 0.4;
                this.hitAnim = 1;
                
                if (this.health <= 0) {
                    this.isDying = true;
                    return true;
                }
                return false;
            }
        }

        class Shot {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 3;
                this.alpha = 1;
                this.speed = 15;
                this.angle = Math.atan2(y - canvas.height/2, x - canvas.width/2);
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = `rgba(0, 200, 255, ${this.alpha})`;
                ctx.fill();
                
                // Glow effect
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 2, 0, Math.PI*2);
                ctx.fillStyle = `rgba(0, 150, 255, ${this.alpha * 0.3})`;
                ctx.fill();
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.alpha -= 0.05;
            }
        }

        function startGame() {
            gameActive = true;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameOverMenu').style.display = 'none';
            
            // Reset game state
            cows = [];
            shots = [];
            score = 0;
            lives = 3;
            timeLeft = 60;
            hits = 0;
            misses = 0;
            ammo = 5;
            isReloading = false;
            lastSpawnTime = 0;
            
            updateHUD();
            resizeCanvas();
            
            gameTimer = setInterval(() => {
                timeLeft--;
                updateHUD();
                if(timeLeft <= 0) endGame();
            }, 1000);
            
            gameLoop();
        }

        function endGame() {
            gameActive = false;
            clearInterval(gameTimer);
            document.getElementById('gameOverMenu').style.display = 'block';
            document.getElementById('finalHits').textContent = hits;
            document.getElementById('finalMisses').textContent = misses;
            document.getElementById('finalScore').textContent = score;
            
            const accuracy = hits + misses > 0 ? Math.round((hits / (hits + misses)) * 100 : 0;
            document.getElementById('finalAccuracy').textContent = accuracy;
        }

        function updateHUD() {
            document.getElementById('lives').textContent = '❤'.repeat(lives);
            document.getElementById('timer').textContent = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2, '0')}`;
            document.getElementById('stats').textContent = `${hits}/${hits + misses}`;
            document.getElementById('ammo').textContent = ammo;
        }

        function spawnCow() {
            if (!gameActive || cows.length >= config.maxCows) return;
            
            cows.push(new Cow());
        }

        function checkHit(x, y) {
            let hit = false;
            
            for (let i = cows.length - 1; i >= 0; i--) {
                const cow = cows[i];
                if (cow.isDying) continue;
                
                const left = cow.x - cow.width/2;
                const right = cow.x + cow.width/2;
                const top = cow.y - cow.height/2;
                const bottom = cow.y + cow.height/2;
                
                if (x >= left && x <= right && y >= top && y <= bottom) {
                    if (cow.hit()) {
                        score += cow.scoreValue;
                        hits++;
                    }
                    hit = true;
                    break;
                }
            }
            
            if (!hit && ammo > 0) {
                misses++;
            }
            
            updateHUD();
            return hit;
        }

        function drawBackground() {
            // Stars
            ctx.fillStyle = 'white';
            stars.forEach(star => {
                star.x -= star.speed;
                if (star.x < 0) {
                    star.x = canvas.width;
                    star.y = Math.random() * canvas.height;
                }
                
                ctx.globalAlpha = 0.5 + Math.random() * 0.5;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
            
            // Nebulae
            nebulae.forEach(nebula => {
                ctx.fillStyle = nebula.color;
                ctx.beginPath();
                ctx.arc(nebula.x, nebula.y, nebula.radius, 0, Math.PI*2);
                ctx.fill();
                
                // Move nebulae slightly
                nebula.x += 0.1;
                if (nebula.x > canvas.width + nebula.radius) {
                    nebula.x = -nebula.radius;
                    nebula.y = Math.random() * canvas.height;
                }
            });
        }

        function gameLoop(timestamp) {
            if (!gameActive) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawBackground();
            
            // Spawn cows at intervals
            if (timestamp - lastSpawnTime > config.spawnInterval) {
                spawnCow();
                lastSpawnTime = timestamp;
            }
            
            // Update and draw cows
            cows.forEach(cow => {
                cow.update();
                cow.draw();
            });
            
            // Update and draw shots
            for (let i = shots.length - 1; i >= 0; i--) {
                shots[i].update();
                shots[i].draw();
                
                if (shots[i].alpha <= 0) {
                    shots.splice(i, 1);
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Reinitialize stars and nebulae for new canvas size
            stars = [];
            for (let i = 0; i < config.starCount; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5,
                    speed: 0.2 + Math.random() * 0.8
                });
            }
            
            nebulae = [];
            for (let i = 0; i < config.nebulaCount; i++) {
                nebulae.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: 100 + Math.random() * 200,
                    color: `rgba(58, 123, 213, ${0.05 + Math.random() * 0.1})`
                });
            }
        }

        canvas.addEventListener('pointerdown', (e) => {
            if (!gameActive) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (isReloading) return;
            
            if (ammo > 0) {
                ammo--;
                checkHit(x, y);
                shots.push(new Shot(x, y));
            } else {
                misses++;
                lives--;
                if (lives <= 0) endGame();
                isReloading = true;
                setTimeout(() => {
                    ammo = 5;
                    isReloading = false;
                    updateHUD();
                }, config.reloadTime);
            }
            updateHUD();
        });

        window.addEventListener('resize', resizeCanvas);
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>