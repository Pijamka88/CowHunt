<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эволюционный Тамагочи</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
        }
        
        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .pet-display {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 8px;
        }
        
        .pet-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stat-name {
            font-weight: bold;
            color: #7f8c8d;
        }
        
        .stat-value {
            color: #2c3e50;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #2ecc71;
            width: 0%;
            transition: width 0.3s;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-button {
            background-color: #27ae60;
        }
        
        .action-button:hover {
            background-color: #219653;
        }
        
        .special-button {
            background-color: #e67e22;
        }
        
        .special-button:hover {
            background-color: #d35400;
        }
        
        .pet-evolution {
            margin-top: 20px;
            padding: 10px;
            background-color: #d5f5e3;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .pet-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .pet-card {
            background-color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            width: 150px;
            text-align: center;
        }
        
        .select-pet {
            background-color: #9b59b6;
        }
        
        .select-pet:hover {
            background-color: #8e44ad;
        }
        
        .back-button {
            background-color: #e74c3c;
            margin-top: 20px;
        }
        
        .back-button:hover {
            background-color: #c0392b;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ecc71;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .show-notification {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div id="main-menu" class="container">
        <h1>Эволюционный Тамагочи</h1>
        <div class="menu">
            <button id="new-game-btn">Новая игра</button>
            <button id="continue-game-btn">Продолжить игру</button>
            <button id="about-btn">Об игре</button>
        </div>
    </div>
    
    <div id="game-screen" class="container" style="display: none;">
        <h2 id="game-title">Мой питомец</h2>
        <div id="single-pet-view">
            <div class="pet-display">
                <h3 id="pet-name">Имя</h3>
                <div id="pet-stage">Стадия: Яйцо</div>
                <div class="pet-stats">
                    <div class="stat">
                        <div class="stat-name">Голод</div>
                        <div class="stat-value" id="hunger-value">50%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="hunger-bar"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-name">Энергия</div>
                        <div class="stat-value" id="energy-value">50%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="energy-bar"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-name">Счастье</div>
                        <div class="stat-value" id="happiness-value">50%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="happiness-bar"></div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-name">Опыт</div>
                        <div class="stat-value" id="exp-value">0/100</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="exp-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="pet-evolution" id="evolution-message">
                    Ваш питомец готов к эволюции!
                </div>
            </div>
            <div class="actions">
                <button class="action-button" id="feed-btn">Покормить</button>
                <button class="action-button" id="play-btn">Поиграть</button>
                <button class="action-button" id="sleep-btn">Уложить спать</button>
                <button class="action-button" id="train-btn">Тренировать</button>
                <button class="special-button" id="evolve-btn" disabled>Эволюционировать</button>
                <button class="special-button" id="divide-btn" disabled>Разделиться</button>
            </div>
        </div>
        <div id="multi-pet-view" style="display: none;">
            <h3>Ваши питомцы</h3>
            <div class="pet-container" id="pets-container">
                <!-- Pet cards will be added here dynamically -->
            </div>
        </div>
        <button class="back-button" id="back-to-menu-btn">В меню</button>
    </div>
    
    <div id="new-game-screen" class="container" style="display: none;">
        <h2>Новая игра</h2>
        <div style="margin-bottom: 20px;">
            <label for="pet-name-input">Имя питомца:</label>
            <input type="text" id="pet-name-input" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div style="margin-bottom: 20px;">
            <label>Тип питомца:</label>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                <label><input type="radio" name="pet-type" value="plant" checked> Растение (медленный рост, низкие потребности)</label>
                <label><input type="radio" name="pet-type" value="animal"> Животное (средний рост, баланс)</label>
                <label><input type="radio" name="pet-type" value="alien"> Инопланетянин (быстрый рост, высокие потребности)</label>
            </div>
        </div>
        <button id="start-game-btn">Начать игру</button>
        <button class="back-button" id="back-to-menu-btn-2">В меню</button>
    </div>
    
    <div id="about-screen" class="container" style="display: none;">
        <h2>Об игре</h2>
        <p>Эволюционный Тамагочи - это игра, где вы заботитесь о цифровом питомце, который со временем эволюционирует и размножается.</p>
        <h3>Как играть:</h3>
        <ul>
            <li>Ухаживайте за питомцем: кормите, играйте, укладывайте спать</li>
            <li>Тренируйте питомца, чтобы он получал опыт</li>
            <li>При достижении достаточного уровня питомец эволюционирует</li>
            <li>На высоких уровнях питомец может разделиться, создав колонию</li>
            <li>Следите за показателями: голод, энергия, счастье</li>
        </ul>
        <button class="back-button" id="back-to-menu-btn-3">В меню</button>
    </div>

    <script>
        // Game state
        const gameState = {
            pets: [],
            currentPetIndex: 0,
            gameStarted: false,
            lastUpdateTime: Date.now()
        };
        
        // Pet types
        const PET_TYPES = {
            plant: {
                name: "Растение",
                hungerRate: 0.3,
                energyRate: 0.2,
                happinessRate: 0.2,
                expGain: 0.5,
                evolutionThreshold: 3
            },
            animal: {
                name: "Животное",
                hungerRate: 0.5,
                energyRate: 0.5,
                happinessRate: 0.5,
                expGain: 1,
                evolutionThreshold: 5
            },
            alien: {
                name: "Инопланетянин",
                hungerRate: 0.8,
                energyRate: 0.7,
                happinessRate: 0.7,
                expGain: 1.5,
                evolutionThreshold: 7
            }
        };
        
        // Evolution stages
        const EVOLUTION_STAGES = [
            "Яйцо",
            "Детеныш",
            "Подросток",
            "Взрослый",
            "Совершенный",
            "Легендарный"
        ];
        
        // DOM elements
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const newGameScreen = document.getElementById('new-game-screen');
        const aboutScreen = document.getElementById('about-screen');
        const notification = document.getElementById('notification');
        
        // Main menu buttons
        document.getElementById('new-game-btn').addEventListener('click', () => {
            mainMenu.style.display = 'none';
            newGameScreen.style.display = 'block';
        });
        
        document.getElementById('continue-game-btn').addEventListener('click', () => {
            loadGame();
            if (gameState.gameStarted) {
                mainMenu.style.display = 'none';
                gameScreen.style.display = 'block';
                updateGameView();
            } else {
                showNotification('Нет сохраненной игры');
            }
        });
        
        document.getElementById('about-btn').addEventListener('click', () => {
            mainMenu.style.display = 'none';
            aboutScreen.style.display = 'block';
        });
        
        // Back buttons
        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            saveGame();
            gameScreen.style.display = 'none';
            mainMenu.style.display = 'block';
        });
        
        document.getElementById('back-to-menu-btn-2').addEventListener('click', () => {
            newGameScreen.style.display = 'none';
            mainMenu.style.display = 'block';
        });
        
        document.getElementById('back-to-menu-btn-3').addEventListener('click', () => {
            aboutScreen.style.display = 'none';
            mainMenu.style.display = 'block';
        });
        
        // New game buttons
        document.getElementById('start-game-btn').addEventListener('click', () => {
            const petName = document.getElementById('pet-name-input').value.trim();
            const petType = document.querySelector('input[name="pet-type"]:checked').value;
            
            if (petName === '') {
                showNotification('Введите имя питомца');
                return;
            }
            
            startNewGame(petName, petType);
            newGameScreen.style.display = 'none';
            gameScreen.style.display = 'block';
        });
        
        // Game buttons
        document.getElementById('feed-btn').addEventListener('click', () => {
            const pet = gameState.pets[gameState.currentPetIndex];
            pet.hunger = Math.min(100, pet.hunger + 30);
            pet.energy = Math.max(0, pet.energy - 5);
            updateGameView();
            showNotification(`${pet.name} покормлен!`);
        });
        
        document.getElementById('play-btn').addEventListener('click', () => {
            const pet = gameState.pets[gameState.currentPetIndex];
            pet.happiness = Math.min(100, pet.happiness + 25);
            pet.energy = Math.max(0, pet.energy - 15);
            pet.hunger = Math.max(0, pet.hunger - 10);
            updateGameView();
            showNotification(`Вы поиграли с ${pet.name}!`);
        });
        
        document.getElementById('sleep-btn').addEventListener('click', () => {
            const pet = gameState.pets[gameState.currentPetIndex];
            pet.energy = Math.min(100, pet.energy + 40);
            pet.hunger = Math.max(0, pet.hunger - 15);
            updateGameView();
            showNotification(`${pet.name} поспал и восстановил силы!`);
        });
        
        document.getElementById('train-btn').addEventListener('click', () => {
            const pet = gameState.pets[gameState.currentPetIndex];
            if (pet.energy < 20) {
                showNotification(`${pet.name} слишком устал для тренировки!`);
                return;
            }
            
            const expGain = PET_TYPES[pet.type].expGain;
            pet.exp += expGain;
            pet.energy = Math.max(0, pet.energy - 20);
            pet.hunger = Math.max(0, pet.hunger - 15);
            pet.happiness = Math.max(0, pet.happiness - 5);
            
            // Check for level up
            const expNeeded = getExpForNextLevel(pet.level);
            if (pet.exp >= expNeeded) {
                pet.exp -= expNeeded;
                pet.level++;
                showNotification(`${pet.name} достиг уровня ${pet.level}!`);
                
                // Check for evolution
                const petTypeInfo = PET_TYPES[pet.type];
                if (pet.level % petTypeInfo.evolutionThreshold === 0 && pet.evolutionStage < EVOLUTION_STAGES.length - 1) {
                    pet.canEvolve = true;
                    document.getElementById('evolution-message').style.display = 'block';
                    showNotification(`${pet.name} готов к эволюции!`);
                }
                
                // Check for division
                if (pet.level >= 10 && pet.level % 5 === 0 && gameState.pets.length < 5) {
                    pet.canDivide = true;
                    showNotification(`${pet.name} готов к делению!`);
                }
            }
            
            updateGameView();
            showNotification(`Вы потренировали ${pet.name}! (+${expGain} опыта)`);
        });
        
        document.getElementById('evolve-btn').addEventListener('click', () => {
            const pet = gameState.pets[gameState.currentPetIndex];
            if (pet.canEvolve) {
                pet.evolutionStage++;
                pet.canEvolve = false;
                document.getElementById('evolution-message').style.display = 'none';
                updateGameView();
                showNotification(`${pet.name} эволюционировал в ${EVOLUTION_STAGES[pet.evolutionStage]}!`);
            }
        });
        
        document.getElementById('divide-btn').addEventListener('click', () => {
            const pet = gameState.pets[gameState.currentPetIndex];
            if (pet.canDivide && gameState.pets.length < 5) {
                const newPet = {
                    ...JSON.parse(JSON.stringify(pet)),
                    name: `${pet.name}-${gameState.pets.length + 1}`,
                    canDivide: false,
                    exp: 0,
                    level: Math.floor(pet.level / 2)
                };
                
                gameState.pets.push(newPet);
                pet.canDivide = false;
                updateGameView();
                showNotification(`${pet.name} разделился и создал ${newPet.name}!`);
                
                // Switch to multi-pet view if more than one pet
                if (gameState.pets.length > 1) {
                    document.getElementById('single-pet-view').style.display = 'none';
                    document.getElementById('multi-pet-view').style.display = 'block';
                    updatePetsContainer();
                }
            }
        });
        
        // Helper functions
        function getExpForNextLevel(level) {
            return 100 + (level * 50);
        }
        
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show-notification');
            setTimeout(() => {
                notification.classList.remove('show-notification');
            }, 3000);
        }
        
        function updateGameView() {
            if (gameState.pets.length === 0) return;
            
            const pet = gameState.pets[gameState.currentPetIndex];
            document.getElementById('pet-name').textContent = pet.name;
            document.getElementById('pet-stage').textContent = `Стадия: ${EVOLUTION_STAGES[pet.evolutionStage]}`;
            
            // Update stats
            document.getElementById('hunger-value').textContent = `${Math.round(pet.hunger)}%`;
            document.getElementById('energy-value').textContent = `${Math.round(pet.energy)}%`;
            document.getElementById('happiness-value').textContent = `${Math.round(pet.happiness)}%`;
            document.getElementById('exp-value').textContent = `${Math.round(pet.exp)}/${getExpForNextLevel(pet.level)}`;
            
            // Update progress bars
            document.getElementById('hunger-bar').style.width = `${pet.hunger}%`;
            document.getElementById('energy-bar').style.width = `${pet.energy}%`;
            document.getElementById('happiness-bar').style.width = `${pet.happiness}%`;
            document.getElementById('exp-bar').style.width = `${(pet.exp / getExpForNextLevel(pet.level)) * 100}%`;
            
            // Update button states
            document.getElementById('evolve-btn').disabled = !pet.canEvolve;
            document.getElementById('divide-btn').disabled = !pet.canDivide;
            
            // Update game title
            document.getElementById('game-title').textContent = gameState.pets.length > 1 ? 
                `Колония (${gameState.pets.length} питомцев)` : 
                `Мой питомец`;
        }
        
        function updatePetsContainer() {
            const container = document.getElementById('pets-container');
            container.innerHTML = '';
            
            gameState.pets.forEach((pet, index) => {
                const petCard = document.createElement('div');
                petCard.className = 'pet-card';
                
                petCard.innerHTML = `
                    <h4>${pet.name}</h4>
                    <div>Уровень: ${pet.level}</div>
                    <div>${EVOLUTION_STAGES[pet.evolutionStage]}</div>
                    <div>Голод: ${Math.round(pet.hunger)}%</div>
                    <div>Энергия: ${Math.round(pet.energy)}%</div>
                    <button class="select-pet" data-index="${index}">Выбрать</button>
                `;
                
                container.appendChild(petCard);
            });
            
            // Add event listeners to select buttons
            document.querySelectorAll('.select-pet').forEach(button => {
                button.addEventListener('click', (e) => {
                    gameState.currentPetIndex = parseInt(e.target.getAttribute('data-index'));
                    document.getElementById('single-pet-view').style.display = 'block';
                    document.getElementById('multi-pet-view').style.display = 'none';
                    updateGameView();
                });
            });
        }
        
        function startNewGame(petName, petType) {
            gameState.pets = [{
                name: petName,
                type: petType,
                hunger: 80,
                energy: 80,
                happiness: 70,
                exp: 0,
                level: 1,
                evolutionStage: 0,
                canEvolve: false,
                canDivide: false,
                lastUpdate: Date.now()
            }];
            
            gameState.currentPetIndex = 0;
            gameState.gameStarted = true;
            gameState.lastUpdateTime = Date.now();
            
            updateGameView();
            saveGame();
        }
        
        function updatePetStats() {
            const now = Date.now();
            const timePassed = (now - gameState.lastUpdateTime) / 1000; // in seconds
            gameState.lastUpdateTime = now;
            
            gameState.pets.forEach(pet => {
                const typeInfo = PET_TYPES[pet.type];
                
                // Decrease stats over time
                pet.hunger = Math.max(0, pet.hunger - (typeInfo.hungerRate * timePassed));
                pet.energy = Math.max(0, pet.energy - (typeInfo.energyRate * timePassed));
                pet.happiness = Math.max(0, pet.happiness - (typeInfo.happinessRate * timePassed));
                
                // Penalties for low stats
                if (pet.hunger <= 0) {
                    pet.happiness = Math.max(0, pet.happiness - (1 * timePassed));
                }
                
                if (pet.energy <= 0) {
                    pet.happiness = Math.max(0, pet.happiness - (1 * timePassed));
                }
                
                pet.lastUpdate = now;
            });
            
            // Check for dead pets
            gameState.pets = gameState.pets.filter(pet => pet.happiness > 0);
            
            if (gameState.pets.length === 0 && gameState.gameStarted) {
                showNotification('Все ваши питомцы погибли! Игра окончена.');
                gameState.gameStarted = false;
                saveGame();
                gameScreen.style.display = 'none';
                mainMenu.style.display = 'block';
                return;
            }
            
            if (gameState.gameStarted) {
                updateGameView();
                
                if (gameState.pets.length > 1) {
                    updatePetsContainer();
                }
            }
        }
        
        // Save/load game
        function saveGame() {
            if (gameState.gameStarted) {
                const saveData = {
                    pets: gameState.pets,
                    currentPetIndex: gameState.currentPetIndex,
                    lastUpdateTime: Date.now()
                };
                localStorage.setItem('evolutionTamagotchiSave', JSON.stringify(saveData));
            } else {
                localStorage.removeItem('evolutionTamagotchiSave');
            }
        }
        
        function loadGame() {
            const saveData = localStorage.getItem('evolutionTamagotchiSave');
            if (saveData) {
                const parsedData = JSON.parse(saveData);
                gameState.pets = parsedData.pets;
                gameState.currentPetIndex = parsedData.currentPetIndex;
                gameState.lastUpdateTime = parsedData.lastUpdateTime;
                gameState.gameStarted = true;
                
                // Update stats based on time passed
                updatePetStats();
            }
        }
        
        // Initialize Telegram Web App
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                
                // Set theme colors
                const themeParams = Telegram.WebApp.themeParams;
                if (themeParams) {
                    document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color);
                    document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color);
                    document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color);
                    document.documentElement.style.setProperty('--tg-theme-link-color', themeParams.link_color);
                    document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color);
                    document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color);
                }
            }
        }
        
        // Game loop
        function gameLoop() {
            if (gameState.gameStarted) {
                updatePetStats();
            }
            setTimeout(gameLoop, 1000);
        }
        
        // Initialize
        window.onload = function() {
            initTelegramWebApp();
            gameLoop();
        };
    </script>
</body>
</html>