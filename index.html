<!DOCTYPE html>
<html>
<head>
    <title>Cosmic Cow Roundup</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #2a1f1d;
            font-family: 'Courier New', monospace;
            touch-action: none;
        }
        
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
            color: #fff5e6;
            display: none;
        }
        
        #mainMenu {
            display: block;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .button {
            background: #8b4513;
            border: 2px solid #d2b48c;
            color: #fff5e6;
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            margin: 10px;
            border-radius: 8px;
            transition: all 0.3s;
            width: 200px;
        }
        
        .button:hover {
            background: #a0522d;
            transform: scale(1.1);
        }
        
        .game-info {
            position: absolute;
            color: #fff5e6;
            font-size: 20px;
            z-index: 3;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        
        #scoreBoard { top: 10px; left: 10px; }
        #timer { top: 10px; right: 10px; }
        #ammo { bottom: 60px; left: 10px; }
        #accuracy { bottom: 10px; left: 10px; }
        #lives { bottom: 10px; right: 10px; }
        #reloadStatus {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 40px;
            text-shadow: 2px 2px #000;
            z-index: 4;
            display: none;
        }
        
        table.leaderboard {
            margin: 20px auto;
            border-collapse: collapse;
        }
        
        table.leaderboard td, table.leaderboard th {
            padding: 10px 20px;
            border: 1px solid #d2b48c;
        }
    </style>
</head>
<body>
    <div id="mainMenu" class="screen">
        <h1 style="font-size: 48px; margin-bottom: 40px;">üõ∏ Cosmic Cow Roundup üêÑ</h1>
        <button class="button" onclick="showScreen('gameScreen')">Start Game</button>
        <button class="button" onclick="showScreen('howToPlay')">How to Play</button>
        <button class="button" onclick="showLeaderboard()">High Scores</button>
    </div>

    <div id="howToPlay" class="screen">
        <h2>How to Play</h2>
        <div style="text-align: left; max-width: 500px;">
            <p>üéØ Tap to shoot flying cows!</p>
            <p>üí• 5 bullets before reload</p>
            <p>‚ù§Ô∏è 3 lives - avoid misses</p>
            <p>‚è± 60 seconds to score max</p>
            <p>ü•á Different cow types give different points</p>
        </div>
        <button class="button" onclick="showScreen('mainMenu')">Back</button>
    </div>

    <div id="leaderboard" class="screen">
        <h2>Top 5 Pilots</h2>
        <table class="leaderboard">
            <thead><tr><th>Name</th><th>Score</th></tr></thead>
            <tbody id="leaderboardBody"></tbody>
        </table>
        <button class="button" onclick="showScreen('mainMenu')">Back</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="scoreBoard" class="game-info">Score: <span id="score">0</span></div>
    <div id="timer" class="game-info">Time: 60</div>
    <div id="ammo" class="game-info">Ammo: <span id="bullets">5</span></div>
    <div id="accuracy" class="game-info">Hits: 0 | Miss: 0</div>
    <div id="lives" class="game-info">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div id="reloadStatus">RELOADING!</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        
        // Game state
        let gameState = {
            score: 0,
            timeLeft: 60,
            bullets: 5,
            hits: 0,
            misses: 0,
            lives: 3,
            reloading: false,
            gameActive: false,
            cows: [],
            stars: [],
            leaderboard: JSON.parse(localStorage.getItem('leaderboard')) || []
        };

        const COW_TYPES = [
            { color: '#8B4513', speed: 3, score: 100, pattern: 'sine' },
            { color: '#A52A2A', speed: 5, score: 200, pattern: 'spiral' },
            { color: '#D2691E', speed: 4, score: 150, pattern: 'zigzag' }
        ];

        class Star {
            constructor() {
                this.reset();
            }
            
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2;
                this.speed = 0.1 + Math.random() * 0.3;
            }
            
            update() {
                this.y += this.speed;
                if(this.y > canvas.height) this.reset();
            }
            
            draw() {
                ctx.fillStyle = '#d2b48c';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class Cow {
            constructor() {
                this.type = COW_TYPES[Math.floor(Math.random() * COW_TYPES.length)];
                this.reset();
                this.angle = 0;
                this.frame = 0;
            }
            
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height + 100;
                this.speed = this.type.speed;
                this.angle = 0;
                this.alive = true;
                this.phase = Math.random() * Math.PI * 2;
            }
            
            update() {
                this.phase += 0.05;
                this.y -= this.speed;
                
                switch(this.type.pattern) {
                    case 'sine':
                        this.x += Math.sin(this.phase) * 3;
                        break;
                    case 'spiral':
                        this.x += Math.cos(this.phase) * 3;
                        this.y += Math.sin(this.phase) * 1;
                        break;
                    case 'zigzag':
                        this.x += Math.sin(this.phase * 2) * 4;
                        break;
                }
                
                if(this.y < -100) this.reset();
            }
            
            draw() {
                if(!this.alive) return;
                
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // Body
                ctx.fillStyle = this.type.color;
                ctx.fillRect(-15, -10, 30, 20);
                
                // Head
                ctx.beginPath();
                ctx.arc(0, -15, 10, 0, Math.PI * 2);
                ctx.fill();
                
                // Wings
                ctx.fillStyle = '#DEB887';
                ctx.beginPath();
                ctx.ellipse(-20, 0, 10, 5, Math.PI/4, 0, Math.PI * 2);
                ctx.ellipse(20, 0, 10, 5, -Math.PI/4, 0, Math.PI * 2);
                ctx.fill();
                
                // Legs
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(-10, 10);
                ctx.lineTo(-15, 20);
                ctx.moveTo(10, 10);
                ctx.lineTo(15, 20);
                ctx.stroke();
                
                ctx.restore();
            }
        }

        function createStars() {
            for(let i = 0; i < 100; i++) {
                gameState.stars.push(new Star());
            }
        }

        function shoot(x, y) {
            if(!gameState.gameActive || gameState.reloading) return;
            
            if(gameState.bullets > 0) {
                gameState.bullets--;
                let hit = false;
                
                gameState.cows.forEach(cow => {
                    if(!cow.alive) return;
                    const dist = Math.hypot(cow.x - x, cow.y - y);
                    if(dist < 30) {
                        cow.alive = false;
                        gameState.score += cow.type.score;
                        gameState.hits++;
                        hit = true;
                    }
                });
                
                if(!hit) {
                    gameState.misses++;
                    gameState.lives = Math.max(0, gameState.lives - 1);
                    updateLivesDisplay();
                }
                
                updateUI();
                
                if(gameState.bullets === 0) {
                    startReload();
                }
            }
        }

        function startReload() {
            gameState.reloading = true;
            document.getElementById('reloadStatus').style.display = 'block';
            setTimeout(() => {
                gameState.bullets = 5;
                gameState.reloading = false;
                document.getElementById('reloadStatus').style.display = 'none';
                updateUI();
            }, 2000);
        }

        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('bullets').textContent = gameState.bullets;
            document.getElementById('accuracy').textContent = 
                `Hits: ${gameState.hits} | Miss: ${gameState.misses}`;
        }

        function updateLivesDisplay() {
            document.getElementById('lives').innerHTML = 
                '‚ù§Ô∏è'.repeat(gameState.lives) + 'üñ§'.repeat(3 - gameState.lives);
        }

        function gameLoop() {
            ctx.fillStyle = '#2a1f1d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            gameState.stars.forEach(star => {
                star.update();
                star.draw();
            });
            
            gameState.cows.forEach(cow => {
                cow.update();
                cow.draw();
            });
            
            if(gameState.gameActive) {
                animationFrameId = requestAnimationFrame(gameLoop);
                
                if(Math.random() < 0.04) {
                    gameState.cows.push(new Cow());
                }
            }
        }

        function startGame() {
            showScreen('gameScreen');
            gameState = {
                ...gameState,
                score: 0,
                timeLeft: 60,
                bullets: 5,
                hits: 0,
                misses: 0,
                lives: 3,
                reloading: false,
                gameActive: true,
                cows: []
            };
            
            updateUI();
            updateLivesDisplay();
            
            const timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = `Time: ${gameState.timeLeft}`;
                
                if(gameState.timeLeft <= 0 || gameState.lives <= 0) {
                    gameState.gameActive = false;
                    clearInterval(timer);
                    cancelAnimationFrame(animationFrameId);
                    endGame();
                }
            }, 1000);
            
            resizeCanvas();
            gameLoop();
        }

        function endGame() {
            const name = prompt('Game Over! Enter your name:');
            if(name) {
                gameState.leaderboard.push({ name, score: gameState.score });
                gameState.leaderboard.sort((a,b) => b.score - a.score);
                gameState.leaderboard = gameState.leaderboard.slice(0,5);
                localStorage.setItem('leaderboard', JSON.stringify(gameState.leaderboard));
            }
            showScreen('mainMenu');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
        }

        function showLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = gameState.leaderboard
                .map((entry, i) => `<tr><td>${i+1}. ${entry.name}</td><td>${entry.score}</td></tr>`)
                .join('');
            showScreen('leaderboard');
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // Event listeners
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('click', (e) => shoot(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            shoot(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        }, { passive: false });

        // Initialize
        resizeCanvas();
        createStars();
        showLeaderboard();
        Telegram.WebApp.ready();
    </script>
</body>
</html>