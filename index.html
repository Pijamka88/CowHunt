<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эволюционный Тамагочи</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .pet-container {
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            background-color: #ecf0f1;
        }
        
        .pet-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .stat-bar {
            height: 20px;
            background-color: #bdc3c7;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .stat-fill {
            height: 100%;
            background-color: #2ecc71;
            width: 100%;
            transition: width 0.3s;
        }
        
        .hunger .stat-fill {
            background-color: #e74c3c;
        }
        
        .energy .stat-fill {
            background-color: #f39c12;
        }
        
        .happiness .stat-fill {
            background-color: #9b59b6;
        }
        
        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .pet-evolution {
            margin-top: 20px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .pet-level {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .pet-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .pet-type {
            font-style: italic;
            color: #7f8c8d;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pets-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .pet-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: 120px;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: white;
        }
        
        .pet-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .pet-card h3 {
            margin: 5px 0;
            font-size: 16px;
        }
        
        .pet-card p {
            margin: 3px 0;
            font-size: 14px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ecc71;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .progress-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #3498db;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
        }
        
        .evolution-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu" class="screen active">
            <h1>Эволюционный Тамагочи</h1>
            <p>Вырастите своего питомца, развивайте его и наблюдайте за его эволюцией!</p>
            
            <div style="display: flex; flex-direction: column; align-items: center; margin-top: 40px;">
                <button id="new-game-btn" style="width: 80%; max-width: 300px; margin-bottom: 15px;">Новая игра</button>
                <button id="continue-game-btn" style="width: 80%; max-width: 300px; margin-bottom: 15px;">Продолжить</button>
                <button id="how-to-play-btn" style="width: 80%; max-width: 300px;">Как играть?</button>
            </div>
        </div>
        
        <!-- Экран руководства -->
        <div id="how-to-play" class="screen">
            <h2>Как играть?</h2>
            <div style="text-align: left; margin: 20px 0;">
                <h3>Основы игры</h3>
                <p>Ваша цель - вырастить и развить своего питомца. Ухаживайте за ним, чтобы он эволюционировал.</p>
                
                <h3>Характеристики питомца</h3>
                <ul>
                    <li><strong>Голод</strong> - кормите питомца, чтобы поддерживать этот показатель</li>
                    <li><strong>Энергия</strong> - давайте питомцу отдыхать</li>
                    <li><strong>Счастье</strong> - играйте с питомцем</li>
                </ul>
                
                <h3>Эволюция</h3>
                <p>Когда питомец достигает 5 уровня, он может разделиться на двух новых питомцев. Каждый новый питомец наследует часть характеристик родителя.</p>
                
                <h3>Управление</h3>
                <p>Используйте кнопки действий для ухода за питомцем. Вы можете переключаться между своими питомцами в любое время.</p>
            </div>
            
            <button id="back-to-menu-from-help">Вернуться в меню</button>
        </div>
        
        <!-- Экран выбора питомца -->
        <div id="pet-selection" class="screen">
            <h2>Выберите начального питомца</h2>
            <p>Каждый тип питомца имеет свои особенности развития</p>
            
            <div class="pets-list">
                <div class="pet-card" data-type="plant">
                    <h3>Растение</h3>
                    <p class="pet-type">Флора</p>
                    <p>Медленно растёт, но требует меньше ухода</p>
                </div>
                <div class="pet-card" data-type="animal">
                    <h3>Зверёк</h3>
                    <p class="pet-type">Фауна</p>
                    <p>Быстро развивается, но требует внимания</p>
                </div>
                <div class="pet-card" data-type="mystery">
                    <h3>Загадка</h3>
                    <p class="pet-type">Неизвестно</p>
                    <p>Случайные характеристики</p>
                </div>
            </div>
            
            <button id="back-to-menu-from-selection">Вернуться в меню</button>
        </div>
        
        <!-- Экран имени питомца -->
        <div id="name-pet" class="screen">
            <h2>Дайте имя вашему питомцу</h2>
            <input type="text" id="pet-name-input" placeholder="Введите имя" style="padding: 10px; width: 80%; max-width: 300px; font-size: 16px; margin: 20px 0;">
            <div>
                <button id="confirm-name">Подтвердить</button>
                <button id="back-to-selection">Назад</button>
            </div>
        </div>
        
        <!-- Основной игровой экран -->
        <div id="game-screen" class="screen">
            <h2>Ваш питомец</h2>
            
            <div class="pet-container">
                <div class="pet-name" id="current-pet-name">Имя</div>
                <div class="pet-type" id="current-pet-type">Тип</div>
                <div class="pet-level">Уровень: <span id="current-pet-level">1</span></div>
                
                <div class="pet-stats">
                    <div class="stat">
                        <div class="stat-label">
                            <span>Голод</span>
                            <span id="hunger-value">100%</span>
                        </div>
                        <div class="stat-bar hunger">
                            <div class="stat-fill" id="hunger-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-label">
                            <span>Энергия</span>
                            <span id="energy-value">100%</span>
                        </div>
                        <div class="stat-bar energy">
                            <div class="stat-fill" id="energy-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-label">
                            <span>Счастье</span>
                            <span id="happiness-value">100%</span>
                        </div>
                        <div class="stat-bar happiness">
                            <div class="stat-fill" id="happiness-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="pet-evolution" id="evolution-info">
                    До следующего уровня: 0%
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="level-progress" style="width: 0%;"></div>
                </div>
                
                <div class="evolution-info" id="evolution-details">
                    Питомец достигнет следующего уровня при заполнении шкалы. На 5 уровне произойдет эволюция!
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="feed-btn">Покормить</button>
                <button id="sleep-btn">Уложить спать</button>
                <button id="play-btn">Поиграть</button>
                <button id="train-btn">Тренировать</button>
            </div>
            
            <div style="margin-top: 30px;">
                <button id="switch-pet-btn">Сменить питомца</button>
                <button id="save-exit-btn">Сохранить и выйти</button>
            </div>
        </div>
        
        <!-- Экран выбора питомца в игре -->
        <div id="in-game-pet-selection" class="screen">
            <h2>Выберите питомца</h2>
            <p>У вас <span id="pet-count">0</span> питомцев</p>
            
            <div class="pets-list" id="pets-list-container">
                <!-- Питомцы будут добавляться здесь динамически -->
            </div>
            
            <button id="back-to-game">Вернуться к игре</button>
        </div>
        
        <!-- Уведомление -->
        <div class="notification" id="notification"></div>
    </div>

    <script>
        // Игровые переменные
        let pets = [];
        let currentPetIndex = 0;
        let gameInterval;
        let lastUpdateTime = Date.now();
        
        // Элементы интерфейса
        const screens = {
            mainMenu: document.getElementById('main-menu'),
            howToPlay: document.getElementById('how-to-play'),
            petSelection: document.getElementById('pet-selection'),
            namePet: document.getElementById('name-pet'),
            gameScreen: document.getElementById('game-screen'),
            inGamePetSelection: document.getElementById('in-game-pet-selection')
        };
        
        // Кнопки меню
        document.getElementById('new-game-btn').addEventListener('click', () => {
            showScreen('petSelection');
        });
        
        document.getElementById('continue-game-btn').addEventListener('click', () => {
            loadGame();
        });
        
        document.getElementById('how-to-play-btn').addEventListener('click', () => {
            showScreen('howToPlay');
        });
        
        document.getElementById('back-to-menu-from-help').addEventListener('click', () => {
            showScreen('main-menu');
        });
        
        document.getElementById('back-to-menu-from-selection').addEventListener('click', () => {
            showScreen('main-menu');
        });
        
        document.getElementById('back-to-selection').addEventListener('click', () => {
            showScreen('petSelection');
        });
        
        // Выбор начального питомца
        const petCards = document.querySelectorAll('.pet-card');
        petCards.forEach(card => {
            card.addEventListener('click', () => {
                const petType = card.getAttribute('data-type');
                createNewPet(petType);
                showScreen('namePet');
            });
        });
        
        // Подтверждение имени
        document.getElementById('confirm-name').addEventListener('click', () => {
            const nameInput = document.getElementById('pet-name-input');
            if (nameInput.value.trim() === '') {
                showNotification('Пожалуйста, введите имя питомца');
                return;
            }
            
            pets[0].name = nameInput.value.trim();
            saveGame();
            startGame();
            showScreen('game-screen');
        });
        
        // Игровые кнопки
        document.getElementById('feed-btn').addEventListener('click', () => {
            const pet = getCurrentPet();
            if (pet.hunger >= 95) {
                showNotification(`${pet.name} не голоден!`);
                return;
            }
            
            pet.hunger = Math.min(100, pet.hunger + 15 + Math.random() * 10);
            pet.energy = Math.max(0, pet.energy - 5);
            pet.happiness = Math.min(100, pet.happiness + 5);
            addExperience(5);
            updatePetDisplay();
            showNotification(`Вы покормили ${pet.name}!`);
        });
        
        document.getElementById('sleep-btn').addEventListener('click', () => {
            const pet = getCurrentPet();
            if (pet.energy >= 95) {
                showNotification(`${pet.name} не хочет спать!`);
                return;
            }
            
            pet.energy = Math.min(100, pet.energy + 20 + Math.random() * 10);
            pet.hunger = Math.max(0, pet.hunger - 10);
            pet.happiness = Math.max(0, pet.happiness - 5);
            addExperience(5);
            updatePetDisplay();
            showNotification(`Вы уложили ${pet.name} спать!`);
        });
        
        document.getElementById('play-btn').addEventListener('click', () => {
            const pet = getCurrentPet();
            if (pet.happiness >= 95) {
                showNotification(`${pet.name} уже очень счастлив!`);
                return;
            }
            
            pet.happiness = Math.min(100, pet.happiness + 15 + Math.random() * 10);
            pet.energy = Math.max(0, pet.energy - 10);
            pet.hunger = Math.max(0, pet.hunger - 5);
            addExperience(5);
            updatePetDisplay();
            showNotification(`Вы поиграли с ${pet.name}!`);
        });
        
        document.getElementById('train-btn').addEventListener('click', () => {
            const pet = getCurrentPet();
            if (pet.energy < 30) {
                showNotification(`${pet.name} слишком устал для тренировки!`);
                return;
            }
            
            pet.energy = Math.max(0, pet.energy - 20);
            pet.hunger = Math.max(0, pet.hunger - 15);
            pet.happiness = Math.max(0, pet.happiness - 5);
            addExperience(15);
            updatePetDisplay();
            showNotification(`Вы потренировали ${pet.name}!`);
        });
        
        document.getElementById('switch-pet-btn').addEventListener('click', () => {
            updatePetsList();
            showScreen('inGamePetSelection');
        });
        
        document.getElementById('back-to-game').addEventListener('click', () => {
            showScreen('game-screen');
        });
        
        document.getElementById('save-exit-btn').addEventListener('click', () => {
            saveGame();
            showScreen('main-menu');
            clearInterval(gameInterval);
        });
        
        // Функции игры
        function showScreen(screenName) {
            // Скрыть все экраны
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Показать выбранный экран
            screens[screenName].classList.add('active');
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function createNewPet(type) {
            const baseStats = {
                plant: { hungerDecay: 0.5, energyDecay: 0.3, happinessDecay: 0.4 },
                animal: { hungerDecay: 1.2, energyDecay: 1.0, happinessDecay: 1.1 },
                mystery: { 
                    hungerDecay: 0.5 + Math.random(),
                    energyDecay: 0.3 + Math.random(),
                    happinessDecay: 0.4 + Math.random() 
                }
            };
            
            const stats = baseStats[type] || baseStats.mystery;
            
            const pet = {
                name: '',
                type: type,
                level: 1,
                experience: 0,
                maxExperience: 100,
                hunger: 100,
                energy: 100,
                happiness: 100,
                hungerDecay: stats.hungerDecay,
                energyDecay: stats.energyDecay,
                happinessDecay: stats.happinessDecay,
                lastUpdate: Date.now(),
                generation: 1
            };
            
            pets = [pet];
            currentPetIndex = 0;
        }
        
        function getCurrentPet() {
            return pets[currentPetIndex];
        }
        
        function startGame() {
            // Запускаем игровой цикл
            gameInterval = setInterval(gameLoop, 1000);
            lastUpdateTime = Date.now();
            updatePetDisplay();
        }
        
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - lastUpdateTime) / 1000; // В секундах
            lastUpdateTime = now;
            
            const pet = getCurrentPet();
            
            // Уменьшение характеристик со временем
            pet.hunger = Math.max(0, pet.hunger - pet.hungerDecay * deltaTime);
            pet.energy = Math.max(0, pet.energy - pet.energyDecay * deltaTime);
            pet.happiness = Math.max(0, pet.happiness - pet.happinessDecay * deltaTime);
            
            // Проверка на смерть
            if (pet.hunger <= 0 || pet.energy <= 0 || pet.happiness <= 0) {
                petDie();
                return;
            }
            
            // Автоматическое добавление опыта за выживание
            addExperience(0.1 * deltaTime);
            
            updatePetDisplay();
            saveGame();
        }
        
        function petDie() {
            clearInterval(gameInterval);
            const pet = getCurrentPet();
            
            // Удаляем умершего питомца
            pets.splice(currentPetIndex, 1);
            
            if (pets.length === 0) {
                showNotification(`${pet.name} умер... Игра окончена!`);
                showScreen('main-menu');
                localStorage.removeItem('evolutionTamagotchiSave');
            } else {
                currentPetIndex = Math.min(currentPetIndex, pets.length - 1);
                showNotification(`${pet.name} умер... Выберите другого питомца.`);
                updatePetsList();
                showScreen('inGamePetSelection');
                startGame();
            }
        }
        
        function addExperience(amount) {
            const pet = getCurrentPet();
            pet.experience += amount;
            
            // Проверка уровня
            if (pet.experience >= pet.maxExperience) {
                pet.level += 1;
                pet.experience = 0;
                pet.maxExperience = Math.round(pet.maxExperience * 1.5);
                
                showNotification(`Поздравляем! ${pet.name} достиг уровня ${pet.level}!`);
                
                // Проверка на эволюцию (деление)
                if (pet.level === 5 && pets.length < 10) { // Ограничение на максимальное количество питомцев
                    evolvePet();
                }
            }
        }
        
        function evolvePet() {
            const parentPet = getCurrentPet();
            
            // Создаем двух новых питомцев на основе родителя
            for (let i = 0; i < 2; i++) {
                const newPet = {
                    name: `${parentPet.name}-${i+1}`,
                    type: parentPet.type,
                    level: 1,
                    experience: 0,
                    maxExperience: 100,
                    hunger: 100,
                    energy: 100,
                    happiness: 100,
                    hungerDecay: parentPet.hungerDecay * (0.9 + Math.random() * 0.2),
                    energyDecay: parentPet.energyDecay * (0.9 + Math.random() * 0.2),
                    happinessDecay: parentPet.happinessDecay * (0.9 + Math.random() * 0.2),
                    lastUpdate: Date.now(),
                    generation: parentPet.generation + 1
                };
                
                pets.push(newPet);
            }
            
            // Удаляем родителя после деления
            pets.splice(currentPetIndex, 1);
            currentPetIndex = pets.length - 1;
            
            showNotification(`${parentPet.name} эволюционировал и разделился на двух новых питомцев!`);
            updatePetsList();
        }
        
        function updatePetDisplay() {
            const pet = getCurrentPet();
            if (!pet) return;
            
            document.getElementById('current-pet-name').textContent = pet.name;
            document.getElementById('current-pet-type').textContent = getTypeName(pet.type);
            document.getElementById('current-pet-level').textContent = pet.level;
            
            // Обновляем шкалы характеристик
            document.getElementById('hunger-bar').style.width = `${pet.hunger}%`;
            document.getElementById('energy-bar').style.width = `${pet.energy}%`;
            document.getElementById('happiness-bar').style.width = `${pet.happiness}%`;
            
            document.getElementById('hunger-value').textContent = `${Math.round(pet.hunger)}%`;
            document.getElementById('energy-value').textContent = `${Math.round(pet.energy)}%`;
            document.getElementById('happiness-value').textContent = `${Math.round(pet.happiness)}%`;
            
            // Обновляем прогресс уровня
            const progressPercent = (pet.experience / pet.maxExperience) * 100;
            document.getElementById('level-progress').style.width = `${progressPercent}%`;
            document.getElementById('evolution-info').textContent = `До следующего уровня: ${Math.round(progressPercent)}%`;
            
            // Обновляем информацию об эволюции
            if (pet.level < 5) {
                document.getElementById('evolution-details').textContent = 
                    `Питомец достигнет следующего уровня при заполнении шкалы. На 5 уровне произойдет эволюция!`;
            } else {
                document.getElementById('evolution-details').textContent = 
                    `Ваш питомец достиг максимального уровня и готов к эволюции!`;
            }
        }
        
        function getTypeName(type) {
            const typeNames = {
                plant: 'Растение',
                animal: 'Зверёк',
                mystery: 'Загадка'
            };
            
            return typeNames[type] || type;
        }
        
        function updatePetsList() {
            const container = document.getElementById('pets-list-container');
            container.innerHTML = '';
            
            document.getElementById('pet-count').textContent = pets.length;
            
            pets.forEach((pet, index) => {
                const card = document.createElement('div');
                card.className = 'pet-card';
                if (index === currentPetIndex) {
                    card.style.border = '2px solid #3498db';
                }
                
                card.innerHTML = `
                    <h3>${pet.name}</h3>
                    <p class="pet-type">${getTypeName(pet.type)}</p>
                    <p>Уровень: ${pet.level}</p>
                    <p>Поколение: ${pet.generation}</p>
                `;
                
                card.addEventListener('click', () => {
                    currentPetIndex = index;
                    showScreen('game-screen');
                    updatePetDisplay();
                });
                
                container.appendChild(card);
            });
        }
        
        // Сохранение и загрузка игры
        function saveGame() {
            const gameData = {
                pets: pets,
                currentPetIndex: currentPetIndex,
                lastUpdateTime: lastUpdateTime
            };
            
            localStorage.setItem('evolutionTamagotchiSave', JSON.stringify(gameData));
        }
        
        function loadGame() {
            const savedData = localStorage.getItem('evolutionTamagotchiSave');
            if (!savedData) {
                showNotification('Нет сохранённой игры');
                return;
            }
            
            try {
                const gameData = JSON.parse(savedData);
                pets = gameData.pets;
                currentPetIndex = gameData.currentPetIndex;
                lastUpdateTime = gameData.lastUpdateTime;
                
                // Обновляем время для всех питомцев
                const now = Date.now();
                const timeDiff = (now - lastUpdateTime) / 1000;
                
                pets.forEach(pet => {
                    // Уменьшаем характеристики на время отсутствия
                    pet.hunger = Math.max(0, pet.hunger - pet.hungerDecay * timeDiff);
                    pet.energy = Math.max(0, pet.energy - pet.energyDecay * timeDiff);
                    pet.happiness = Math.max(0, pet.happiness - pet.happinessDecay * timeDiff);
                    pet.lastUpdate = now;
                });
                
                startGame();
                showScreen('game-screen');
                showNotification('Игра загружена!');
            } catch (e) {
                console.error('Ошибка загрузки игры:', e);
                showNotification('Ошибка загрузки сохранения');
            }
        }
        
        // Инициализация Telegram Web App
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                
                // Изменяем цвет фона и кнопок под тему Telegram
                const themeParams = Telegram.WebApp.themeParams;
                if (themeParams) {
                    document.body.style.backgroundColor = themeParams.bg_color || '#f5f5f5';
                    
                    const buttons = document.querySelectorAll('button');
                    buttons.forEach(button => {
                        button.style.backgroundColor = themeParams.button_color || '#3498db';
                        button.style.color = themeParams.button_text_color || '#ffffff';
                    });
                }
            }
        }
        
        // Инициализация при загрузке
        window.addEventListener('DOMContentLoaded', () => {
            initTelegramWebApp();
            
            // Проверяем, есть ли параметр запуска из Telegram
            if (window.location.hash === '#start_game') {
                const savedData = localStorage.getItem('evolutionTamagotchiSave');
                if (savedData) {
                    loadGame();
                } else {
                    showScreen('petSelection');
                }
            }
        });
    </script>
</body>
</html>