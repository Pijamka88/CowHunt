<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Tamagotchi Evolution</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Old English Text MT', 'Times New Roman', serif;
            background-color: #f0e6d2;
            color: #3a3226;
            margin: 0;
            padding: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23e8d9b5" d="M0 0h100v100H0z"/><path fill="none" stroke="%23d4c7a1" stroke-width="0.5" d="M0 0h100v100H0zM20 0v100M40 0v100M60 0v100M80 0v100M0 20h100M0 40h100M0 60h100M0 80h100"/></svg>');
            background-size: 100px 100px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            border-bottom: 2px solid #8b4513;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #5c3a21;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.2);
            margin: 0;
        }

        .header p {
            font-style: italic;
            margin: 5px 0 0;
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            background-color: #8b4513;
            color: #f0e6d2;
            border: none;
            padding: 12px 20px;
            font-family: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        button:hover {
            background-color: #a0522d;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .game-screen {
            display: none;
        }

        .pet-container {
            background-color: #e8d9b5;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .pet-name {
            font-size: 1.8rem;
            margin: 0 0 10px;
            color: #5c3a21;
        }

        .pet-stage {
            font-style: italic;
            margin: 0 0 15px;
        }

        .pet-stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat {
            background-color: #d4c7a1;
            padding: 8px 12px;
            border-radius: 5px;
            min-width: 100px;
        }

        .stat-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .stat-value {
            font-size: 1.1rem;
        }

        .progress-container {
            width: 100%;
            background-color: #d4c7a1;
            border-radius: 5px;
            margin: 5px 0;
        }

        .progress-bar {
            height: 20px;
            border-radius: 5px;
            background-color: #8b4513;
            width: 100%;
            transition: width 0.3s;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .action-btn {
            background-color: #5c3a21;
            flex: 1 1 120px;
        }

        .log {
            background-color: #e8d9b5;
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 5px 0;
            padding-bottom: 5px;
            border-bottom: 1px dashed #d4c7a1;
        }

        .log-time {
            color: #8b4513;
            font-size: 0.8rem;
        }

        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .pet-card {
            background-color: #e8d9b5;
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .pet-card.selected {
            border-color: #5c3a21;
            background-color: #d4c7a1;
        }

        .pet-card-name {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .pet-card-stage {
            font-size: 0.8rem;
            text-align: center;
            font-style: italic;
        }

        .back-btn {
            background-color: #5c3a21;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .pet-stats {
                flex-direction: column;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Menu -->
        <div id="main-menu" class="menu-screen">
            <div class="header">
                <h1>Medieval Tamagotchi</h1>
                <p>Raise your creature through the ages</p>
            </div>
            
            <div class="menu">
                <button id="new-game-btn">New Game</button>
                <button id="continue-game-btn">Continue Game</button>
                <button id="colony-btn">Your Colony</button>
                <button id="instructions-btn">Instructions</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="game-screen">
            <div class="header">
                <h1 id="game-title">Your Creature</h1>
            </div>
            
            <div class="pet-container">
                <h2 class="pet-name" id="pet-name">Unknown</h2>
                <p class="pet-stage" id="pet-stage">Egg</p>
                
                <div class="pet-stats">
                    <div class="stat">
                        <div class="stat-name">Health</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="health-bar" style="width: 100%"></div>
                        </div>
                        <div class="stat-value" id="health-value">100/100</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-name">Hunger</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="hunger-bar" style="width: 0%"></div>
                        </div>
                        <div class="stat-value" id="hunger-value">0/100</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-name">Energy</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="energy-bar" style="width: 100%"></div>
                        </div>
                        <div class="stat-value" id="energy-value">100/100</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-name">Happiness</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="happiness-bar" style="width: 100%"></div>
                        </div>
                        <div class="stat-value" id="happiness-value">100/100</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-name">Experience</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="exp-bar" style="width: 0%"></div>
                        </div>
                        <div class="stat-value" id="exp-value">0/100</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-name">Age</div>
                        <div class="stat-value" id="age-value">0 days</div>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="action-btn" id="feed-btn">Feed</button>
                <button class="action-btn" id="play-btn">Play</button>
                <button class="action-btn" id="train-btn">Train</button>
                <button class="action-btn" id="rest-btn">Rest</button>
                <button class="action-btn" id="heal-btn">Heal</button>
            </div>
            
            <div class="log" id="game-log">
                <div class="log-entry"><span class="log-time">[System]</span> Game started. Welcome to Medieval Tamagotchi!</div>
            </div>
            
            <button class="back-btn" id="game-back-btn">Back to Menu</button>
        </div>
        
        <!-- Colony Screen -->
        <div id="colony-screen" class="game-screen">
            <div class="header">
                <h1>Your Colony</h1>
            </div>
            
            <div id="pets-container" class="pets-grid">
                <!-- Pet cards will be added here dynamically -->
            </div>
            
            <button class="back-btn" id="colony-back-btn">Back to Menu</button>
        </div>
        
        <!-- Instructions Screen -->
        <div id="instructions-screen" class="game-screen">
            <div class="header">
                <h1>Instructions</h1>
            </div>
            
            <div class="pet-container">
                <h2>Medieval Tamagotchi Evolution</h2>
                <p>Welcome to the world of magical creatures!</p>
                
                <h3>Gameplay Basics</h3>
                <ul>
                    <li>Start with a single creature egg</li>
                    <li>Care for your creature by feeding, playing, and resting</li>
                    <li>Train your creature to gain experience and level up</li>
                    <li>Heal your creature when it gets sick</li>
                </ul>
                
                <h3>Evolution Mechanics</h3>
                <ul>
                    <li>Creatures evolve through stages: Egg → Hatchling → Juvenile → Adult</li>
                    <li>At Adult stage with sufficient stats, your creature can divide</li>
                    <li>Each division creates a new creature with slightly different traits</li>
                    <li>Manage your growing colony of creatures</li>
                </ul>
                
                <h3>Stats Explanation</h3>
                <ul>
                    <li><strong>Health</strong>: Decreases when hungry or sick. If reaches 0, creature dies</li>
                    <li><strong>Hunger</strong>: Increases over time. Feed to reduce</li>
                    <li><strong>Energy</strong>: Decreases with activity. Rest to recover</li>
                    <li><strong>Happiness</strong>: Affects growth rate. Play to increase</li>
                    <li><strong>Experience</strong>: Gain through training. Needed to level up</li>
                </ul>
            </div>
            
            <button class="back-btn" id="instructions-back-btn">Back to Menu</button>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            pets: [],
            currentPetIndex: 0,
            lastUpdateTime: Date.now(),
            gameStarted: false
        };

        // Creature stages
        const STAGES = {
            EGG: 'Egg',
            HATCHLING: 'Hatchling',
            JUVENILE: 'Juvenile',
            ADULT: 'Adult'
        };

        // Creature types
        const TYPES = [
            'Dragon', 'Gryphon', 'Phoenix', 'Basilisk', 
            'Unicorn', 'Manticore', 'Chimera', 'Kraken'
        ];

        // Medieval names
        const NAMES = [
            'Aethelred', 'Beowulf', 'Cedric', 'Dunstan', 'Eadric', 'Fenrir', 'Godric', 'Hrothgar',
            'Ivar', 'Jorund', 'Kjell', 'Leif', 'Magnus', 'Njord', 'Olaf', 'Ragnar', 'Sigurd', 'Thorsten',
            'Ulf', 'Vidar', 'Wulfric', 'Yngvar', 'Alfhild', 'Brynhild', 'Eir', 'Freya', 'Gudrun', 'Helga',
            'Ingrid', 'Jorunn', 'Kara', 'Liv', 'Maren', 'Nanna', 'Ragna', 'Sif', 'Thyra', 'Urd', 'Vigdis'
        ];

        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // DOM elements
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const colonyScreen = document.getElementById('colony-screen');
        const instructionsScreen = document.getElementById('instructions-screen');
        
        // Main menu buttons
        const newGameBtn = document.getElementById('new-game-btn');
        const continueGameBtn = document.getElementById('continue-game-btn');
        const colonyBtn = document.getElementById('colony-btn');
        const instructionsBtn = document.getElementById('instructions-btn');
        
        // Game screen elements
        const petNameEl = document.getElementById('pet-name');
        const petStageEl = document.getElementById('pet-stage');
        const healthBar = document.getElementById('health-bar');
        const healthValue = document.getElementById('health-value');
        const hungerBar = document.getElementById('hunger-bar');
        const hungerValue = document.getElementById('hunger-value');
        const energyBar = document.getElementById('energy-bar');
        const energyValue = document.getElementById('energy-value');
        const happinessBar = document.getElementById('happiness-bar');
        const happinessValue = document.getElementById('happiness-value');
        const expBar = document.getElementById('exp-bar');
        const expValue = document.getElementById('exp-value');
        const ageValue = document.getElementById('age-value');
        const gameLog = document.getElementById('game-log');
        const gameBackBtn = document.getElementById('game-back-btn');
        
        // Action buttons
        const feedBtn = document.getElementById('feed-btn');
        const playBtn = document.getElementById('play-btn');
        const trainBtn = document.getElementById('train-btn');
        const restBtn = document.getElementById('rest-btn');
        const healBtn = document.getElementById('heal-btn');
        
        // Colony screen elements
        const petsContainer = document.getElementById('pets-container');
        const colonyBackBtn = document.getElementById('colony-back-btn');
        
        // Instructions screen elements
        const instructionsBackBtn = document.getElementById('instructions-back-btn');
        
        // Event listeners
        newGameBtn.addEventListener('click', startNewGame);
        continueGameBtn.addEventListener('click', continueGame);
        colonyBtn.addEventListener('click', showColony);
        instructionsBtn.addEventListener('click', showInstructions);
        gameBackBtn.addEventListener('click', showMainMenu);
        colonyBackBtn.addEventListener('click', showMainMenu);
        instructionsBackBtn.addEventListener('click', showMainMenu);
        
        feedBtn.addEventListener('click', () => performAction('feed'));
        playBtn.addEventListener('click', () => performAction('play'));
        trainBtn.addEventListener('click', () => performAction('train'));
        restBtn.addEventListener('click', () => performAction('rest'));
        healBtn.addEventListener('click', () => performAction('heal'));
        
        // Initialize the game
        function initGame() {
            loadGame();
            updateContinueButton();
            
            if (tg.initDataUnsafe.start_param) {
                // Handle deep linking if needed
            }
            
            tg.expand();
            tg.enableClosingConfirmation();
        }
        
        // Load game from localStorage
        function loadGame() {
            const savedGame = localStorage.getItem('medievalTamagotchi');
            if (savedGame) {
                const parsed = JSON.parse(savedGame);
                gameState.pets = parsed.pets || [];
                gameState.currentPetIndex = parsed.currentPetIndex || 0;
                gameState.lastUpdateTime = parsed.lastUpdateTime || Date.now();
                gameState.gameStarted = parsed.gameStarted || false;
                
                // Handle time passed since last play
                if (gameState.gameStarted && gameState.pets.length > 0) {
                    const timePassed = Date.now() - gameState.lastUpdateTime;
                    const minutesPassed = Math.floor(timePassed / (1000 * 60));
                    
                    if (minutesPassed > 0) {
                        updatePetsWhileAway(minutesPassed);
                    }
                }
            }
        }
        
        // Save game to localStorage
        function saveGame() {
            gameState.lastUpdateTime = Date.now();
            localStorage.setItem('medievalTamagotchi', JSON.stringify(gameState));
        }
        
        // Update pets stats for time passed while away
        function updatePetsWhileAway(minutesPassed) {
            gameState.pets.forEach(pet => {
                // Each minute increases hunger and decreases energy
                pet.hunger = Math.min(100, pet.hunger + (minutesPassed * 0.5));
                pet.energy = Math.max(0, pet.energy - (minutesPassed * 0.3));
                
                // Health decreases if hunger is high or energy is low
                if (pet.hunger > 70 || pet.energy < 30) {
                    pet.health = Math.max(0, pet.health - (minutesPassed * 0.2));
                }
                
                // Happiness decreases over time
                pet.happiness = Math.max(0, pet.happiness - (minutesPassed * 0.1));
                
                // Age increases
                pet.age += minutesPassed / (60 * 24); // Convert minutes to days
                
                // Check for death
                if (pet.health <= 0) {
                    pet.alive = false;
                    addLogEntry(`${pet.name} the ${pet.type} has perished due to neglect.`, true);
                }
            });
            
            // Remove dead pets
            gameState.pets = gameState.pets.filter(pet => pet.alive);
            
            if (gameState.pets.length === 0) {
                gameState.gameStarted = false;
            }
            
            saveGame();
        }
        
        // Update continue button visibility
        function updateContinueButton() {
            continueGameBtn.style.display = gameState.gameStarted ? 'block' : 'none';
        }
        
        // Start a new game
        function startNewGame() {
            // Create a new pet
            const newPet = createNewPet();
            gameState.pets = [newPet];
            gameState.currentPetIndex = 0;
            gameState.gameStarted = true;
            
            saveGame();
            showGameScreen();
            addLogEntry(`A new ${newPet.type} egg has appeared!`, true);
            updatePetDisplay();
        }
        
        // Continue existing game
        function continueGame() {
            if (gameState.pets.length > 0) {
                showGameScreen();
                updatePetDisplay();
            } else {
                gameState.gameStarted = false;
                updateContinueButton();
                alert('No active pets found. Starting a new game.');
                startNewGame();
            }
        }
        
        // Create a new pet
        function createNewPet() {
            const type = TYPES[Math.floor(Math.random() * TYPES.length)];
            const name = NAMES[Math.floor(Math.random() * NAMES.length)];
            
            return {
                name: name,
                type: type,
                stage: STAGES.EGG,
                health: 100,
                maxHealth: 100,
                hunger: 0,
                energy: 100,
                maxEnergy: 100,
                happiness: 100,
                maxHappiness: 100,
                experience: 0,
                expToNextLevel: 100,
                level: 1,
                age: 0, // in days
                alive: true,
                traits: {
                    strength: Math.floor(Math.random() * 5) + 1,
                    intelligence: Math.floor(Math.random() * 5) + 1,
                    speed: Math.floor(Math.random() * 5) + 1
                },
                lastEvolutionCheck: 0,
                canDivide: false
            };
        }
        
        // Show main menu
        function showMainMenu() {
            mainMenu.style.display = 'block';
            gameScreen.style.display = 'none';
            colonyScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
        }
        
        // Show game screen
        function showGameScreen() {
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'block';
            colonyScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            
            document.getElementById('game-title').textContent = 
                gameState.pets.length > 1 ? 'Your Creature Colony' : 'Your Creature';
        }
        
        // Show colony screen
        function showColony() {
            if (!gameState.gameStarted || gameState.pets.length === 0) {
                alert('You need to start a game first!');
                return;
            }
            
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'none';
            colonyScreen.style.display = 'block';
            instructionsScreen.style.display = 'none';
            
            renderPetsColony();
        }
        
        // Show instructions screen
        function showInstructions() {
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'none';
            colonyScreen.style.display = 'none';
            instructionsScreen.style.display = 'block';
        }
        
        // Render pets in colony view
        function renderPetsColony() {
            petsContainer.innerHTML = '';
            
            gameState.pets.forEach((pet, index) => {
                const petCard = document.createElement('div');
                petCard.className = `pet-card ${index === gameState.currentPetIndex ? 'selected' : ''}`;
                petCard.innerHTML = `
                    <div class="pet-card-name">${pet.name}</div>
                    <div class="pet-card-stage">${pet.type} ${pet.stage} (Lvl ${pet.level})</div>
                    <div class="progress-container" style="margin-top: 5px;">
                        <div class="progress-bar" style="width: ${(pet.health / pet.maxHealth) * 100}%"></div>
                    </div>
                `;
                
                petCard.addEventListener('click', () => {
                    gameState.currentPetIndex = index;
                    saveGame();
                    showGameScreen();
                    updatePetDisplay();
                });
                
                petsContainer.appendChild(petCard);
            });
        }
        
        // Update pet display with current stats
        function updatePetDisplay() {
            if (gameState.pets.length === 0) {
                showMainMenu();
                return;
            }
            
            const pet = gameState.pets[gameState.currentPetIndex];
            
            petNameEl.textContent = pet.name;
            petStageEl.textContent = `${pet.type} ${pet.stage}`;
            
            // Update health
            healthBar.style.width = `${(pet.health / pet.maxHealth) * 100}%`;
            healthValue.textContent = `${Math.round(pet.health)}/${pet.maxHealth}`;
            
            // Update hunger
            hungerBar.style.width = `${pet.hunger}%`;
            hungerValue.textContent = `${Math.round(pet.hunger)}/100`;
            
            // Update energy
            energyBar.style.width = `${(pet.energy / pet.maxEnergy) * 100}%`;
            energyValue.textContent = `${Math.round(pet.energy)}/${pet.maxEnergy}`;
            
            // Update happiness
            happinessBar.style.width = `${(pet.happiness / pet.maxHappiness) * 100}%`;
            happinessValue.textContent = `${Math.round(pet.happiness)}/${pet.maxHappiness}`;
            
            // Update experience
            expBar.style.width = `${(pet.experience / pet.expToNextLevel) * 100}%`;
            expValue.textContent = `${Math.round(pet.experience)}/${pet.expToNextLevel}`;
            
            // Update age
            ageValue.textContent = `${pet.age.toFixed(1)} days`;
            
            // Update button states
            updateButtonStates();
            
            // Check for evolution
            checkEvolution(pet);
        }
        
        // Update action button states based on pet stats
        function updateButtonStates() {
            const pet = gameState.pets[gameState.currentPetIndex];
            
            // Feed button - always available but more effective when hungry
            feedBtn.disabled = false;
            
            // Play button - requires energy
            playBtn.disabled = pet.energy < 10;
            
            // Train button - requires energy and not too hungry
            trainBtn.disabled = pet.energy < 20 || pet.hunger > 70;
            
            // Rest button - always available but more effective when low energy
            restBtn.disabled = false;
            
            // Heal button - only when health is not full
            healBtn.disabled = pet.health >= pet.maxHealth;
        }
        
        // Perform an action on the current pet
        function performAction(action) {
            const pet = gameState.pets[gameState.currentPetIndex];
            let message = '';
            
            switch (action) {
                case 'feed':
                    // Reduce hunger, small increase in happiness
                    const hungerReduction = 20 + Math.random() * 10;
                    pet.hunger = Math.max(0, pet.hunger - hungerReduction);
                    pet.happiness = Math.min(pet.maxHappiness, pet.happiness + 5);
                    message = `You fed ${pet.name}. Hunger decreased.`;
                    break;
                    
                case 'play':
                    // Increase happiness, decrease energy
                    const happinessIncrease = 15 + Math.random() * 10;
                    pet.happiness = Math.min(pet.maxHappiness, pet.happiness + happinessIncrease);
                    pet.energy = Math.max(0, pet.energy - 10);
                    message = `You played with ${pet.name}. Happiness increased.`;
                    break;
                    
                case 'train':
                    // Increase experience, decrease energy and increase hunger
                    const expGain = 10 + Math.random() * 5 + pet.traits.strength;
                    pet.experience += expGain;
                    pet.energy = Math.max(0, pet.energy - 20);
                    pet.hunger = Math.min(100, pet.hunger + 10);
                    message = `${pet.name} trained hard. Gained ${Math.round(expGain)} experience.`;
                    
                    // Check for level up
                    if (pet.experience >= pet.expToNextLevel) {
                        levelUpPet(pet);
                    }
                    break;
                    
                case 'rest':
                    // Increase energy, small decrease in hunger
                    const energyGain = 30 + Math.random() * 20;
                    pet.energy = Math.min(pet.maxEnergy, pet.energy + energyGain);
                    pet.hunger = Math.min(100, pet.hunger + 5);
                    message = `${pet.name} rested. Energy increased.`;
                    break;
                    
                case 'heal':
                    // Increase health, decrease energy
                    const healthGain = 25 + Math.random() * 15;
                    pet.health = Math.min(pet.maxHealth, pet.health + healthGain);
                    pet.energy = Math.max(0, pet.energy - 15);
                    message = `You healed ${pet.name}. Health increased.`;
                    break;
            }
            
            // Random events
            checkRandomEvents(pet, action);
            
            // Passive changes over time
            passiveChanges(pet);
            
            // Update display and save
            updatePetDisplay();
            saveGame();
            
            // Add log entry
            if (message) {
                addLogEntry(message);
            }
        }
        
        // Apply passive changes to pet over time
        function passiveChanges(pet) {
            // Small increase in hunger
            pet.hunger = Math.min(100, pet.hunger + 1);
            
            // Small decrease in happiness
            pet.happiness = Math.max(0, pet.happiness - 0.5);
            
            // Age increases slightly with each action
            pet.age += 0.01;
            
            // Health decreases if hunger is too high or energy too low
            if (pet.hunger > 80 || pet.energy < 20) {
                pet.health = Math.max(0, pet.health - 1);
            }
            
            // Check for death
            if (pet.health <= 0) {
                pet.alive = false;
                addLogEntry(`${pet.name} the ${pet.type} has died!`, true);
                
                // Remove dead pet
                gameState.pets = gameState.pets.filter(p => p.alive);
                
                if (gameState.pets.length === 0) {
                    gameState.gameStarted = false;
                    showMainMenu();
                } else {
                    // Select another pet if available
                    gameState.currentPetIndex = Math.min(gameState.currentPetIndex, gameState.pets.length - 1);
                    updatePetDisplay();
                }
            }
        }
        
        // Check for random events
        function checkRandomEvents(pet, action) {
            const random = Math.random();
            
            // 5% chance of a random event
            if (random < 0.05) {
                const events = [
                    () => {
                        const statGain = Math.floor(Math.random() * 3) + 1;
                        const stat = ['strength', 'intelligence', 'speed'][Math.floor(Math.random() * 3)];
                        pet.traits[stat] += statGain;
                        addLogEntry(`${pet.name}'s ${stat} increased by ${statGain}!`, true);
                    },
                    () => {
                        const healthGain = Math.floor(Math.random() * 20) + 10;
                        pet.health = Math.min(pet.maxHealth, pet.health + healthGain);
                        addLogEntry(`${pet.name} found a magical herb and recovered ${healthGain} health!`, true);
                    },
                    () => {
                        const expGain = Math.floor(Math.random() * 30) + 20;
                        pet.experience += expGain;
                        addLogEntry(`${pet.name} had a training breakthrough and gained ${expGain} experience!`, true);
                        
                        if (pet.experience >= pet.expToNextLevel) {
                            levelUpPet(pet);
                        }
                    },
                    () => {
                        pet.happiness = Math.min(pet.maxHappiness, pet.happiness + 20);
                        addLogEntry(`${pet.name} is in an exceptionally good mood today!`, true);
                    }
                ];
                
                // Pick a random event
                events[Math.floor(Math.random() * events.length)]();
            }
            
            // 2% chance of negative event
            if (random > 0.98) {
                const negativeEvents = [
                    () => {
                        const healthLoss = Math.floor(Math.random() * 15) + 5;
                        pet.health = Math.max(0, pet.health - healthLoss);
                        addLogEntry(`${pet.name} got sick and lost ${healthLoss} health!`, true);
                    },
                    () => {
                        pet.happiness = Math.max(0, pet.happiness - 15);
                        addLogEntry(`${pet.name} is feeling depressed today.`, true);
                    },
                    () => {
                        const statLoss = Math.floor(Math.random() * 2) + 1;
                        const stat = ['strength', 'intelligence', 'speed'][Math.floor(Math.random() * 3)];
                        pet.traits[stat] = Math.max(1, pet.traits[stat] - statLoss);
                        addLogEntry(`${pet.name} forgot some skills. ${stat} decreased by ${statLoss}.`, true);
                    }
                ];
                
                negativeEvents[Math.floor(Math.random() * negativeEvents.length)]();
            }
        }
        
        // Level up the pet
        function levelUpPet(pet) {
            pet.level++;
            pet.experience -= pet.expToNextLevel;
            pet.expToNextLevel = Math.floor(pet.expToNextLevel * 1.5);
            
            // Increase stats
            pet.maxHealth += 10;
            pet.health = pet.maxHealth;
            pet.maxEnergy += 5;
            pet.energy = pet.maxEnergy;
            pet.maxHappiness += 5;
            pet.happiness = pet.maxHappiness;
            
            // Random trait increase
            const trait = ['strength', 'intelligence', 'speed'][Math.floor(Math.random() * 3)];
            pet.traits[trait] += 1;
            
            addLogEntry(`${pet.name} leveled up to level ${pet.level}! ${trait} increased.`, true);
            
            // Check for evolution
            checkEvolution(pet);
        }
        
        // Check if pet can evolve
        function checkEvolution(pet) {
            // Don't check too often
            if (Date.now() - pet.lastEvolutionCheck < 10000) return;
            pet.lastEvolutionCheck = Date.now();
            
            // Evolution stages
            if (pet.stage === STAGES.EGG && pet.level >= 3) {
                pet.stage = STAGES.HATCHLING;
                addLogEntry(`Your ${pet.type} egg has hatched! ${pet.name} is now a Hatchling.`, true);
            } else if (pet.stage === STAGES.HATCHLING && pet.level >= 6) {
                pet.stage = STAGES.JUVENILE;
                addLogEntry(`${pet.name} has grown into a Juvenile ${pet.type}!`, true);
            } else if (pet.stage === STAGES.JUVENILE && pet.level >= 10) {
                pet.stage = STAGES.ADULT;
                pet.canDivide = true;
                addLogEntry(`Amazing! ${pet.name} has reached adulthood as a mighty ${pet.type}!`, true);
                addLogEntry(`${pet.name} can now divide and create offspring!`, true);
            }
            
            // Check for division (reproduction)
            if (pet.stage === STAGES.ADULT && pet.canDivide && 
                pet.health > 70 && pet.energy > 50 && pet.happiness > 60) {
                attemptDivision(pet);
            }
        }
        
        // Attempt to divide the pet (reproduce)
        function attemptDivision(pet) {
            // 30% chance to divide when conditions are met
            if (Math.random() < 0.3) {
                dividePet(pet);
            }
        }
        
        // Divide the pet to create offspring
        function dividePet(pet) {
            // Create a new pet with similar but slightly different traits
            const offspring = createNewPet();
            
            // Inherit traits with small variations
            offspring.type = pet.type; // Same type
            offspring.name = NAMES[Math.floor(Math.random() * NAMES.length)]; // New name
            offspring.stage = STAGES.EGG;
            offspring.level = 1;
            
            // Traits are inherited with small random changes
            offspring.traits = {
                strength: Math.max(1, pet.traits.strength + Math.floor(Math.random() * 3) - 1),
                intelligence: Math.max(1, pet.traits.intelligence + Math.floor(Math.random() * 3) - 1),
                speed: Math.max(1, pet.traits.speed + Math.floor(Math.random() * 3) - 1)
            };
            
            // Parent needs to recover
            pet.energy = Math.max(0, pet.energy - 40);
            pet.hunger = Math.min(100, pet.hunger + 30);
            pet.canDivide = false;
            
            // Add offspring to pets array
            gameState.pets.push(offspring);
            
            // Update display
            document.getElementById('game-title').textContent = 'Your Creature Colony';
            
            addLogEntry(`Incredible! ${pet.name} has divided and created a new ${offspring.type} egg named ${offspring.name}!`, true);
            
            // Save and update
            saveGame();
            updatePetDisplay();
        }
        
        // Add entry to game log
        function addLogEntry(message, isImportant = false) {
            const now = new Date();
            const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}]`;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (isImportant) entry.style.fontWeight = 'bold';
            
            entry.innerHTML = `<span class="log-time">${timeString}</span> ${message}`;
            gameLog.appendChild(entry);
            
            // Auto-scroll to bottom
            gameLog.scrollTop = gameLog.scrollHeight;
            
            // Keep log from getting too long
            if (gameLog.children.length > 50) {
                gameLog.removeChild(gameLog.children[0]);
            }
        }
        
        // Initialize the game when loaded
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>